<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vaper Tracker Pro</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f5f5f7; }
#map { height: 100%; width: 100%; display: none; }

#overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:5000; font-size:18px; text-align:center; padding:20px; gap:20px; }
#overlay button { padding:12px 24px; border:none; background:#007aff; color:white; border-radius:12px; cursor:pointer; font-weight:600; }

#menuButton { position:fixed; top:15px; left:15px; z-index:2000; background:rgba(255,255,255,0.9); border:none; padding:12px; border-radius:14px; box-shadow:0 4px 15px rgba(0,0,0,0.1); cursor:pointer; backdrop-filter:blur(5px); }
#panel { position:fixed; top:0; left:-280px; width:260px; height:100%; background:white; z-index:2100; padding:25px; box-shadow:4px 0 20px rgba(0,0,0,0.1); transition:.3s cubic-bezier(0.4,0,0.2,1); overflow:auto; }
#panel.active { left:0; }

.search-bar { position:absolute; top:15px; left:50%; transform:translateX(-50%); z-index:1500; display:flex; background:rgba(255,255,255,0.95); border-radius:18px; box-shadow:0 8px 24px rgba(0,0,0,0.12); overflow:hidden; width:85%; max-width:420px; backdrop-filter:blur(10px); border:1px solid rgba(0,0,0,0.05); }
.search-bar input { flex:1; padding:14px; border:none; outline:none; font-size:16px; background:transparent; }
.search-bar button { padding:14px 20px; border:none; background:#007aff; color:white; cursor:pointer; }

.btn-pin { position:absolute; bottom:100px; right:20px; width:55px; height:55px; background:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:28px; color:#c00; border:none; cursor:pointer; z-index:1500; box-shadow:0 6px 16px rgba(0,0,0,0.15); }
.btn-search-area { position:absolute; bottom:30px; right:20px; background:#007aff; color:white; border:none; padding:14px 22px; border-radius:25px; cursor:pointer; z-index:1500; font-weight:700; box-shadow:0 6px 20px rgba(0,122,255,0.3); }

/* Popups */
.popup-container { text-align:center; min-width:240px; padding:8px; }
.btn-maps { display:block; background:#007aff; color:white !important; text-align:center; padding:12px; border-radius:12px; text-decoration:none !important; margin-top:12px; font-weight:600; font-size:14px; }
.horario-info { font-size:12px; color:#636366; display:block; margin-top:8px; line-height:1.4; border-top:1px solid #f2f2f7; padding-top:8px; }
.vape-info { font-size:13px; font-weight:600; margin-top:6px; color:#34c759; }
.extra-info { font-size:12px; color:#007aff; margin-top:6px; line-height:1.3; }
</style>
</head>

<body>

<div id="overlay">
  <div id="overlayText">Localizando puntos de venta...</div>
  <button id="retryBtn" style="display:none;">Reintentar acceso</button>
</div>

<button id="menuButton">‚ò∞</button>

<div id="panel">
  <h3 style="font-weight:700">Ajustes</h3>
  <label style="cursor:pointer"><input type="checkbox" id="onlyOpen"> Solo abiertos ahora</label><br><br>
  <label style="cursor:pointer"><input type="checkbox" id="greyClosed" checked> Atenuar cerrados / desconocidos</label>
</div>

<div class="search-bar">
  <input type="text" id="address" placeholder="Ciudad, calle o c√≥digo postal">
  <button id="searchBtn">üîç</button>
</div>

<button class="btn-pin" id="pinBtn">üìå</button>
<button class="btn-search-area" id="searchAreaBtn">BUSCAR EN ESTA √ÅREA</button>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/opening_hours@3.5.0/opening_hours+deps.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

const overlay = document.getElementById("overlay");
const overlayText = document.getElementById("overlayText");
const retryBtn = document.getElementById("retryBtn");
const onlyOpen = document.getElementById("onlyOpen");
const greyClosed = document.getElementById("greyClosed");

let map, userLocation, markersLayer, userMarker, elementsData = [];
let lastCenter = null;
let lastZoom = null;
let lastSearchTime = 0;
let cachedData = null;
let cachedCenter = null;
let cachedRadius = 0;

// Cargar estado
onlyOpen.checked = localStorage.getItem('onlyOpen') === 'true';
greyClosed.checked = localStorage.getItem('greyClosed') !== 'false';

/* ---------- NOMBRE POR DEFECTO ---------- */
function getDefaultName(tags) {
    if (tags.shop === "tobacco") return "Estanco";
    if (tags.shop === "supermarket") return "Supermercado";
    if (tags.amenity === "fuel") return "Gasolinera";
    if (tags.shop === "convenience") return "Tienda de conveniencia";
    if (tags.shop === "vape" || tags.shop === "e-cigarette") return "Tienda de vapers";
    if (tags.amenity === "bar") return "Bar";
    if (tags.amenity === "pub") return "Pub";
    if (tags.amenity === "restaurant") return "Restaurante";
    if (tags.amenity === "cafe") return "Cafeter√≠a";
    return "Local";
}

/* ---------- TRADUCTOR DE HORARIOS ---------- */
function traducirHorario(txt) {
    if (!txt) return "Horario desconocido";
    return txt
        .replace(/Mo/g, "Lun").replace(/Tu/g, "Mar").replace(/We/g, "Mi√©")
        .replace(/Th/g, "Jue").replace(/Fr/g, "Vie").replace(/Sa/g, "S√°b")
        .replace(/Su/g, "Dom").replace(/24\/7/g, "Abierto 24h")
        .replace(/off/g, "Cerrado").replace(/;/g, "<br>");
}

/* ---------- ESTADO DE HORARIO ---------- */
function getOpeningStatus(opening_hours_str) {
    if (!opening_hours_str || opening_hours_str.trim() === '') {
        return { isOpen: true, known: false };
    }
    try {
        const oh = new opening_hours(opening_hours_str);
        return { isOpen: oh.isOpen(new Date()), known: true };
    } catch (e) {
        return { isOpen: true, known: false };
    }
}

/* ---------- ¬øVende vapers? ---------- */
function vendeVapers(tags) {
    if (!tags) return false;
    const shop = tags.shop;
    const amenity = tags.amenity;
    return shop === 'vape' || shop === 'e-cigarette' ||
           shop === 'tobacco' ||
           shop === 'supermarket' ||
           shop === 'convenience' ||
           amenity === 'fuel';
}

function iniciarGeolocalizacion() {
    navigator.geolocation.getCurrentPosition(
        pos => { iniciarMapa(pos.coords.latitude, pos.coords.longitude); },
        err => {
            overlayText.innerHTML = "Error: GPS desactivado o denegado.";
            retryBtn.style.display = "block";
        },
        { enableHighAccuracy: true, timeout: 12000 }
    );
}

retryBtn.onclick = () => iniciarGeolocalizacion();

function iniciarMapa(lat, lon) {
    userLocation = { lat, lon };
    overlay.style.display = "none";
    document.getElementById("map").style.display = "block";

    map = L.map('map', { zoomControl: false }).setView([lat, lon], 16);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    markersLayer = L.markerClusterGroup({
        maxClusterRadius: 70,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
    }).addTo(map);

    userMarker = L.circleMarker([lat, lon], {
        radius: 9, color: "white", fillColor: "#007aff", fillOpacity: 0.9, weight: 3
    }).addTo(map);

    let searchTimeout;
    map.on('moveend zoomend', () => {
        const now = Date.now();
        if (now - lastSearchTime < 8000) return;

        const currentCenter = map.getCenter();
        const currentZoom = map.getZoom();

        if (cachedData && cachedCenter && currentCenter.distanceTo(cachedCenter) < cachedRadius * 0.7) {
            elementsData = cachedData;
            render();
            return;
        }

        const movedFar = !lastCenter || currentCenter.distanceTo(lastCenter) > 500 || Math.abs(currentZoom - lastZoom) >= 1;

        if (movedFar) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                lastCenter = currentCenter;
                lastZoom = currentZoom;
                lastSearchTime = now;
                buscarDatos(true);
            }, 3000);
        }
    });

    buscarDatos(false);
}

function getVisibleRadius() {
    const bounds = map.getBounds();
    return map.getCenter().distanceTo(bounds.getNorthEast()) * 1.2;
}

async function buscarDatos(showOverlay = false) {
    if (!map) return;

    const c = map.getCenter();
    const radio = getVisibleRadius();

    if (showOverlay) {
        overlay.style.display = 'flex';
        overlayText.textContent = 'Buscando locales cercanos...';
    }

    try {
        const resp = await fetch("https://overpass-api.de/api/interpreter", {
            method: "POST",
            body: "data=" + encodeURIComponent(`[out:json][timeout:25];
            (
              node["shop"="tobacco"](around:${radio},${c.lat},${c.lng});
              node["shop"="convenience"](around:${radio},${c.lat},${c.lng});
              node["shop"="vape"](around:${radio},${c.lat},${c.lng});
              node["shop"="e-cigarette"](around:${radio},${c.lat},${c.lng});
              node["amenity"="fuel"](around:${radio},${c.lat},${c.lng});
              node["shop"="supermarket"](around:${radio},${c.lat},${c.lng});
              node["amenity"="bar"](around:${radio},${c.lat},${c.lng});
              node["amenity"="pub"](around:${radio},${c.lat},${c.lng});
            );
            out;`)
        });

        if (!resp.ok) throw new Error("Overpass error");

        const data = await resp.json();
        elementsData = data.elements || [];

        cachedData = elementsData;
        cachedCenter = c;
        cachedRadius = radio;

        render();
    } catch (e) {
        console.error("Error al buscar:", e);
        if (showOverlay) {
            overlayText.textContent = 'Error al cargar datos';
            setTimeout(() => overlay.style.display = 'none', 2000);
        }
    } finally {
        if (showOverlay) setTimeout(() => overlay.style.display = 'none', 800);
    }
}

function render() {
    markersLayer.clearLayers();

    const showOnlyOpen = onlyOpen.checked;
    const greyOut = greyClosed.checked;

    elementsData.forEach(p => {
        const horarioRaw = p.tags?.opening_hours || "";
        const status = getOpeningStatus(horarioRaw);

        if (showOnlyOpen && status.known && !status.isOpen) return;

        let color = "#8e8e93";
        let defaultName = getDefaultName(p.tags);
        let extraInfo = "";

        if (p.tags?.shop === "tobacco") color = "#ff3b30";
        else if (p.tags?.shop === "supermarket") color = "#34c759";
        else if (p.tags?.amenity === "fuel") color = "#9f47ff";
        else if (p.tags?.shop === "vape" || p.tags?.shop === "e-cigarette") color = "#5856d6";
        else if (p.tags?.shop === "convenience") color = "#ff9500";
        else if (p.tags?.amenity === "bar" || p.tags?.amenity === "pub") {
            color = "#FF6B6B"; // rojo suave para bares/pubs
            extraInfo = '<div class="extra-info">‚ÑπÔ∏è Puede tener m√°quina de tabaco y/o vapers (muy com√∫n en bares con retransmisiones de f√∫tbol o juegos recreativos) ‚Äì verifica en el local o Google Maps</div>';
        }

        const opacity = (greyOut && !(status.known && status.isOpen)) ? 0.65 : 1.0;

        let nombre = p.tags?.name || defaultName;

        let queryParts = [nombre];
        if (p.tags["addr:street"]) queryParts.push(p.tags["addr:street"]);
        if (p.tags["addr:housenumber"]) queryParts.push(p.tags["addr:housenumber"]);
        if (p.tags["addr:city"]) queryParts.push(p.tags["addr:city"]);
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(queryParts.join(" "))}`;

        const horarioEsp = traducirHorario(horarioRaw);
        const vende = vendeVapers(p.tags);
        const vapeText = vende ? '<div class="vape-info">‚úì Probablemente vende vapers</div>' : '';

        if (p.tags?.shop === "supermarket" && !status.known) {
            let note = 'Horario habitual aprox. 9:00-21:30 (verifica en Google Maps)';
            const nameLower = nombre.toLowerCase();
            if (nameLower.includes('d√≠a') || nameLower.includes('dia')) note = 'D√≠a: la mayor√≠a abre 9:00-21:30 (verifica en Google Maps)';
            if (nameLower.includes('maskom')) note = 'Maskom: horarios variables (verifica en Google Maps)';
            extraInfo = `<div class="extra-info">‚ÑπÔ∏è ${note}</div>`;
        } else if (!status.known && !extraInfo) {
            extraInfo = '<div class="extra-info">‚ÑπÔ∏è Horario no disponible ‚Äì verifica en Google Maps</div>';
        }

        const pinIcon = L.divIcon({
            className: "custom-pin",
            html: `<svg width="32" height="44" viewBox="0 0 32 44" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M16 0C7.164 0 0 7.164 0 16c0 11.046 16 28 16 28s16-16.954 16-28c0-8.836-7.164-16-16-16z" fill="${color}" opacity="${opacity}"/>
                <circle cx="16" cy="16" r="7" fill="white" opacity="0.95"/>
            </svg>`,
            iconSize: [32, 44],
            iconAnchor: [16, 44],
            popupAnchor: [0, -40],
            className: ''
        });

        L.marker([p.lat, p.lon], { icon: pinIcon })
            .bindPopup(`
                <div class="popup-container">
                    <strong style="font-size:16px;">${nombre}</strong><br>
                    <span class="horario-info"><b>Horario:</b><br>${horarioEsp}</span>
                    ${vapeText}
                    ${extraInfo}
                    <a href="${mapsUrl}" target="_blank" class="btn-maps">VER EN MAPS</a>
                </div>
            `)
            .addTo(markersLayer);
    });
}

// Eventos
document.getElementById("menuButton").onclick = () => document.getElementById("panel").classList.toggle("active");
document.getElementById("pinBtn").onclick = () => map.flyTo([userLocation.lat, userLocation.lon], 17);
document.getElementById("searchAreaBtn").onclick = () => buscarDatos(false);
document.getElementById("searchBtn").onclick = async () => {
    const val = document.getElementById("address").value.trim();
    if (!val) return;
    try {
        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}&limit=1`);
        const d = await r.json();
        if (d.length > 0) {
            map.setView([d[0].lat, d[0].lon], 16);
            buscarDatos(false);
        }
    } catch (e) { console.error(e); }
};

onlyOpen.addEventListener('change', () => { localStorage.setItem('onlyOpen', onlyOpen.checked); render(); });
greyClosed.addEventListener('change', () => { localStorage.setItem('greyClosed', greyClosed.checked); render(); });

iniciarGeolocalizacion();

});
</script>
</body>
</html>
