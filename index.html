```html
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaper Tracker - Ubicaci√≥n Real</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* Buscador Superior */
        .search-bar {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            z-index: 1000; width: 90%; max-width: 450px; display: flex;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); border-radius: 30px; overflow: hidden;
        }
        .search-bar input { flex: 1; padding: 15px 20px; border: none; outline: none; font-size: 16px; }
        .search-bar button { padding: 15px 20px; border: none; background: #2563eb; color: white; cursor: pointer; font-size: 18px; }

        /* Bot√≥n de Mi Ubicaci√≥n (Prioritario) */
        .btn-locate, .btn-refresh {
            position: absolute; z-index: 1000;
            width: 55px; height: 55px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); border: 2px solid #2563eb; cursor: pointer;
        }

        .btn-locate {
            bottom: 100px; right: 20px;
        }

        /* Bot√≥n Refrescar */
        .btn-refresh {
            bottom: 170px; /* Ajustado para que no se superponga con el bot√≥n de ubicaci√≥n */
            right: 20px;
        }

        /* Bot√≥n A√±adir Punto (Secundario - Izquierda) */
        .btn-add-manual {
            position: absolute; bottom: 30px; left: 20px; z-index: 1000;
            background: rgba(255, 255, 255, 0.9); border: 1px solid #ccc; padding: 8px 15px;
            border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; color: #444;
        }

        /* Popups y Etiquetas */
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 5px; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 6px; color: white; font-weight: bold; font-size: 11px; margin-bottom: 5px; }
        .btn-g { display: block; background: #4285F4; color: white; text-align: center; padding: 12px;
                 text-decoration: none; border-radius: 8px; margin-top: 10px; font-weight: bold; font-size: 14px; }

        /* Punto de mira central discreto */
        .center-cross {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 900; pointer-events: none; color: #2563eb; opacity: 0.5; font-size: 20px;
        }
    </style>
</head>
<body>

    <div class="search-bar">
        <input type="text" id="address" placeholder="Buscar zona o ciudad...">
        <button id="searchButton">üîç</button>
    </div>

    <div class="center-cross">+</div>

    <div class="btn-locate" id="locateButton">üéØ</div>

    <div class="btn-refresh" id="refreshButton">üîÑ</div>

    <button class="btn-add-manual" id="addButton">‚ûï GUARDAR COORDENADA</button>

    <div id="map"></div>

    <script>
        // Inicializaci√≥n del mapa
        const map = L.map('map', { zoomControl: false, maxZoom: 19 }).setView([40.41, -3.70], 6);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            attribution: '¬©OpenStreetMap'
        }).addTo(map);

        // Iconos
        const iconEstanco = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [30, 50], iconAnchor: [15, 50], popupAnchor: [1, -34], shadowSize: [50, 50] });
        const iconTienda = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [30, 50], iconAnchor: [15, 50], popupAnchor: [1, -34], shadowSize: [50, 50] });

        // Marcador de posici√≥n del usuario
        const userMarker = L.circleMarker([0,0], { radius: 10, color: 'white', fillColor: '#2563eb', fillOpacity: 1, weight: 3 }).addTo(map);

        let currentLocation = null; // Variable para almacenar la ubicaci√≥n actual

        // Geolocalizaci√≥n autom√°tica al iniciar
        map.locate({setView: true, zoom: 16, watch: true, maxZoom: 19 });

        map.on('locationfound', function(e) {
            currentLocation = e.latlng; // Guarda la ubicaci√≥n actual
            userMarker.setLatLng(e.latlng);
            buscarDatos(e.latlng.lat, e.latlng.lng);
        });

        map.on('locationerror', function(e) {
            console.warn("Error getting location:", e.message);
            alert("No se pudo obtener tu ubicaci√≥n. Aseg√∫rate de que los servicios de ubicaci√≥n est√©n activados.");
        });

        async function buscarDatos(lat, lng) {
            // Filtro exclusivo: Estancos y tiendas que suelen vender vapers
            const query = `[out:json];(node["shop"="tobacco"](around:2000,${lat},${lng});node["shop"~"variety_store|convenience|supermarket"](around:2000,${lat},${lng}););out;`;

            try {
                const response = await fetch("https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query));
                const data = await response.json();

                // Limpiar marcadores existentes antes de agregar nuevos
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });
                map.addLayer(userMarker); //Re-add the user marker

                data.elements.forEach(p => {
                    const esEstanco = p.tags.shop === "tobacco";
                    const tipo = esEstanco ? 'ESTANCO' : 'TIENDA / SUPER';
                    const nombre = p.tags.name || tipo;
                    const color = esEstanco ? '#e11d48' : '#eab308';

                    // Link directo a navegaci√≥n de Google Maps
                    const gLink = `https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}`;

                    L.marker([p.lat, p.lon], {icon: esEstanco ? iconEstanco : iconTienda}).addTo(map)
                    .bindPopup(`
                        <div style="text-align:center;">
                            <span class="badge" style="background:${color}">${tipo}</span>
                            <h3 style="margin:5px 0; font-size:16px;">${nombre}</h3>
                            <p style="font-size:12px; color:666; margin:5px 0;">Punto de venta verificado</p>
                            <a href="${gLink}" target="_blank" class="btn-g">C√ìMO LLEGAR</a>
                        </div>
                    `);
                });
            } catch (error) {
                console.error("Error fetching data:", error);
                alert("Error al obtener datos. Por favor, int√©ntalo de nuevo.");
            }
        }

        function capturarCentro() {
            const c = map.getCenter();
            alert("Coordenada guardada secundariamente:\n" + c.lat.toFixed(6) + ", " + c.lng.toFixed(6));
        }

        async function buscarManual() {
            const val = document.getElementById('address').value;
            try {
                const response = await fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + val);
                const data = await response.json();

                if(data.length > 0) {
                    const lat = data[0].lat;
                    const lon = data[0].lon;
                     // Centrar el mapa y establecer el zoom
                    map.setView([lat, lon], 17);
                    buscarDatos(lat, lon);
                } else {
                    alert("No se encontraron resultados para la b√∫squeda.");
                }
            } catch (error) {
                console.error("Error fetching geocoding data:", error);
                alert("Error al buscar la ubicaci√≥n. Por favor, int√©ntalo de nuevo.");
            }
        }

        function refreshLocationAndData() {
            if (currentLocation) {
                buscarDatos(currentLocation.lat, currentLocation.lng);
            } else {
                map.locate({setView: true, zoom: 17, maxZoom: 19}); // Intenta obtener la ubicaci√≥n nuevamente
            }
        }

        // Event Listeners
        document.getElementById('searchButton').addEventListener('click', buscarManual);
        document.getElementById('locateButton').addEventListener('click', () => map.locate({setView: true, zoom: 17, maxZoom: 19}));
        document.getElementById('addButton').addEventListener('click', capturarCentro);
        document.getElementById('refreshButton').addEventListener('click', refreshLocationAndData);
    </script>
</body>
</html>
```
