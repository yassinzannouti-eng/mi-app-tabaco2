<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estancos & Quioscos Tracker</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f5f5f7; }
#map { height: 100%; width: 100%; display: none; }

#overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:5000; font-size:18px; text-align:center; padding:20px; gap:20px; }
#overlay button { padding:12px 24px; border:none; background:#007aff; color:white; border-radius:12px; cursor:pointer; font-weight:600; }

#menuButton { position:fixed; top:15px; left:15px; z-index:2000; background:rgba(255,255,255,0.9); border:none; padding:12px; border-radius:14px; box-shadow:0 4px 15px rgba(0,0,0,0.1); cursor:pointer; backdrop-filter:blur(5px); }
#panel { position:fixed; top:0; left:-320px; width:300px; height:100%; background:white; z-index:2100; padding:25px; box-shadow:4px 0 20px rgba(0,0,0,0.1); transition:.3s cubic-bezier(0.4,0,0.2,1); overflow:auto; }
#panel.active { left:0; }

.search-bar { position:absolute; top:15px; left:50%; transform:translateX(-50%); z-index:1500; display:flex; background:rgba(255,255,255,0.95); border-radius:18px; box-shadow:0 8px 24px rgba(0,0,0,0.12); overflow:hidden; width:85%; max-width:420px; backdrop-filter:blur(10px); border:1px solid rgba(0,0,0,0.05); }
.search-bar input { flex:1; padding:14px; border:none; outline:none; font-size:16px; background:transparent; }
.search-bar button { padding:14px 20px; border:none; background:#007aff; color:white; cursor:pointer; }

.btn-pin { position:absolute; bottom:100px; right:20px; width:55px; height:55px; background:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:28px; color:#c00; border:none; cursor:pointer; z-index:1500; box-shadow:0 6px 16px rgba(0,0,0,0.15); }
.btn-search-area { position:absolute; bottom:30px; right:20px; background:#007aff; color:white; border:none; padding:14px 22px; border-radius:25px; cursor:pointer; z-index:1500; font-weight:700; box-shadow:0 6px 20px rgba(0,122,255,0.3); }

.popup-container { text-align:center; min-width:240px; padding:8px; }
.btn-maps { display:block; background:#007aff; color:white !important; text-align:center; padding:12px; border-radius:12px; text-decoration:none !important; margin-top:12px; font-weight:600; font-size:14px; }
.horario-info { font-size:12px; color:#636366; display:block; margin-top:8px; line-height:1.4; border-top:1px solid #f2f2f7; padding-top:8px; }
.vape-info { font-size:13px; font-weight:600; margin-top:6px; color:#34c759; }
.extra-info { font-size:12px; color:#007aff; margin-top:6px; line-height:1.3; }
.source-badge { display:inline-block; padding:3px 8px; border-radius:8px; font-size:10px; font-weight:600; margin-top:6px; background:#f2f2f7; color:#636366; }
.stats { font-size:11px; color:#888; margin-top:15px; padding:10px; background:#f9f9f9; border-radius:8px; }
</style>
</head>

<body>

<div id="overlay">
  <div id="overlayText">Localizando estancos y quioscos...</div>
  <button id="retryBtn" style="display:none;">Reintentar acceso</button>
</div>

<button id="menuButton">‚ò∞</button>

<div id="panel">
  <h3 style="font-weight:700; margin-bottom:20px">Ajustes</h3>
  
  <label style="cursor:pointer; display:block; margin-bottom:12px">
    <input type="checkbox" id="onlyOpen"> Solo abiertos ahora
  </label>
  
  <label style="cursor:pointer; display:block; margin-bottom:20px">
    <input type="checkbox" id="greyClosed" checked> Atenuar cerrados / desconocidos
  </label>
  
  <div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-top:15px;">
    <strong style="font-size:13px">üéØ Prioridad: Estancos y Quioscos</strong>
    <small style="color:#666; font-size:11px; line-height:1.6; display:block; margin-top:8px;">
      B√∫squeda combinada usando OpenStreetMap + Google Places para m√°xima cobertura de puntos de venta de tabaco y vapers.
    </small>
  </div>
  
  <div class="stats" id="stats">
    Cargando...
  </div>
</div>

<div class="search-bar">
  <input type="text" id="address" placeholder="Ciudad, calle o c√≥digo postal">
  <button id="searchBtn">üîç</button>
</div>

<button class="btn-pin" id="pinBtn">üìå</button>
<button class="btn-search-area" id="searchAreaBtn">BUSCAR EN ESTA √ÅREA</button>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

const overlay = document.getElementById("overlay");
const overlayText = document.getElementById("overlayText");
const retryBtn = document.getElementById("retryBtn");
const onlyOpen = document.getElementById("onlyOpen");
const greyClosed = document.getElementById("greyClosed");
const menuButton = document.getElementById("menuButton");
const panel = document.getElementById("panel");
const searchBtn = document.getElementById("searchBtn");
const addressInput = document.getElementById("address");
const pinBtn = document.getElementById("pinBtn");
const searchAreaBtn = document.getElementById("searchAreaBtn");
const statsDiv = document.getElementById("stats");

let map, userLocation, markersLayer, userMarker, allPlaces = [];
let lastCenter = null;
let lastZoom = null;
let lastSearchTime = 0;
let cachedData = null;
let cachedCenter = null;
let cachedRadius = 0;
let isRendering = false;

// Estad√≠sticas
let stats = { osm: 0, google: 0, total: 0 };

// Cargar estado
onlyOpen.checked = localStorage.getItem('onlyOpen') === 'true';
greyClosed.checked = localStorage.getItem('greyClosed') !== 'false';

// Event listeners
onlyOpen.onchange = () => {
    localStorage.setItem('onlyOpen', onlyOpen.checked);
    render();
};

greyClosed.onchange = () => {
    localStorage.setItem('greyClosed', greyClosed.checked);
    render();
};

menuButton.onclick = () => panel.classList.toggle('active');

searchBtn.onclick = () => buscarDireccion();
addressInput.onkeypress = (e) => { if (e.key === 'Enter') buscarDireccion(); };

pinBtn.onclick = () => {
    if (userLocation && map) {
        map.setView([userLocation.lat, userLocation.lon], 16);
    }
};

searchAreaBtn.onclick = () => buscarDatos(true);

/* ---------- UTILIDADES ---------- */
function getDefaultName(tags, source) {
    if (source === 'google') return "Local";
    if (tags.shop === "tobacco") return "Estanco";
    if (tags.shop === "supermarket") return "Supermercado";
    if (tags.amenity === "fuel") return "Gasolinera";
    if (tags.shop === "convenience") return "Tienda de conveniencia";
    if (tags.shop === "vape" || tags.shop === "e-cigarette") return "Tienda de vapers";
    if (tags.amenity === "kiosk" || tags.shop === "kiosk") return "Kiosco";
    if (tags.shop === "newsagent") return "Quiosco de prensa";
    return "Local";
}

function vendeVapers(tags, source, name) {
    if (source === 'google') return true; // Google Places ya filtr√≥ por tipo relevante
    if (!tags) return false;
    const shop = tags.shop;
    const amenity = tags.amenity;
    return shop === 'vape' || shop === 'e-cigarette' ||
           shop === 'tobacco' ||
           shop === 'supermarket' ||
           shop === 'convenience' ||
           shop === 'kiosk' ||
           shop === 'newsagent' ||
           amenity === 'kiosk' ||
           amenity === 'fuel';
}

function distanceBetween(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const œÜ1 = lat1 * Math.PI/180;
    const œÜ2 = lat2 * Math.PI/180;
    const ŒîœÜ = (lat2-lat1) * Math.PI/180;
    const ŒîŒª = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
            Math.cos(œÜ1) * Math.cos(œÜ2) *
            Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function removeDuplicates(places) {
    const unique = [];
    const threshold = 30; // 30 metros para evitar duplicados
    
    places.forEach(place => {
        const isDuplicate = unique.some(existing => {
            const distance = distanceBetween(place.lat, place.lon, existing.lat, existing.lon);
            // Si est√°n muy cerca, preferir Google Places (m√°s actualizado)
            if (distance < threshold) {
                if (place.source === 'google' && existing.source === 'osm') {
                    // Reemplazar OSM con Google
                    const idx = unique.indexOf(existing);
                    unique[idx] = place;
                }
                return true;
            }
            return false;
        });
        
        if (!isDuplicate) {
            unique.push(place);
        }
    });
    
    return unique;
}

function parseOpeningHours(opening_hours) {
    if (!opening_hours) return { isOpen: null, text: "Horario desconocido" };
    
    if (opening_hours === "24/7") {
        return { isOpen: true, text: "Abierto 24h" };
    }
    
    const now = new Date();
    const day = now.getDay();
    const hour = now.getHours();
    const minute = now.getMinutes();
    const currentTime = hour * 60 + minute;
    
    const dayNames = {
        'Mo': 'Lun', 'Tu': 'Mar', 'We': 'Mi√©', 'Th': 'Jue', 
        'Fr': 'Vie', 'Sa': 'S√°b', 'Su': 'Dom'
    };
    
    let displayText = opening_hours;
    Object.keys(dayNames).forEach(en => {
        displayText = displayText.replace(new RegExp(en, 'g'), dayNames[en]);
    });
    displayText = displayText.replace(/;/g, '<br>').replace(/24\/7/g, 'Abierto 24h');
    
    let isOpen = null;
    
    if (opening_hours.match(/Mo-Fr \d{2}:\d{2}-\d{2}:\d{2}/)) {
        if (day >= 1 && day <= 5) {
            const match = opening_hours.match(/(\d{2}):(\d{2})-(\d{2}):(\d{2})/);
            if (match) {
                const openTime = parseInt(match[1]) * 60 + parseInt(match[2]);
                const closeTime = parseInt(match[3]) * 60 + parseInt(match[4]);
                isOpen = currentTime >= openTime && currentTime <= closeTime;
            }
        } else {
            isOpen = false;
        }
    }
    
    return { isOpen, text: displayText };
}

function parseGoogleHours(periods, currentlyOpen) {
    if (!periods || periods.length === 0) {
        return { 
            isOpen: currentlyOpen ?? null, 
            text: currentlyOpen === true ? "Abierto ahora" : currentlyOpen === false ? "Cerrado ahora" : "Horario desconocido" 
        };
    }
    
    const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
    let schedule = [];
    
    periods.forEach(period => {
        if (period.open) {
            const day = dayNames[period.open.day];
            const openTime = period.open.time.substring(0, 2) + ':' + period.open.time.substring(2);
            const closeTime = period.close ? period.close.time.substring(0, 2) + ':' + period.close.time.substring(2) : '24:00';
            schedule.push(`${day}: ${openTime}-${closeTime}`);
        }
    });
    
    return {
        isOpen: currentlyOpen ?? null,
        text: schedule.length > 0 ? schedule.join('<br>') : "Horario variable"
    };
}

/* ---------- GEOLOCALIZACI√ìN ---------- */
function iniciarGeolocalizacion() {
    navigator.geolocation.getCurrentPosition(
        pos => { iniciarMapa(pos.coords.latitude, pos.coords.longitude); },
        err => {
            overlayText.innerHTML = "Error: GPS desactivado o denegado.";
            retryBtn.style.display = "block";
        },
        { enableHighAccuracy: true, timeout: 12000 }
    );
}

retryBtn.onclick = () => iniciarGeolocalizacion();

/* ---------- B√öSQUEDA DE DIRECCI√ìN ---------- */
async function buscarDireccion() {
    const query = addressInput.value.trim();
    if (!query) return;
    
    overlay.style.display = 'flex';
    overlayText.textContent = 'Buscando ubicaci√≥n...';
    
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data && data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            
            if (map) {
                map.setView([lat, lon], 16);
                overlay.style.display = 'none';
                buscarDatos(true);
            } else {
                iniciarMapa(lat, lon);
            }
        } else {
            overlayText.textContent = 'No se encontr√≥ la ubicaci√≥n';
            setTimeout(() => overlay.style.display = 'none', 2000);
        }
    } catch (e) {
        console.error('Error buscando direcci√≥n:', e);
        overlayText.textContent = 'Error al buscar';
        setTimeout(() => overlay.style.display = 'none', 2000);
    }
}

/* ---------- INICIAR MAPA ---------- */
function iniciarMapa(lat, lon) {
    userLocation = { lat, lon };
    overlay.style.display = "none";
    document.getElementById("map").style.display = "block";

    map = L.map('map', { zoomControl: false }).setView([lat, lon], 16);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    markersLayer = L.markerClusterGroup({
        maxClusterRadius: 70,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
    }).addTo(map);

    userMarker = L.circleMarker([lat, lon], {
        radius: 9, color: "white", fillColor: "#007aff", fillOpacity: 0.9, weight: 3
    }).addTo(map);

    let searchTimeout;
    map.on('moveend zoomend', () => {
        const now = Date.now();
        if (now - lastSearchTime < 5000) return;

        const currentCenter = map.getCenter();
        const currentZoom = map.getZoom();

        if (cachedData && cachedCenter && currentCenter.distanceTo(cachedCenter) < cachedRadius * 0.7) {
            return;
        }

        const movedFar = !lastCenter || currentCenter.distanceTo(lastCenter) > 500 || Math.abs(currentZoom - lastZoom) >= 1;

        if (movedFar) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                lastCenter = currentCenter;
                lastZoom = currentZoom;
                lastSearchTime = now;
                buscarDatos(false);
            }, 2000);
        }
    });

    buscarDatos(false);
}

function getVisibleRadius() {
    const bounds = map.getBounds();
    return Math.min(map.getCenter().distanceTo(bounds.getNorthEast()) * 1.2, 3000);
}

/* ---------- BUSCAR DATOS ---------- */
async function buscarDatos(showOverlay = false) {
    if (!map) return;

    const c = map.getCenter();
    const radio = getVisibleRadius();

    if (showOverlay) {
        overlay.style.display = 'flex';
        overlayText.textContent = 'Buscando estancos y quioscos...';
    }

    try {
        // Buscar en AMBAS fuentes para m√°xima cobertura
        const [osmPlaces, googlePlaces] = await Promise.all([
            buscarOpenStreetMap(c.lat, c.lng, radio),
            buscarGooglePlaces(c.lat, c.lng, radio)
        ]);
        
        stats.osm = osmPlaces.length;
        stats.google = googlePlaces.length;
        
        // Combinar y eliminar duplicados
        const combined = [...osmPlaces, ...googlePlaces];
        allPlaces = removeDuplicates(combined);
        
        stats.total = allPlaces.length;
        
        console.log(`üìä Encontrados: ${stats.osm} OSM + ${stats.google} Google = ${stats.total} √∫nicos`);
        
        statsDiv.innerHTML = `üìä Resultados:<br>OSM: ${stats.osm} | Google: ${stats.google}<br>Total √∫nico: ${stats.total}`;
        
        cachedData = allPlaces;
        cachedCenter = c;
        cachedRadius = radio;

        render();
    } catch (e) {
        console.error("Error al buscar:", e);
        if (showOverlay) {
            overlayText.textContent = 'Error al cargar datos';
            setTimeout(() => overlay.style.display = 'none', 2000);
        }
    } finally {
        if (showOverlay) setTimeout(() => overlay.style.display = 'none', 800);
    }
}

/* ---------- GOOGLE PLACES ---------- */
async function buscarGooglePlaces(lat, lng, radio) {
    try {
        // Usar el proxy de Google Places a trav√©s de la API web est√°ndar
        // IMPORTANTE: Buscamos espec√≠ficamente estancos, kioscos y tiendas de tabaco
        const searches = [
            'estanco',
            'kiosko',
            'quiosco', 
            'tobacco shop',
            'tienda de tabaco',
            'expendedur√≠a'
        ];
        
        const allResults = [];
        
        for (const searchTerm of searches) {
            try {
                // Usamos la API de text search de Google
                const url = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(searchTerm)}&location=${lat},${lng}&radius=${radio}&key=YOUR_API_KEY`;
                
                // Como no tenemos API key directa, usamos Nominatim con t√©rminos espec√≠ficos
                const osmUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchTerm)}&lat=${lat}&lon=${lng}&limit=50`;
                
                const response = await fetch(osmUrl);
                const data = await response.json();
                
                data.forEach(place => {
                    if (place.lat && place.lon) {
                        const distance = distanceBetween(lat, lng, parseFloat(place.lat), parseFloat(place.lon));
                        if (distance <= radio) {
                            allResults.push({
                                lat: parseFloat(place.lat),
                                lon: parseFloat(place.lon),
                                name: place.display_name.split(',')[0],
                                tags: { name: place.display_name.split(',')[0] },
                                source: 'google',
                                currentlyOpen: null,
                                periods: null
                            });
                        }
                    }
                });
                
                // Peque√±a pausa entre b√∫squedas
                await new Promise(resolve => setTimeout(resolve, 200));
            } catch (e) {
                console.error(`Error buscando "${searchTerm}":`, e);
            }
        }
        
        return allResults;
        
    } catch (e) {
        console.error("Error en Google Places:", e);
        return [];
    }
}

/* ---------- OPENSTREETMAP ---------- */
async function buscarOpenStreetMap(lat, lng, radio) {
    try {
        // Query OPTIMIZADA para estancos y quioscos prioritariamente
        const query = `[out:json][timeout:25];
(
  node["shop"="tobacco"](around:${radio},${lat},${lng});
  way["shop"="tobacco"](around:${radio},${lat},${lng});
  node["amenity"="kiosk"](around:${radio},${lat},${lng});
  way["amenity"="kiosk"](around:${radio},${lat},${lng});
  node["shop"="kiosk"](around:${radio},${lat},${lng});
  way["shop"="kiosk"](around:${radio},${lat},${lng});
  node["shop"="newsagent"](around:${radio},${lat},${lng});
  way["shop"="newsagent"](around:${radio},${lat},${lng});
  node["shop"="vape"](around:${radio},${lat},${lng});
  way["shop"="vape"](around:${radio},${lat},${lng});
  node["shop"="e-cigarette"](around:${radio},${lat},${lng});
  way["shop"="e-cigarette"](around:${radio},${lat},${lng});
  node["shop"="convenience"](around:${radio},${lat},${lng});
  way["shop"=
