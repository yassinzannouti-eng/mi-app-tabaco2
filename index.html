<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vaper Tracker Pro</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body, html {
    margin:0;
    padding:0;
    height:100%;
    font-family:'Segoe UI',sans-serif;
}

#map { height:100vh; width:100%; }

.search-bar {
    position:absolute;
    top:15px;
    left:50%;
    transform:translateX(-50%);
    z-index:1000;
    display:flex;
    width:90%;
    max-width:420px;
    border-radius:30px;
    overflow:hidden;
    box-shadow:0 5px 20px rgba(0,0,0,0.25);
    background:white;
}

.search-bar input {
    flex:1;
    padding:14px;
    border:none;
    outline:none;
    font-size:14px;
}

.search-bar button {
    background:#2563eb;
    color:white;
    border:none;
    padding:0 18px;
    cursor:pointer;
    font-size:16px;
}

.popup-card {
    text-align:center;
    min-width:160px;
}

.badge {
    font-size:10px;
    padding:4px 8px;
    border-radius:6px;
    color:white;
    font-weight:bold;
    display:inline-block;
    margin-bottom:6px;
}
</style>
</head>

<body>

<div class="search-bar">
    <input type="text" id="address" placeholder="Buscar ciudad o calle...">
    <button onclick="buscarManual()">üîç</button>
</div>

<div id="map"></div>

<script>

var map = L.map('map',{maxZoom:20}).setView([40.41,-3.70],6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:20
}).addTo(map);

var markersLayer = L.layerGroup().addTo(map);

var iconRed = L.icon({
    iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
    iconSize:[25,41],
    iconAnchor:[12,41]
});

var iconGold = L.icon({
    iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-gold.png',
    iconSize:[25,41],
    iconAnchor:[12,41]
});

map.locate({setView:true, zoom:16});

map.on('locationfound', function(e){
    buscarDatos(e.latlng.lat, e.latlng.lng);
});

function buscarDatos(lat, lng) {

    markersLayer.clearLayers();

    var query = `
    [out:json][timeout:25];
    (
      node["shop"="tobacco"](around:2500,${lat},${lng});
      node["shop"="convenience"](around:2500,${lat},${lng});
      node["shop"="variety_store"](around:2500,${lat},${lng});
      node["amenity"="fuel"](around:2500,${lat},${lng});
    );
    out body;
    `;

    fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: "data=" + encodeURIComponent(query)
    })
    .then(res => res.json())
    .then(data => {

        if (!data.elements) return;

        data.elements.forEach(p => {

            if (!p.tags) return;

            let shopType = p.tags.shop || "";
            let nombre = (p.tags.name || "").toLowerCase();

            // üö´ FILTRO DEFINITIVO
            if (
                shopType === "greengrocer" ||
                shopType === "fishmonger" ||
                shopType === "seafood" ||
                shopType === "butcher" ||
                nombre.includes("fruter") ||
                nombre.includes("pescader") ||
                nombre.includes("carnicer") ||
                nombre.includes("charcuter")
            ) {
                return;
            }

            let esEstanco = shopType === "tobacco";
            let esGas = p.tags.amenity === "fuel";

            let titulo = p.tags.name || (esEstanco ? "Estanco" : (esGas ? "Gasolinera" : "Tienda"));

            let icono = esEstanco ? iconRed : iconGold;
            let badgeColor = esEstanco ? "#e11d48" : "#eab308";
            let badgeText = esEstanco ? "ESTANCO" : (esGas ? "GASOLINERA" : "TIENDA");

            let gLink = `https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lon}`;

            L.marker([p.lat, p.lon], { icon: icono })
            .addTo(markersLayer)
            .bindPopup(`
                <div class="popup-card">
                    <span class="badge" style="background:${badgeColor}">
                        ${badgeText}
                    </span>
                    <h4>${titulo}</h4>
                    <a href="${gLink}" target="_blank">Ver en Google</a>
                </div>
            `);

        });

    })
    .catch(err => console.error("Error Overpass:", err));
}

function buscarManual(){
    var val=document.getElementById('address').value;

    fetch('https://nominatim.openstreetmap.org/search?format=json&q='+val)
    .then(r=>r.json())
    .then(data=>{
        if(data.length>0){
            map.setView([data[0].lat,data[0].lon],17);
            buscarDatos(data[0].lat,data[0].lon);
        }
    });
}

</script>

</body>
</html>
