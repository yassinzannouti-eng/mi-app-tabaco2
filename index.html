<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vaper Tracker Pro</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
html, body { height: 100%; margin: 0; font-family: system-ui, sans-serif; background: #f9f9fb; }
#map { height: 100%; width: 100%; display: none; }

#overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.7); color: white;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  z-index: 9999; text-align: center; padding: 30px;
}
#overlay button {
  margin-top: 20px; padding: 12px 32px;
  background: #007aff; color: white; border: none;
  border-radius: 12px; cursor: pointer; font-weight: 600;
}

#menuButton {
  position: fixed; top: 16px; left: 16px; z-index: 2000;
  background: rgba(255,255,255,0.92); border: none; padding: 12px;
  border-radius: 12px; box-shadow: 0 3px 12px #0003;
  cursor: pointer; backdrop-filter: blur(8px); font-size: 1.4rem;
}
#panel {
  position: fixed; top: 0; left: -280px; width: 260px; height: 100%;
  background: white; z-index: 2100; padding: 24px;
  box-shadow: 4px 0 20px #0002; transition: left 0.35s ease; overflow-y: auto;
}
#panel.active { left: 0; }

.search-bar {
  position: absolute; top: 16px; left: 50%; transform: translateX(-50%);
  z-index: 1500; width: 90%; max-width: 460px; background: rgba(255,255,255,0.97);
  border-radius: 50px; box-shadow: 0 5px 18px #0002; display: flex; overflow: hidden;
}
.search-bar input { flex: 1; border: none; padding: 14px 20px; font-size: 1rem; background: transparent; }
.search-bar button { padding: 0 22px; background: #007aff; color: white; border: none; font-size: 1.3rem; cursor: pointer; }

.btn-floating {
  position: absolute; right: 20px; background: #007aff; color: white;
  border: none; border-radius: 50%; width: 56px; height: 56px;
  font-size: 1.6rem; cursor: pointer; box-shadow: 0 5px 15px #0004;
  display: flex; align-items: center; justify-content: center;
}
#pinBtn { bottom: 100px; }
#searchAreaBtn { bottom: 30px; width: auto; padding: 0 20px; border-radius: 999px; font-size: 0.95rem; font-weight: 600; }

.popup-container { min-width: 240px; padding: 8px; font-size: 0.95rem; }
.btn-maps { display: block; background: #007aff; color: white !important; text-align: center; padding: 12px; border-radius: 12px; text-decoration: none !important; margin-top: 12px; font-weight: 600; }
.horario-info { font-size: 0.82rem; color: #555; margin: 6px 0; border-top: 1px solid #eee; padding-top: 6px; }
.vape-info { color: #28a745; font-weight: 600; margin: 6px 0; }
.extra-info { color: #007aff; font-size: 0.82rem; margin: 6px 0; }
</style>
</head>
<body>

<div id="overlay">
  <div id="overlayText">Localizando...</div>
  <button id="retryBtn" style="display:none;">Reintentar</button>
</div>

<button id="menuButton">‚ò∞</button>

<div id="panel">
  <h3>Ajustes</h3>
  <label><input type="checkbox" id="onlyOpen"> Solo abiertos ahora</label><br><br>
  <label><input type="checkbox" id="greyClosed" checked> Atenuar cerrados</label>
  <hr style="margin:20px 0">
  <strong>Estancos Oficiales</strong><br>
  <a href="https://serviciostelematicosext.hacienda.gob.es/CMT/Visor/csvExpendedurias.aspx" target="_blank" style="color:#007aff">Descargar CSV completo</a><br>
  <a href="https://serviciostelematicosext.hacienda.gob.es/CMT/Visor/visor.aspx" target="_blank" style="color:#007aff">Mapa oficial del Comisionado</a>
</div>

<div class="search-bar">
  <input id="address" placeholder="Ciudad, calle o c√≥digo postal..." autocomplete="off">
  <button id="searchBtn">üîç</button>
</div>

<button id="pinBtn" class="btn-floating">üìç</button>
<button id="searchAreaBtn" class="btn-floating">BUSCAR AQU√ç</button>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const els = {
    overlay: document.getElementById('overlay'),
    overlayText: document.getElementById('overlayText'),
    retryBtn: document.getElementById('retryBtn'),
    onlyOpen: document.getElementById('onlyOpen'),
    greyClosed: document.getElementById('greyClosed'),
    menuButton: document.getElementById('menuButton'),
    panel: document.getElementById('panel'),
    searchBtn: document.getElementById('searchBtn'),
    address: document.getElementById('address'),
    pinBtn: document.getElementById('pinBtn'),
    searchAreaBtn: document.getElementById('searchAreaBtn'),
    mapDiv: document.getElementById('map')
  };

  let map = null;
  let markers = null;
  let userLoc = null;
  let places = [];

  // Estado
  els.onlyOpen.checked = localStorage.getItem('onlyOpen') === 'true';
  els.greyClosed.checked = localStorage.getItem('greyClosed') !== 'false';

  els.onlyOpen.onchange = () => { localStorage.setItem('onlyOpen', els.onlyOpen.checked); render(); };
  els.greyClosed.onchange = () => { localStorage.setItem('greyClosed', els.greyClosed.checked); render(); };

  els.menuButton.onclick = () => els.panel.classList.toggle('active');
  els.pinBtn.onclick = () => userLoc && map?.flyTo([userLoc.lat, userLoc.lon], 16);
  els.searchAreaBtn.onclick = () => buscarDatos(true);
  els.searchBtn.onclick = buscarDireccion;
  els.address.onkeypress = e => { if (e.key === 'Enter') buscarDireccion(); };
  els.retryBtn.onclick = iniciarGeo;

  function showOverlay(msg = 'Cargando...') {
    els.overlayText.textContent = msg;
    els.overlay.style.display = 'flex';
    els.retryBtn.style.display = 'none';
  }

  function hideOverlay() { els.overlay.style.display = 'none'; }

  function showError(msg) {
    els.overlayText.textContent = msg;
    els.retryBtn.style.display = 'block';
    els.overlay.style.display = 'flex';
  }

  async function buscarDireccion() {
    const q = els.address.value.trim();
    if (!q) return;
    showOverlay('Buscando direcci√≥n...');

    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`);
      const d = await res.json();
      if (d?.[0]) {
        const { lat, lon } = d[0];
        map ? map.setView([lat, lon], 14) : iniciarMapa(parseFloat(lat), parseFloat(lon));
        setTimeout(() => buscarDatos(true), 800);
      } else {
        showError('Direcci√≥n no encontrada');
        setTimeout(hideOverlay, 1800);
      }
    } catch {
      showError('Error al buscar direcci√≥n');
      setTimeout(hideOverlay, 2200);
    }
  }

  function iniciarMapa(lat, lon) {
    userLoc = { lat, lon };
    els.mapDiv.style.display = 'block';

    map = L.map('map', { zoomControl: false }).setView([lat, lon], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    markers = L.markerClusterGroup({ maxClusterRadius: 75 }).addTo(map);

    L.circleMarker([lat, lon], {
      radius: 10, color: 'white', fillColor: '#007aff', fillOpacity: 0.9, weight: 3
    }).addTo(map);

    let timeout;
    map.on('moveend zoomend', () => {
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        if (Date.now() - (window.lastSearch || 0) > 8000) buscarDatos(false);
      }, 1400);
    });

    buscarDatos(true);
  }

  async function buscarDatos(withOverlay = false) {
    if (!map) return;
    if (withOverlay) showOverlay('Buscando estancos y kioscos...');

    try {
      const b = map.getBounds();
      const bbox = `${b.getSouth().toFixed(5)},${b.getWest().toFixed(5)},${b.getNorth().toFixed(5)},${b.getEast().toFixed(5)}`;

      const query = `[out:json][timeout:15][bbox:${bbox}];
      (
        nwr["shop"~"tobacco|kiosk|newsagent|vape|e-cigarette|convenience|supermarket"](bbox);
        nwr["amenity"~"kiosk|fuel"](bbox);
      );
      out center;`;

      const res = await fetch('https://overpass-api.de/api/interpreter', {
        method: 'POST',
        body: 'data=' + encodeURIComponent(query),
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
      });

      if (!res.ok) throw new Error(`Overpass ${res.status}`);

      const data = await res.json();
      places = (data.elements || []).map(el => ({
        lat: el.lat ?? el.center?.lat,
        lon: el.lon ?? el.center?.lon,
        tags: el.tags || {},
        name: el.tags?.name || 'Punto'
      })).filter(p => p.lat && p.lon);

      render();
    } catch (err) {
      console.error(err);
      showError('No se pudieron cargar los datos\nPrueba mover el mapa o reintentar');
    } finally {
      if (withOverlay) setTimeout(hideOverlay, 800);
    }
  }

  function render() {
    if (!markers) return;
    markers.clearLayers();

    const onlyOpen = els.onlyOpen.checked;
    const grey = els.greyClosed.checked;

    places.forEach(p => {
      const oh = p.tags.opening_hours || '';
      const knownOpen = oh.includes('24/7') || oh.includes('Mo-Su');

      if (onlyOpen && !knownOpen) return;

      let color = '#888';
      if (/tobacco|kiosk|newsagent/.test(p.tags.shop || p.tags.amenity || '')) color = '#8B4789';

      let opacity = grey && !knownOpen ? 0.5 : 0.9;

      const popup = `
        <div class="popup-container">
          <b>${p.name || 'Punto'}</b><br>
          <div class="horario-info">${oh || 'Horario desconocido'}</div>
          <div class="vape-info">‚úì Probable venta de tabaco y vapers</div>
        </div>`;

      const marker = L.circleMarker([p.lat, p.lon], {
        radius: 8, fillColor: color, color: 'white', weight: 2, fillOpacity: opacity
      }).bindPopup(popup);

      markers.addLayer(marker);
    });
  }

  function iniciarGeo() {
    showOverlay('Obteniendo ubicaci√≥n...');
    if (!navigator.geolocation) return showError('Geolocalizaci√≥n no soportada');

    navigator.geolocation.getCurrentPosition(
      pos => iniciarMapa(pos.coords.latitude, pos.coords.longitude),
      err => showError(err.code === 1 ? 'Permiso denegado' : 'Error de ubicaci√≥n'),
      { timeout: 12000, maximumAge: 0 }
    );
  }

  iniciarGeo();
});
</script>
</body>
</html>
