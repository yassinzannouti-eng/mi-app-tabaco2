<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Localizador de Estancos Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        html,body{height:100%;margin:0;font-family: sans-serif; background: #eee;}
        #map{height:100%;width:100%;}

        /* Buscador */
        .search-bar{
            position:absolute;top:10px;left:50%;transform:translateX(-50%);
            z-index:1000;display:flex;background:white;width:90%;max-width:400px;
            border-radius:25px;box-shadow:0 4px 10px rgba(0,0,0,0.2);overflow:hidden;
        }
        .search-bar input{flex:1;padding:12px;border:none;outline:none;}
        .search-bar button{padding:12px;border:none;background:#2563eb;color:white;cursor:pointer;}

        /* Botones Flotantes */
        .btn-gps{
            position:fixed;bottom:20px;right:20px;z-index:1000;
            width:55px;height:55px;background:#2563eb;color:white;
            border-radius:50%;border:none;box-shadow:0 4px 10px rgba(0,0,0,0.3);
            font-size:24px;cursor:pointer;
        }

        /* Popups */
        .popup-box{text-align:center; padding:5px;}
        .popup-name{font-weight:bold; font-size:16px; display:block; margin-bottom:5px;}
        .popup-status{font-size:12px; margin-bottom:10px; display:block; color:#666;}
        .btn-maps{
            display:inline-block;background:#4285F4;color:white !important;
            padding:10px 20px;text-decoration:none !important;border-radius:5px;
            font-weight:bold;margin-top:5px;
        }
    </style>
</head>
<body>

    <div class="search-bar">
        <input type="text" id="address" placeholder="Buscar ciudad...">
        <button onclick="buscarCiudad()">üîç</button>
    </div>

    <button class="btn-gps" onclick="centrarGps()">üéØ</button>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, markersLayer, userMarker;
        
        // Inicializar Mapa
        function init() {
            map = L.map('map', { zoomControl: false }).setView([40.41, -3.70], 6);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            markersLayer = L.layerGroup().addTo(map);

            // Intentar geolocalizar al entrar
            centrarGps();

            // Buscar datos cada vez que el usuario deje de mover el mapa
            map.on('moveend', buscarLocales);
        }

        function centrarGps() {
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                map.setView([lat, lon], 15);
                
                if(!userMarker) {
                    userMarker = L.circleMarker([lat, lon], {radius:8, color:'#2563eb', fillColor:'#2563eb', fillOpacity:1}).addTo(map);
                } else {
                    userMarker.setLatLng([lat, lon]);
                }
                buscarLocales();
            }, () => alert("Activa el GPS para verte en el mapa"));
        }

        async function buscarLocales() {
            const bounds = map.getBounds();
            const bbox = `${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()}`;
            
            // Consulta simplificada para m√°xima velocidad
            const query = `[out:json][timeout:15];
                (node["shop"~"tobacco|supermarket|variety_store"](${bbox});
                 node["amenity"="fuel"](${bbox}););
                out tags;`;

            try {
                const response = await fetch("https://overpass-api.de/api/interpreter", {
                    method: "POST",
                    body: "data=" + encodeURIComponent(query)
                });
                const data = await response.json();
                pintarMarcadores(data.elements);
            } catch (err) {
                console.error("Error cargando locales");
            }
        }

        function pintarMarcadores(elementos) {
            markersLayer.clearLayers();
            
            elementos.forEach(el => {
                if(!el.lat || !el.lon) return;

                // Definir color seg√∫n tipo
                let color = "gold";
                if(el.tags.shop === "tobacco") color = "red";
                if(el.tags.amenity === "fuel") color = "orange";

                const icon = L.icon({
                    iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
                });

                const nombre = el.tags.name || "Punto de venta";
                const horario = el.tags.opening_hours || "Horario no disponible";
                
                // ENLACE A GOOGLE MAPS (WEB DEL LOCAL)
                // Usamos la b√∫squeda por nombre y coordenadas para asegurar que abra la ficha
                const queryMaps = encodeURIComponent(`${nombre} ${el.lat},${el.lon}`);
                const urlMaps = `https://www.google.com/maps/search/?api=1&query=${queryMaps}`;

                L.marker([el.lat, el.lon], {icon}).addTo(markersLayer)
                .bindPopup(`
                    <div class="popup-box">
                        <span class="popup-name">${nombre}</span>
                        <span class="popup-status">üïí ${horario}</span>
                        <a href="${urlMaps}" target="_blank" class="btn-maps">VER EN MAPS</a>
                    </div>
                `);
            });
        }

        async function buscarCiudad() {
            const city = document.getElementById('address').value;
            if(!city) return;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`);
            const data = await res.json();
            if(data.length > 0) {
                map.setView([data[0].lat, data[0].lon], 15);
                buscarLocales();
            }
        }

        window.onload = init;
    </script>
</body>
</html>
