<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Buscador de Locales</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { margin:0; font-family:Arial, sans-serif; }
#map { height:60vh; width:100%; }
.controls { padding:10px; background:#fff; }
select, button, label {
  width:100%;
  padding:8px;
  margin:5px 0;
}
#results {
  padding:10px;
  max-height:40vh;
  overflow:auto;
}
.card {
  border-bottom:1px solid #ddd;
  padding:10px 0;
}
.open { color:green; font-weight:bold; }
.closed { color:red; font-weight:bold; }
</style>
</head>

<body>

<div class="controls">

  <select id="typeFilter">
    <option value="restaurant">Restaurantes</option>
    <option value="bar">Bares</option>
    <option value="cafe">Cafeterías</option>
    <option value="store">Tiendas</option>
    <option value="supermarket">Supermercados</option>
  </select>

  <label>
    <input type="checkbox" id="openNowFilter">
    Solo abiertos ahora
  </label>

  <button id="searchBtn">Buscar en esta área</button>

</div>

<div id="map"></div>
<div id="results"></div>

<script>
let map;
let service;
let infowindow;
let markers = [];
let userLocation;

function initMap() {

  if (!navigator.geolocation) {
    alert("Geolocalización no soportada.");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    position => {

      userLocation = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };

      map = new google.maps.Map(document.getElementById("map"), {
        center: userLocation,
        zoom: 15
      });

      new google.maps.Marker({
        position: userLocation,
        map: map,
        icon: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"
      });

      service = new google.maps.places.PlacesService(map);
      infowindow = new google.maps.InfoWindow();

      // Esperar a que el mapa termine de cargar antes de buscar
      google.maps.event.addListenerOnce(map, "idle", () => {
        searchPlaces();
      });
    },
    error => {
      alert("Error obteniendo ubicación: " + error.message);
    }
  );
}

function clearMarkers() {
  markers.forEach(marker => marker.setMap(null));
  markers = [];
}

function searchPlaces() {

  if (!map) return;

  clearMarkers();
  document.getElementById("results").innerHTML = "";

  const selectedType = document.getElementById("typeFilter").value;
  const openNow = document.getElementById("openNowFilter").checked;

  const request = {
    location: map.getCenter(),
    radius: 1500,
    type: selectedType,
    openNow: openNow
  };

  service.nearbySearch(request, (results, status) => {
    if (status === google.maps.places.PlacesServiceStatus.OK) {
      results.forEach(place => {
        createMarker(place);
        createCard(place);
      });
    }
  });
}

function createMarker(place) {
  const marker = new google.maps.Marker({
    map,
    position: place.geometry.location
  });

  markers.push(marker);

  marker.addListener("click", () => {
    infowindow.setContent(`<strong>${place.name}</strong>`);
    infowindow.open(map, marker);
  });
}

function createCard(place) {

  const mapsUrl = `https://www.google.com/maps/place/?q=place_id:${place.place_id}`;

  service.getDetails(
    {
      placeId: place.place_id,
      fields: ["name", "formatted_address", "opening_hours"]
    },
    (details, status) => {

      let horario = "No disponible";
      let estado = "";

      if (status === google.maps.places.PlacesServiceStatus.OK) {

        if (details.opening_hours) {

          estado = details.opening_hours.open_now
            ? `<span class="open">Abierto ahora</span>`
            : `<span class="closed">Cerrado</span>`;

          if (details.opening_hours.weekday_text) {
            horario = details.opening_hours.weekday_text.join("<br>");
          }
        }
      }

      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <h3>${place.name}</h3>
        <p>${details?.formatted_address || ""}</p>
        <p>${estado}</p>
        <p><strong>Horario:</strong><br>${horario}</p>
        <button onclick="window.open('${mapsUrl}','_blank')">
          Ver en Maps
        </button>
      `;

      document.getElementById("results").appendChild(card);
    }
  );
}

document.getElementById("searchBtn").addEventListener("click", searchPlaces);
document.getElementById("typeFilter").addEventListener("change", searchPlaces);
document.getElementById("openNowFilter").addEventListener("change", searchPlaces);

</script>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY&libraries=places&callback=initMap">
</script>

</body>
</html>
