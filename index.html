<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vaper Tracker Web Completo</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<style>
html, body {height:100%; margin:0; font-family:Arial,sans-serif;}
#map{height:100%; width:100%;}
#menuButton{
  position:fixed; top:15px; left:15px; z-index:2000;
  background:white; border:none; padding:10px; border-radius:8px;
  box-shadow:0 3px 8px rgba(0,0,0,0.2); cursor:pointer;
}
#panel{
  position:fixed; top:0; left:-260px; width:240px; height:100%;
  background:white; z-index:2100; padding:20px;
  box-shadow:2px 0 15px rgba(0,0,0,0.2);
  transition:.3s; overflow:auto;
}
#panel.active{left:0;}
.search-bar{
  position:absolute; top:15px; left:50%; transform:translateX(-50%);
  z-index:1500; display:flex; background:white; border-radius:25px;
  box-shadow:0 4px 15px rgba(0,0,0,0.18); overflow:hidden;
}
.search-bar input{padding:10px; border:none; outline:none;}
.search-bar button{padding:10px; border:none; background:#2563eb; color:white; cursor:pointer;}
.btn-locate{
  position:absolute; bottom:100px; right:20px; z-index:1500;
  width:48px; height:48px; background:#2563eb; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 3px 12px rgba(0,0,0,0.25); border:none; cursor:pointer; color:white; font-size:22px;
}
.btn-add-manual{
  position:absolute; bottom:30px; left:20px; z-index:1500;
  background:rgba(255,255,255,0.95); border:1px solid #ccc; padding:7px 14px; border-radius:18px;
  font-size:12px; font-weight:bold; cursor:pointer; color:#444; box-shadow:0 2px 6px rgba(0,0,0,0.12);
}
.legend-item{display:flex; align-items:center; margin-bottom:5px;}
.legend-color{width:15px; height:15px; border-radius:4px; margin-right:6px;}
.badge{font-size:12px; padding:3px 6px; border-radius:8px;}
.open{background:#22c55e;color:white;}
.closed{background:#ef4444;color:white;}
</style>
</head>
<body>

<div id="panel">
<h3>Filtros</h3>
<label><input type="checkbox" id="onlyOpen"> Solo abiertos</label><br>
<label><input type="checkbox" id="greyClosed" checked> Cerrados en gris</label>
<hr>
<input type="text" id="searchName" placeholder="Buscar por nombre">
<hr>
<h4>Tipos de locales</h4>
<label class="legend-item"><input type="checkbox" id="toggleEstanco" checked>
  <div class="legend-color" style="background:red;"></div>Estanco</label>
<label class="legend-item"><input type="checkbox" id="toggleTienda" checked>
  <div class="legend-color" style="background:gold;"></div>Tienda/Bazar</label>
<label class="legend-item"><input type="checkbox" id="toggleBar" checked>
  <div class="legend-color" style="background:purple;"></div>Bar/Cafeter√≠a</label>
</div>

<button id="menuButton">‚ò∞</button>

<div class="search-bar">
<input type="text" id="address" placeholder="Buscar ciudad o zona">
<button id="searchBtn">üîç</button>
</div>

<button class="btn-locate" id="locateBtn">üìç</button>
<button class="btn-add-manual" id="addBtn">‚ûï Guardar coordenada</button>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
document.addEventListener("DOMContentLoaded",()=>{

const map=L.map('map').setView([40.4168,-3.7038],6);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
  attribution:'¬©OpenStreetMap ¬©CARTO'
}).addTo(map);

const cluster=L.markerClusterGroup();
map.addLayer(cluster);

let userLocation=null;
map.locate({enableHighAccuracy:true, watch:true});
map.on('locationfound',e=>{userLocation=e.latlng;});

function icon(color){return L.icon({
iconUrl:`https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
iconSize:[25,41],iconAnchor:[12,41]})}

const icons={
estanco:icon("red"),
tienda:icon("gold"),
bar:icon("purple"),
grey:icon("grey")
};

let elementsData=[];
let filter={estanco:true,tienda:true,bar:true};

function analizarHorario(opening){
if(!opening) return {estado:null,texto:"<span class='badge closed'>Horario desconocido</span>"};
if(opening.includes("24/7")) return {estado:true,texto:"<span class='badge open'>24/7</span>"};
const now=new Date();
const min=now.getHours()*60 + now.getMinutes();
const match=[...opening.matchAll(/(\d{2}:\d{2})-(\d{2}:\d{2})/g)];
for(let r of match){
const ini=r[1].split(":"); const fin=r[2].split(":");
const mi=parseInt(ini[0])*60+parseInt(ini[1]);
const mf=parseInt(fin[0])*60+parseInt(fin[1]);
if(min>=mi && min<=mf) return {estado:true,texto:"<span class='badge open'>Abierto</span>"};
}
return {estado:false,texto:"<span class='badge closed'>Cerrado</span>"};
}

async function buscarDatos(){
cluster.clearLayers();
const c=map.getCenter();
const r=6000;
const query=`[out:json];
(node["shop"="tobacco"](around:${r},${c.lat},${c.lng});
node["shop"~"convenience|variety_store"](around:${r},${c.lat},${c.lng});
node["amenity"="bar"](around:${r},${c.lat},${c.lng});
);out;`;
try{
const resp=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:query});
const data=await resp.json();
elementsData=data.elements||[];
render();
}catch(e){console.log("Error Overpass",e);}
}

function render(){
cluster.clearLayers();
const onlyOpen=document.getElementById("onlyOpen").checked;
const greyClosed=document.getElementById("greyClosed").checked;
const search=document.getElementById("searchName").value.toLowerCase();

elementsData.forEach(p=>{
const tipo=p.tags?.shop==="tobacco"?"estanco":p.tags?.shop?"tienda":"bar";
if(!filter[tipo]) return;
if(search && !p.tags?.name?.toLowerCase().includes(search)) return;
const horario=analizarHorario(p.tags?.opening_hours);
if(onlyOpen && horario.estado===false) return;

let icono=icons[tipo];
if(horario.estado===false && greyClosed) icono=icons.grey;

const marker=L.marker([p.lat,p.lon],{icon:icono});
marker.bindPopup(`
<b>${p.tags?.name||tipo}</b><br>
${horario.texto}<br>
<a href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}" target="_blank">C√≥mo llegar</a>
`);
cluster.addLayer(marker);
});
}

// Panel y filtros
document.getElementById("menuButton").onclick=()=>document.getElementById("panel").classList.toggle("active");
document.getElementById("onlyOpen").onchange=render;
document.getElementById("greyClosed").onchange=render;
document.getElementById("searchName").oninput=render;
document.getElementById("toggleEstanco").onchange=e=>{filter.estanco=e.target.checked; render();}
document.getElementById("toggleTienda").onchange=e=>{filter.tienda=e.target.checked; render();}
document.getElementById("toggleBar").onchange=e=>{filter.bar=e.target.checked; render();}

// Bot√≥n localizar usuario
document.getElementById("locateBtn").onclick=()=>{if(userLocation) map.flyTo(userLocation,16);};

// Guardar coordenada manual
document.getElementById("addBtn").onclick=()=>{const c=map.getCenter(); alert("Coordenada guardada: "+c.lat.toFixed(6)+", "+c.lng.toFixed(6));};

// B√∫squeda ciudad
document.getElementById("searchBtn").onclick=async()=>{
const val=document.getElementById("address").value;
const resp=await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(val));
const data=await resp.json();
if(data.length) map.flyTo([data[0].lat,data[0].lon],14);
};

// Refrescar al mover mapa
map.on("moveend",buscarDatos);

// Carga inicial
setTimeout(buscarDatos,1500);

});
</script>
</body>
</html>
