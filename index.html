<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vaper Tracker</title>

<link rel="manifest" href="manifest.json">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>

<style>
html,body{height:100%;margin:0;font-family:sans-serif;}
#map{height:100%;width:100%;}
.search{position:absolute;top:15px;left:50%;transform:translateX(-50%);
z-index:1000;width:90%;max-width:400px;display:flex;}
.search input{flex:1;padding:10px;border:none;border-radius:20px 0 0 20px;}
.search button{padding:10px;border:none;background:#2563eb;color:white;border-radius:0 20px 20px 0;}
.badge{padding:4px 8px;border-radius:10px;font-size:12px;}
.open{background:#22c55e;color:white;}
.closed{background:#ef4444;color:white;}
</style>
</head>
<body>

<div class="search">
<input type="text" id="city" placeholder="Buscar ciudad...">
<button onclick="buscarCiudad()">üîç</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}

const map=L.map('map').setView([40.41,-3.70],6);

L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{
attribution:'¬©OpenStreetMap'
}).addTo(map);

let userLocation=null;
map.locate({enableHighAccuracy:true});
map.on('locationfound',e=>{userLocation=e.latlng;});

const cluster=L.markerClusterGroup();
map.addLayer(cluster);

function icon(color){
return L.icon({
iconUrl:`https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
iconSize:[25,41],iconAnchor:[12,41]
});
}

function estaAbierto(opening){
if(!opening)return null;
const now=new Date();
const min=now.getHours()*60+now.getMinutes();
const match=opening.match(/(\d{2}:\d{2})-(\d{2}:\d{2})/);
if(!match)return null;
const i=match[1].split(":");
const f=match[2].split(":");
const mi=parseInt(i[0])*60+parseInt(i[1]);
const mf=parseInt(f[0])*60+parseInt(f[1]);
return min>=mi&&min<=mf;
}

async function buscar(){
cluster.clearLayers();
const c=map.getCenter();
const r=6000;

const query=`[out:json];
(node["shop"="tobacco"](around:${r},${c.lat},${c.lng}););out;`;

const resp=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:query});
const data=await resp.json();

data.elements.forEach(p=>{
const abierto=estaAbierto(p.tags?.opening_hours);
let badge="";
let icono=icon("red");

if(abierto===true){
badge='<span class="badge open">Abierto</span>';
}else if(abierto===false){
badge='<span class="badge closed">Cerrado</span>';
icono=icon("grey");
}

const marker=L.marker([p.lat,p.lon],{icon:icono});

marker.bindPopup(`
<b>${p.tags?.name||"Estanco"}</b><br>
${badge}<br><br>
<a href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}" target="_blank">C√≥mo llegar</a>
`);

cluster.addLayer(marker);
});
}

async function buscarCiudad(){
const val=document.getElementById("city").value;
const resp=await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(val));
const data=await resp.json();
if(data.length)map.flyTo([data[0].lat,data[0].lon],14);
}

map.on("moveend",buscar);
setTimeout(buscar,1500);

</script>

</body>
</html>
