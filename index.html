<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VaperTracker - Estancos & Quioscos</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f5f5f7; }
#map { height: 100%; width: 100%; display: none; }

#overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.65); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:5000; color:white; font-size:18px; text-align:center; padding:30px; }
#overlay button { padding:12px 32px; border:none; background:#667eea; color:white; border-radius:12px; cursor:pointer; font-weight:600; }

#menuButton { position:fixed; top:15px; left:15px; z-index:2000; background:rgba(255,255,255,0.9); border:none; padding:12px; border-radius:14px; box-shadow:0 4px 15px rgba(0,0,0,0.1); cursor:pointer; backdrop-filter:blur(5px); }
#panel { position:fixed; top:0; left:-320px; width:300px; height:100%; background:white; z-index:2100; padding:25px; box-shadow:4px 0 20px rgba(0,0,0,0.1); transition:.3s cubic-bezier(0.4,0,0.2,1); overflow:auto; }
#panel.active { left:0; }

.search-bar { position:absolute; top:15px; left:50%; transform:translateX(-50%); z-index:1500; display:flex; background:rgba(255,255,255,0.95); border-radius:18px; box-shadow:0 8px 24px rgba(0,0,0,0.12); overflow:hidden; width:85%; max-width:420px; backdrop-filter:blur(10px); border:1px solid rgba(0,0,0,0.05); }
.search-bar input { flex:1; padding:14px; border:none; outline:none; font-size:16px; background:transparent; }
.search-bar button { padding:14px 20px; border:none; background:#667eea; color:white; cursor:pointer; }

.btn-pin { position:absolute; bottom:100px; right:20px; width:55px; height:55px; background:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:28px; color:#c00; border:none; cursor:pointer; z-index:1500; box-shadow:0 6px 16px rgba(0,0,0,0.15); }
.btn-search-area { position:absolute; bottom:30px; right:20px; background:#667eea; color:white; border:none; padding:14px 22px; border-radius:25px; cursor:pointer; z-index:1500; font-weight:700; box-shadow:0 6px 20px rgba(102,126,234,0.4); }

.popup-container { text-align:center; min-width:240px; padding:8px; }
.btn-maps { display:block; background:#667eea; color:white !important; text-align:center; padding:12px; border-radius:12px; text-decoration:none !important; margin-top:12px; font-weight:600; font-size:14px; }
.horario-info { font-size:12px; color:#636366; display:block; margin-top:8px; line-height:1.4; border-top:1px solid #f2f2f7; padding-top:8px; }
.vape-info { font-size:13px; font-weight:600; margin-top:6px; color:#34c759; }
.extra-info { font-size:12px; color:#667eea; margin-top:6px; line-height:1.3; }
.source-badge { display:inline-block; padding:3px 8px; border-radius:8px; font-size:10px; font-weight:600; margin-top:6px; background:#f2f2f7; color:#636366; }
</style>
</head>
<body>

<div id="overlay">
  <div id="overlayText">Localizando...</div>
  <button id="retryBtn" style="display:none;">Reintentar</button>
</div>

<button id="menuButton">‚ò∞</button>

<div id="panel">
  <h3 style="font-weight:700; margin-bottom:20px">‚öôÔ∏è Ajustes</h3>
  <label style="cursor:pointer; display:block; margin-bottom:12px"><input type="checkbox" id="onlyOpen"> Solo abiertos ahora</label>
  <label style="cursor:pointer; display:block; margin-bottom:20px"><input type="checkbox" id="greyClosed" checked> Atenuar cerrados</label>
</div>

<div class="search-bar">
  <input type="text" id="address" placeholder="Ciudad, calle o c√≥digo postal">
  <button id="searchBtn">üîç</button>
</div>

<button class="btn-pin" id="pinBtn">üìå</button>
<button class="btn-search-area" id="searchAreaBtn">BUSCAR AQU√ç</button>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // ==================== ELEMENTOS ====================
  const overlay = document.getElementById("overlay");
  const overlayText = document.getElementById("overlayText");
  const retryBtn = document.getElementById("retryBtn");
  const onlyOpen = document.getElementById("onlyOpen");
  const greyClosed = document.getElementById("greyClosed");
  const menuButton = document.getElementById("menuButton");
  const panel = document.getElementById("panel");
  const searchBtn = document.getElementById("searchBtn");
  const addressInput = document.getElementById("address");
  const pinBtn = document.getElementById("pinBtn");
  const searchAreaBtn = document.getElementById("searchAreaBtn");

  let map, userLocation, markersLayer, userMarker, allPlaces = [];
  let lastCenter = null, lastZoom = null, lastSearchTime = 0;
  let isRendering = false;

  // Estado
  onlyOpen.checked = localStorage.getItem('onlyOpen') === 'true';
  greyClosed.checked = localStorage.getItem('greyClosed') !== 'false';

  // ==================== LISTENERS ====================
  onlyOpen.onchange = () => { localStorage.setItem('onlyOpen', onlyOpen.checked); render(); };
  greyClosed.onchange = () => { localStorage.setItem('greyClosed', greyClosed.checked); render(); };
  menuButton.onclick = () => panel.classList.toggle('active');
  searchBtn.onclick = buscarDireccion;
  addressInput.onkeypress = e => { if (e.key === 'Enter') buscarDireccion(); };
  pinBtn.onclick = () => userLocation && map && map.setView([userLocation.lat, userLocation.lon], 16);
  searchAreaBtn.onclick = () => buscarDatos(true);
  retryBtn.onclick = () => { overlay.style.display = 'none'; iniciarGeolocalizacion(); };

  // ==================== UTILIDADES (sin cambios) ====================
  function getDefaultName(tags) { /* tu funci√≥n original */ }
  function vendeVapers(tags) { /* tu funci√≥n original */ }
  function distanceBetween(lat1, lon1, lat2, lon2) { /* tu funci√≥n original */ }
  function removeDuplicates(places) { /* tu funci√≥n original */ }
  function parseOpeningHours(opening_hours) { /* tu funci√≥n original */ }

  // ==================== GEOLOCALIZACI√ìN ====================
  function iniciarGeolocalizacion() {
    overlay.style.display = 'flex';
    overlayText.textContent = 'Obteniendo ubicaci√≥n...';
    retryBtn.style.display = 'none';

    navigator.geolocation.getCurrentPosition(
      pos => iniciarMapa(pos.coords.latitude, pos.coords.longitude),
      err => {
        overlayText.textContent = err.code === 1 ? "Permiso denegado" : "Error de ubicaci√≥n";
        retryBtn.style.display = 'block';
      },
      { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 }
    );
  }

  // ==================== INICIAR MAPA ====================
  function iniciarMapa(lat, lon) {
    userLocation = { lat, lon };
    document.getElementById("map").style.display = "block";

    map = L.map('map', { zoomControl: false }).setView([lat, lon], 15);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    markersLayer = L.markerClusterGroup({ maxClusterRadius: 80 }).addTo(map);

    userMarker = L.circleMarker([lat, lon], { radius: 10, color: "white", fillColor: "#667eea", fillOpacity: 0.9, weight: 4 }).addTo(map);

    map.on('moveend zoomend', () => {
      if (Date.now() - lastSearchTime < 7000) return;
      lastSearchTime = Date.now();
      buscarDatos(false);
    });

    buscarDatos(true);   // ‚Üê primera b√∫squeda con overlay
  }

  // ==================== BUSCAR DATOS (bbox + timeout) ====================
  async function buscarDatos(showOverlay = false) {
    if (!map) return;
    if (showOverlay) {
      overlay.style.display = 'flex';
      overlayText.textContent = 'Buscando estancos y kioscos...';
    }

    try {
      const b = map.getBounds();
      const bbox = `${b.getSouth().toFixed(5)},${b.getWest().toFixed(5)},${b.getNorth().toFixed(5)},${b.getEast().toFixed(5)}`;

      const query = `[out:json][timeout:14][bbox:${bbox}];
      (
        nwr["shop"~"tobacco|kiosk|newsagent|vape|e-cigarette|convenience|supermarket"](bbox);
        nwr["amenity"~"kiosk|fuel"](bbox);
      );
      out center;`;

      const ctrl = new AbortController();
      setTimeout(() => ctrl.abort(), 14000);

      const res = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: "data=" + encodeURIComponent(query),
        signal: ctrl.signal,
        headers: { "Content-Type": "application/x-www-form-urlencoded" }
      });

      if (!res.ok) throw new Error("Overpass error");

      const data = await res.json();
      allPlaces = removeDuplicates((data.elements || []).map(el => ({
        lat: el.lat ?? el.center?.lat,
        lon: el.lon ?? el.center?.lon,
        tags: el.tags || {},
        name: el.tags?.name
      })).filter(p => p.lat && p.lon));

      render();
    } catch (e) {
      console.error(e);
      if (showOverlay) {
        overlayText.textContent = "No se pudieron cargar los puntos\nPrueba mover el mapa";
        retryBtn.style.display = "block";
      }
    } finally {
      if (showOverlay) setTimeout(() => overlay.style.display = 'none', 900);
    }
  }

  // ==================== RENDER (COMPLETO y corregido) ====================
  function render() {
    if (isRendering || !markersLayer) return;
    isRendering = true;
    markersLayer.clearLayers();

    const showOnlyOpen = onlyOpen.checked;
    const greyOut = greyClosed.checked;

    allPlaces.forEach(p => {
      const horarioInfo = parseOpeningHours(p.tags?.opening_hours || "");

      if (showOnlyOpen && horarioInfo.isOpen === false) return;

      let color = "#8e8e93";
      let extraInfo = "";

      if (p.tags?.shop === "tobacco" || p.tags?.amenity === "kiosk" || p.tags?.shop === "kiosk" || p.tags?.shop === "newsagent") {
        color = "#8B4789";
        extraInfo = '<div class="extra-info">üéØ Los kioscos venden tabaco y vapers</div>';
      } else if (p.tags?.shop === "vape" || p.tags?.shop === "e-cigarette") {
        color = "#5856d6";
      } else if (p.tags?.shop === "supermarket") {
        color = "#003366";
      } else if (p.tags?.amenity === "fuel") {
        color = "#C8A2C8";
      } else if (p.tags?.shop === "convenience") {
        color = "#00CED1";
      }

      let fillOpacity = 1.0;
      let outerRing = "";

      if (horarioInfo.isOpen === true) {
        outerRing = `<circle cx="20" cy="20" r="14" fill="none" stroke="#00FF00" stroke-width="3.5" opacity="1"/>`;
      } else if ((horarioInfo.isOpen === false || horarioInfo.isOpen === null) && greyOut) {
        fillOpacity = 0.75;
      }

      const nombre = p.name || getDefaultName(p.tags);

      let queryParts = [nombre];
      if (p.tags?.["addr:street"]) queryParts.push(p.tags["addr:street"]);
      if (p.tags?.["addr:housenumber"]) queryParts.push(p.tags["addr:housenumber"]);
      if (p.tags?.["addr:city"]) queryParts.push(p.tags["addr:city"]);

      const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(queryParts.join(" ") + " " + p.lat + "," + p.lon)}`;

      const vapeText = vendeVapers(p.tags) ? '<div class="vape-info">‚úì Vende tabaco y vapers</div>' : '';

      if (p.tags?.shop === "supermarket" && horarioInfo.isOpen === null && !extraInfo) {
        extraInfo = '<div class="extra-info">‚ÑπÔ∏è Horario aprox. 9:00-21:30</div>';
      }

      const popupContent = `
        <div class="popup-container">
          <strong>${nombre}</strong><br>
          <div class="horario-info">${horarioInfo.text}</div>
          ${vapeText}
          ${extraInfo}
          <a href="${mapsUrl}" target="_blank" class="btn-maps">Abrir en Google Maps ‚Üí</a>
          <div class="source-badge">OpenStreetMap</div>
        </div>`;

      const svg = `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
        ${outerRing}
        <circle cx="20" cy="20" r="11" fill="${color}" opacity="${fillOpacity}"/>
      </svg>`;

      const icon = L.divIcon({
        html: svg,
        className: "",
        iconSize: [40, 40],
        iconAnchor: [20, 20]
      });

      const marker = L.marker([p.lat, p.lon], { icon: icon });
      marker.bindPopup(popupContent);
      markersLayer.addLayer(marker);
    });

    isRendering = false;
  }

  // ==================== INICIO ====================
  iniciarGeolocalizacion();
});
</script>
</body>
</html>
