<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VaperTracker - Estancos & Quioscos</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f5f5f7; }
#map { height: 100%; width: 100%; display: none; }

/* SPLASH SCREEN */
#splash {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    z-index: 10000;
    transition: opacity 0.5s ease;
}

#splash.hidden {
    opacity: 0;
    pointer-events: none;
}

.splash-logo {
    width: 120px; height: 120px;
    background: white; border-radius: 28px;
    display: flex; align-items: center; justify-content: center;
    font-size: 48px; margin-bottom: 24px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.splash-title {
    font-size: 42px; font-weight: 800;
    color: white; margin-bottom: 12px;
    letter-spacing: -1px;
}

.splash-subtitle {
    font-size: 16px; color: rgba(255,255,255,0.9);
    font-weight: 500; margin-bottom: 30px;
}

.splash-spinner {
    width: 40px; height: 40px;
    border: 4px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

#overlay {
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:white; display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    z-index:5000; font-size:18px; text-align:center;
    padding:20px; gap:20px;
}
#overlay button {
    padding:12px 24px; border:none;
    background:#667eea; color:white;
    border-radius:12px; cursor:pointer; font-weight:600;
}

#menuButton {
    position:fixed; top:15px; left:15px; z-index:2000;
    background:rgba(255,255,255,0.9); border:none;
    padding:12px; border-radius:14px;
    box-shadow:0 4px 15px rgba(0,0,0,0.1);
    cursor:pointer; backdrop-filter:blur(5px);
}

#panel {
    position:fixed; top:0; left:-320px; width:300px; height:100%;
    background:white; z-index:2100; padding:25px;
    box-shadow:4px 0 20px rgba(0,0,0,0.1);
    transition:.3s cubic-bezier(0.4,0,0.2,1); overflow:auto;
}
#panel.active { left:0; }

.search-bar {
    position:absolute; top:15px; left:50%; transform:translateX(-50%);
    z-index:1500; display:flex; background:rgba(255,255,255,0.95);
    border-radius:18px; box-shadow:0 8px 24px rgba(0,0,0,0.12);
    overflow:hidden; width:85%; max-width:420px;
    backdrop-filter:blur(10px); border:1px solid rgba(0,0,0,0.05);
}
.search-bar input {
    flex:1; padding:14px; border:none; outline:none;
    font-size:16px; background:transparent;
}
.search-bar button {
    padding:14px 20px; border:none;
    background:#667eea; color:white; cursor:pointer;
}

.btn-pin {
    position:absolute; bottom:100px; right:20px;
    width:55px; height:55px; background:white;
    border-radius:50%; display:flex; align-items:center; justify-content:center;
    font-size:28px; color:#c00; border:none; cursor:pointer;
    z-index:1500; box-shadow:0 6px 16px rgba(0,0,0,0.15);
}

.btn-search-area {
    position:absolute; bottom:30px; right:20px;
    background:#667eea; color:white; border:none;
    padding:14px 22px; border-radius:25px; cursor:pointer;
    z-index:1500; font-weight:700;
    box-shadow:0 6px 20px rgba(102,126,234,0.4);
}

.popup-container { text-align:center; min-width:240px; padding:8px; }
.btn-maps {
    display:block; background:#667eea; color:white !important;
    text-align:center; padding:12px; border-radius:12px;
    text-decoration:none !important; margin-top:12px;
    font-weight:600; font-size:14px;
}
.horario-info {
    font-size:12px; color:#636366; display:block;
    margin-top:8px; line-height:1.4;
    border-top:1px solid #f2f2f7; padding-top:8px;
}
.vape-info { font-size:13px; font-weight:600; margin-top:6px; color:#34c759; }
.extra-info { font-size:12px; color:#667eea; margin-top:6px; line-height:1.3; }
.source-badge {
    display:inline-block; padding:3px 8px; border-radius:8px;
    font-size:10px; font-weight:600; margin-top:6px;
    background:#f2f2f7; color:#636366;
}
</style>
</head>
<body>

<!-- SPLASH SCREEN -->
<div id="splash">
  <div class="splash-logo">üí®</div>
  <div class="splash-title">VaperTracker</div>
  <div class="splash-subtitle">Encuentra estancos y quioscos cerca</div>
  <div class="splash-spinner"></div>
</div>

<div id="overlay" style="display:none;">
  <div id="overlayText">Localizando...</div>
  <button id="retryBtn" style="display:none;">Reintentar</button>
</div>

<button id="menuButton">‚ò∞</button>

<div id="panel">
  <h3 style="font-weight:700; margin-bottom:20px">‚öôÔ∏è Ajustes</h3>
  
  <label style="cursor:pointer; display:block; margin-bottom:12px">
    <input type="checkbox" id="onlyOpen"> Solo abiertos ahora
  </label>
  
  <label style="cursor:pointer; display:block; margin-bottom:20px">
    <input type="checkbox" id="greyClosed" checked> Atenuar cerrados
  </label>
  
  <div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-top:15px;">
    <strong style="font-size:13px">üéØ Estancos y Quioscos</strong>
    <small style="color:#666; font-size:11px; line-height:1.6; display:block; margin-top:8px;">
      B√∫squeda r√°pida de puntos de venta de tabaco y vapers cerca de ti.
    </small>
  </div>
</div>

<div class="search-bar">
  <input type="text" id="address" placeholder="Ciudad, calle o c√≥digo postal">
  <button id="searchBtn">üîç</button>
</div>

<button class="btn-pin" id="pinBtn">üìå</button>
<button class="btn-search-area" id="searchAreaBtn">BUSCAR AQU√ç</button>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const splash = document.getElementById("splash");
    const overlay = document.getElementById("overlay");
    const overlayText = document.getElementById("overlayText");
    const retryBtn = document.getElementById("retryBtn");
    const onlyOpen = document.getElementById("onlyOpen");
    const greyClosed = document.getElementById("greyClosed");
    const menuButton = document.getElementById("menuButton");
    const panel = document.getElementById("panel");
    const searchBtn = document.getElementById("searchBtn");
    const addressInput = document.getElementById("address");
    const pinBtn = document.getElementById("pinBtn");
    const searchAreaBtn = document.getElementById("searchAreaBtn");

    let map, userLocation, markersLayer, userMarker, allPlaces = [];
    let lastCenter = null;
    let lastZoom = null;
    let lastSearchTime = 0;
    let cachedData = null;
    let cachedCenter = null;
    let cachedRadius = 0;
    let isRendering = false;

    // Cargar estado
    onlyOpen.checked = localStorage.getItem('onlyOpen') === 'true';
    greyClosed.checked = localStorage.getItem('greyClosed') !== 'false';

    // Listeners
    onlyOpen.onchange = () => {
        localStorage.setItem('onlyOpen', onlyOpen.checked);
        renderMarkers();
    };

    greyClosed.onchange = () => {
        localStorage.setItem('greyClosed', greyClosed.checked);
        renderMarkers();
    };

    menuButton.onclick = () => panel.classList.toggle('active');

    searchBtn.onclick = buscarDireccion;
    addressInput.onkeypress = (e) => { if (e.key === 'Enter') buscarDireccion(); };

    pinBtn.onclick = () => {
        if (userLocation && map) {
            map.setView([userLocation.lat, userLocation.lon], 16);
        }
    };

    searchAreaBtn.onclick = () => buscarDatos(true);

    /* ---------- UTILIDADES ---------- */

    function getDefaultName(tags) {
        if (tags?.shop === "tobacco") return "Estanco";
        if (tags?.shop === "supermarket") return "Supermercado";
        if (tags?.amenity === "fuel") return "Gasolinera";
        if (tags?.shop === "convenience") return "Tienda 24h / Conveniencia";
        if (tags?.shop === "vape" || tags?.shop === "e-cigarette") return "Tienda de vapeo";
        if (tags?.amenity === "kiosk" || tags?.shop === "kiosk" || tags?.shop === "newsagent") return "Kiosco";
        return "Punto de venta";
    }

    function vendeVapers(tags) {
        if (!tags) return false;
        return tags.shop === 'vape' || tags.shop === 'e-cigarette' ||
               tags.shop === 'tobacco' ||
               tags.shop === 'convenience' ||
               tags.shop === 'kiosk' || tags.shop === 'newsagent' ||
               tags.amenity === 'kiosk' || tags.amenity === 'fuel' ||
               tags.shop === 'supermarket';
    }

    function distanceBetween(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const œÜ1 = lat1 * Math.PI/180;
        const œÜ2 = lat2 * Math.PI/180;
        const ŒîœÜ = (lat2-lat1) * Math.PI/180;
        const ŒîŒª = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2)**2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function removeDuplicates(places) {
        const unique = [];
        const threshold = 60; // metros
        
        for (const place of places) {
            const isDuplicate = unique.some(ex => 
                distanceBetween(place.lat, place.lon, ex.lat, ex.lon) < threshold
            );
            if (!isDuplicate) unique.push(place);
        }
        return unique;
    }

    function parseOpeningHours(opening_hours) {
        if (!opening_hours) return { isOpen: null, text: "Horario desconocido" };
        if (opening_hours === "24/7") return { isOpen: true, text: "Abierto 24h" };

        const now = new Date();
        const dayOfWeek = now.getDay(); // 0=domingo, 1=lunes...
        const minutesNow = now.getHours() * 60 + now.getMinutes();

        let isOpen = null;
        let text = opening_hours
            .replace(/Mo/g,'Lun').replace(/Tu/g,'Mar').replace(/We/g,'Mi√©')
            .replace(/Th/g,'Jue').replace(/Fr/g,'Vie').replace(/Sa/g,'S√°b')
            .replace(/Su/g,'Dom').replace(/;/g, '<br>');

        // Muy b√°sico ‚Äî solo reconoce algunos formatos comunes
        const ranges = opening_hours.split(';').map(r => r.trim());
        for (const range of ranges) {
            if (range.includes('24/7')) return { isOpen: true, text: "Abierto 24h" };
            
            // Ej: Mo-Fr 09:00-21:00
            const match = range.match(/([A-Za-z,-]+)\s*(\d{2}:\d{2})-(\d{2}:\d{2})/);
            if (match) {
                const daysPart = match[1];
                const openMin  = parseTime(match[2]);
                const closeMin = parseTime(match[3]);

                if (daysPart.includes('Mo-Fr') && dayOfWeek >= 1 && dayOfWeek <= 5) {
                    isOpen = minutesNow >= openMin && minutesNow <= closeMin;
                    break;
                }
                if (daysPart.includes('Sa') && dayOfWeek === 6) {
                    isOpen = minutesNow >= openMin && minutesNow <= closeMin;
                    break;
                }
                // etc... (se puede ampliar)
            }
        }

        return { isOpen, text };
    }

    function parseTime(str) {
        const [h, m] = str.split(':').map(Number);
        return h * 60 + m;
    }

    /* ---------- GEOLOCALIZACI√ìN ---------- */
    function iniciarGeolocalizacion() {
        if (!navigator.geolocation) {
            mostrarErrorGeo("Geolocalizaci√≥n no soportada por el navegador");
            return;
        }

        navigator.geolocation.getCurrentPosition(
            pos => {
                iniciarMapa(pos.coords.latitude, pos.coords.longitude);
            },
            err => {
                console.error("Geo error:", err);
                let msg = "No se pudo obtener la ubicaci√≥n";
                if (err.code === 1) msg = "Permiso de ubicaci√≥n denegado";
                if (err.code === 3) msg = "Tiempo de espera agotado";
                mostrarErrorGeo(msg);
            },
            { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 }
        );
    }

    function mostrarErrorGeo(texto) {
        splash.classList.add('hidden');
        overlayText.innerHTML = `‚ö†Ô∏è ${texto}<br><small>Prueba activar GPS o buscar manualmente</small>`;
        overlay.style.display = "flex";
        retryBtn.style.display = "block";
    }

    retryBtn.onclick = () => {
        overlay.style.display = 'none';
        splash.classList.remove('hidden');
        iniciarGeolocalizacion();
    };

    /* ---------- INICIAR MAPA ---------- */
    function iniciarMapa(lat, lon) {
        userLocation = { lat, lon };
        splash.classList.add('hidden');
        document.getElementById("map").style.display = "block";

        map = L.map('map', { zoomControl: false }).setView([lat, lon], 15);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            maxZoom: 19
        }).addTo(map);

        markersLayer = L.markerClusterGroup({
            maxClusterRadius: 80,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true
        }).addTo(map);

        userMarker = L.circleMarker([lat, lon], {
            radius: 10,
            color: "white",
            fillColor: "#667eea",
            fillOpacity: 0.9,
            weight: 4
        }).addTo(map);

        let debounceTimer;
        map.on('moveend zoomend', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const now = Date.now();
                if (now - lastSearchTime < 6000) return;

                const center = map.getCenter();
                const zoom = map.getZoom();

                const distanceMoved = lastCenter ? center.distanceTo(lastCenter) : 10000;
                const zoomChanged = Math.abs(zoom - (lastZoom || 0)) >= 1;

                if (distanceMoved > 700 || zoomChanged) {
                    lastCenter = center;
                    lastZoom = zoom;
                    lastSearchTime = now;
                    buscarDatos(false);
                }
            }, 1800);
        });

        buscarDatos(false);
    }

    function getVisibleRadius() {
        if (!map) return 3000;
        const bounds = map.getBounds();
        const dist = map.getCenter().distanceTo(bounds.getNorthEast());
        return Math.min(dist * 1.4, 6000); // ~6 km m√°ximo
    }

    /* ---------- B√öSQUEDA ---------- */
    async function buscarDireccion() {
        const query = addressInput.value.trim();
        if (!query) return;

        overlay.style.display = 'flex';
        overlayText.textContent = 'Buscando direcci√≥n...';

        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`);
            if (!res.ok) throw new Error("Nominatim error");
            const data = await res.json();

            if (data?.length > 0) {
                const { lat, lon } = data[0];
                map ? map.setView([lat, lon], 15) : iniciarMapa(parseFloat(lat), parseFloat(lon));
                setTimeout(() => buscarDatos(true), 800);
            } else {
                overlayText.textContent = 'No se encontr√≥ la direcci√≥n';
                setTimeout(hideOverlay, 2200);
            }
        } catch (err) {
            console.error(err);
            overlayText.textContent = 'Error al buscar direcci√≥n';
            setTimeout(hideOverlay, 2200);
        }
    }

    function hideOverlay() {
        overlay.style.display = 'none';
    }

    async function buscarDatos(showOverlay = false) {
        if (!map) return;

        const center = map.getCenter();
        const radius = getVisibleRadius();

        if (showOverlay) {
            overlay.style.display = 'flex';
            overlayText.textContent = 'Buscando puntos cercanos...';
        }

        try {
            const places = await buscarOpenStreetMap(center.lat, center.lng, radius);
            allPlaces = removeDuplicates(places);

            cachedData = allPlaces;
            cachedCenter = center;
            cachedRadius = radius;

            renderMarkers();
        } catch (err) {
            console.error("Error al consultar Overpass:", err);
            overlayText.textContent = 'Error al cargar los datos\nIntenta acercar o mover el mapa';
            if (showOverlay) setTimeout(hideOverlay, 3000);
        } finally {
            if (showOverlay) setTimeout(hideOverlay, 1200);
        }
    }

    async function buscarOpenStreetMap(lat, lng, radius) {
        const query = `[out:json][timeout:25];
(
  node["shop"~"tobacco|vape|e-cigarette|convenience|kiosk|newsagent|supermarket"](around:${radius},${lat},${lng});
  way["shop"~"tobacco|vape|e-cigarette|convenience|kiosk|newsagent|supermarket"](around:${radius},${lat},${lng});
  node["amenity"~"kiosk|fuel"](around:${radius},${lat},${lng});
  way["amenity"~"kiosk|fuel"](around:${radius},${lat},${lng});
);
out center;`;

        const res = await fetch("https://overpass-api.de/api/interpreter", {
            method: "POST",
            body: "data=" + encodeURIComponent(query),
            headers: { "Content-Type": "application/x-www-form-urlencoded" }
        });

        if (!res.ok) throw new Error(`Overpass HTTP ${res.status}`);

        const data = await res.json();
        if (!data.elements) return [];

        return data.elements
            .map(el => {
                const lat = el.lat ?? el.center?.lat;
                const lon = el.lon ?? el.center?.lon;
                if (!lat || !lon) return null;
                return { lat, lon, tags: el.tags || {}, name: el.tags?.name };
            })
            .filter(Boolean);
    }

    /* ---------- RENDERIZADO ---------- */
    function renderMarkers() {
        if (isRendering || !markersLayer) return;
        isRendering = true;

        markersLayer.clearLayers();

        const showOnlyOpenNow = onlyOpen.checked;
        const greyOutClosed = greyClosed.checked;

        allPlaces.forEach(p => {
            const horario = parseOpeningHours(p.tags?.opening_hours || "");

            if (showOnlyOpenNow && horario.isOpen === false) return;

            let color = "#aaaaaa";
            let extra = "";

            if (p.tags?.shop === "tobacco" || p.tags?.shop === "kiosk" || p.tags?.shop === "newsagent" || p.tags?.amenity === "kiosk") {
                color = "#8B4789"; // p√∫rpura estanco/kiosco
            } else if (p.tags?.shop === "vape" || p.tags?.shop === "e-cigarette") {
                color = "#5856d6";
            } else if (p.tags?.shop === "supermarket") {
                color = "#1e90ff";
            } else if (p.tags?.amenity === "fuel") {
                color = "#c71585";
            } else if (p.tags?.shop === "convenience") {
                color = "#00b7eb";
            }

            let opacity = 0.95;
            let ring = "";

            if (horario.isOpen === true) {
                ring = `<circle cx="20" cy="20" r="15" fill="none" stroke="#34c759" stroke-width="4" opacity="0.9"/>`;
            } else if (horario.isOpen === false && greyOutClosed) {
                opacity = 0.55;
            }

            const nombre = p.name || getDefaultName(p.tags);
 
