<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vaper & Estanco Tracker</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<style>
html, body { height:100%; margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; background:#f5f5f7;}
#map { height:100%; width:100%; display:none; }

#overlay { 
  position:fixed; top:0; left:0; width:100%; height:100%; 
  background:white; display:flex; flex-direction:column; 
  align-items:center; justify-content:center; z-index:5000; 
  font-size:18px; gap:20px; text-align:center; padding:20px;
}
#overlay button { padding:12px 28px; border:none; background:#007aff; color:white; border-radius:14px; cursor:pointer; font-weight:600; font-size:17px;}

.custom-pin { pointer-events:none; }
.custom-pin svg { pointer-events:auto; }

.horario-info { font-size:13px; color:#636366; display:block; margin-top:10px; line-height:1.4; border-top:1px solid #e5e5ea; padding-top:10px;}
.btn-maps { display:block; background:#007aff; color:white!important; text-align:center; padding:14px; border-radius:12px; text-decoration:none!important; margin-top:14px; font-weight:600; font-size:15px;}

.leaflet-control-locate { 
  background: white !important; 
  border-radius: 50% !important; 
  box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
}
.leaflet-control-locate a { 
  width: 36px !important; height: 36px !important; 
  background-size: 22px !important;
}
</style>
</head>

<body>

<div id="overlay">
  <div id="overlayText">Localizando tu posici贸n y puntos de venta...</div>
  <button id="retryBtn" style="display:none;">Reintentar</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/opening_hours@3.5.0/opening_hours+deps.min.js"></script>

<script>
// Control de localizaci贸n personalizado (chincheta)
L.Control.Locate = L.Control.extend({
  onAdd: function(map) {
    const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control-locate');
    const link = L.DomUtil.create('a', '', container);
    link.href = '#';
    link.title = 'Centrar en mi posici贸n';
    link.innerHTML = '';
    link.style.fontSize = '22px';
    link.style.lineHeight = '36px';
    link.style.textAlign = 'center';
    link.style.display = 'block';
    
    L.DomEvent.on(link, 'click', L.DomEvent.stopPropagation)
              .on(link, 'click', L.DomEvent.preventDefault)
              .on(link, 'click', () => iniciarGeolocalizacion());
    
    return container;
  }
});

document.addEventListener("DOMContentLoaded", () => {

const overlay = document.getElementById("overlay");
const overlayText = document.getElementById("overlayText");
const retryBtn = document.getElementById("retryBtn");

let map, markersLayer, elementsData=[];

function getOpeningStatus(str){
    if(!str || str.trim()==='') return {isOpen:true, known:false};
    try{
        const oh=new opening_hours(str);
        return {isOpen:oh.isOpen(new Date()), known:true};
    }catch{
        return {isOpen:true, known:false};
    }
}

function iniciarGeolocalizacion(){
    overlay.style.display = "flex";
    overlayText.innerHTML = "Obteniendo posici贸n...";
    retryBtn.style.display="none";

    navigator.geolocation.getCurrentPosition(
        pos => iniciarMapa(pos.coords.latitude, pos.coords.longitude),
        err => {
            overlayText.innerHTML = "No se pudo acceder al GPS.<br>Act铆valo o permite la ubicaci贸n.";
            retryBtn.style.display="block";
        },
        {enableHighAccuracy:true, timeout:15000, maximumAge:0}
    );
}

retryBtn.onclick = iniciarGeolocalizacion;

function iniciarMapa(lat,lon){

    overlay.style.display="none";
    document.getElementById("map").style.display="block";

    map = L.map('map', {
        zoomControl: true
    }).setView([lat,lon],16);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{
        attribution:'漏 <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // Bot贸n de localizaci贸n (chincheta)
    new L.Control.Locate({ position: 'bottomright' }).addTo(map);

    markersLayer = L.markerClusterGroup({
        maxClusterRadius: 40
    }).addTo(map);

    // Chincheta azul del usuario
    L.circleMarker([lat,lon],{
        radius:11, color:"white", fillColor:"#007aff", fillOpacity:0.9, weight:4
    }).addTo(map);

    buscarDatos();

    // Actualizar al mover/zoom
    map.on('moveend', buscarDatos);
}

function getVisibleRadius(){
    const bounds = map.getBounds();
    return map.getCenter().distanceTo(bounds.getNorthEast()) * 1.2; // un poco m谩s amplio
}

async function buscarDatos(){

    if (!map) return;

    const c = map.getCenter();
    const radio = getVisibleRadius();

    overlayText.innerHTML = "Buscando estancos, quioscos y vaper shops...";
    overlay.style.display = "flex";

    try {
        const resp = await fetch("https://overpass-api.de/api/interpreter",{
            method:"POST",
            body: "data=" + encodeURIComponent(`[out:json][timeout:30];
            (
              node["shop"="tobacco"](around:${radio},${c.lat},${c.lng});
              node["shop"="kiosk"](around:${radio},${c.lat},${c.lng});
              node["amenity"="kiosk"](around:${radio},${c.lat},${c.lng});
              node["amenity"="fuel"](around:${radio},${c.lat},${c.lng});
              node["shop"="vape"](around:${radio},${c.lat},${c.lng});
              node["shop"="e-cigarette"](around:${radio},${c.lat},${c.lng});
              node["tobacco"="yes"](around:${radio},${c.lat},${c.lng});  // quioscos y otros que venden tabaco
            );
            out;`)
        });

        const data = await resp.json();
        elementsData = data.elements || [];
        render();
    } catch(e) {
        overlayText.innerHTML = "Error al conectar con OpenStreetMap.<br>Reintenta m谩s tarde.";
        retryBtn.style.display="block";
    } finally {
        setTimeout(() => overlay.style.display="none", 800);
    }
}

function render(){

    markersLayer.clearLayers();

    elementsData.forEach(p=>{

        const tags = p.tags || {};
        const horarioRaw = tags.opening_hours || "";
        const status = getOpeningStatus(horarioRaw);

        let color = "#8e8e93"; // gris por defecto

        if (tags.shop === "tobacco")          color = "#6e2570";   // morado estanco
        else if (tags.shop === "kiosk" || tags.amenity === "kiosk") color = "#9c27b0";
        else if (tags.amenity === "fuel")     color = "#9c27b0";
        else if (tags.shop === "vape" || tags.shop === "e-cigarette") color = "#2196f3";
        else if (tags.tobacco === "yes")      color = "#757575";   // gris oscuro para secundarios

        const isFuel = tags.amenity === "fuel";

        let ringHTML = "";
        if (isFuel || (status.known && status.isOpen)) {
            ringHTML = `
            <circle cx="20" cy="20" r="15"
                fill="none" stroke="#34c759" stroke-width="5"
                style="filter: drop-shadow(0 0 6px #34c759);"/>
            <circle cx="20" cy="20" r="15"
                fill="none" stroke="#34c759" stroke-width="5"
                style="filter: drop-shadow(0 0 10px #34c759); opacity:0.6;"/>`;
        }

        const nombre = tags.name || tags.brand || "Punto de venta";

        const horarioMostrar = horarioRaw 
            ? horarioRaw.replace(/;/g,"<br>").replace(/, */g,", ")
            : "Horario no disponible";

        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(nombre + ", " + (tags["addr:street"]||""))}`;

        const pinIcon = L.divIcon({
            className: "custom-pin",
            html: `<svg width="40" height="52" viewBox="0 0 40 52">
                ${ringHTML}
                <path d="M20 4C11.2 4 4 11.2 4 20c0 12 16 28 16 28s16-16 16-28c0-8.8-7.2-16-16-16z"
                      fill="${color}" fill-opacity="0.95"/>
                <circle cx="20" cy="20" r="8" fill="white"/>
            </svg>`,
            iconSize: [40,52],
            iconAnchor: [20,50],
            popupAnchor: [0,-46]
        });

        L.marker([p.lat, p.lon], {icon: pinIcon})
        .bindPopup(`
            <div style="min-width:220px;">
                <strong>${nombre}</strong><br>
                <span class="horario-info">
                    <b>Horario:</b><br>${horarioMostrar}
                    ${status.known ? `<br><b>Estado:</b> ${status.isOpen ? " Abierto" : " Cerrado"}` : ""}
                </span>
                <a href="${mapsUrl}" target="_blank" class="btn-maps">Abrir en Google Maps</a>
            </div>
        `)
        .addTo(markersLayer);

    });
}

iniciarGeolocalizacion();

});
</script>
</body>
</html>
