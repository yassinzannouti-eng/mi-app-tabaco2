<script>
document.addEventListener("DOMContentLoaded",()=>{

let userLocation=null;
let elementsData=[];
let markersLayer=L.layerGroup();

const map=L.map('map',{zoomControl:false});
L.control.zoom({position:'bottomright'}).addTo(map);

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
  attribution:'©OpenStreetMap ©CARTO'
}).addTo(map);

map.addLayer(markersLayer);

const userMarker=L.circleMarker([0,0],{
  radius:8,
  color:"#2563eb",
  fillColor:"#2563eb",
  fillOpacity:0.8
}).addTo(map);

const icons={
  estanco:createIcon("red"),
  supermercado:createIcon("green"),
  bazar:createIcon("violet"),
  gasolinera:createIcon("yellow"),
  grey:createIcon("grey")
};

function createIcon(color){
  return L.icon({
    iconUrl:`https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
    shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
    iconSize:[25,41],
    iconAnchor:[12,41]
  });
}

/* =========================
   GEOLOCALIZACIÓN PRIORIDAD
========================= */

function iniciarMapa(lat,lon){
  userLocation={lat,lon};
  map.setView([lat,lon],15);
  userMarker.setLatLng([lat,lon]);
  buscarDatos();
}

if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(pos=>{
    iniciarMapa(pos.coords.latitude,pos.coords.longitude);
  },()=>{
    // Ubicación estimada ligera por IP
    fetch("https://ipapi.co/json/")
    .then(r=>r.json())
    .then(data=>iniciarMapa(data.latitude,data.longitude));
  });
}

/* =========================
   FILTROS
========================= */

let filtros={
  estanco:true,
  supermercado:true,
  bazar:true,
  gasolinera:true
};

document.getElementById("toggleEstanco").onchange=e=>{filtros.estanco=e.target.checked; render();}
document.getElementById("toggleSuper").onchange=e=>{filtros.supermercado=e.target.checked; render();}
document.getElementById("toggleBazar").onchange=e=>{filtros.bazar=e.target.checked; render();}
document.getElementById("toggleGas").onchange=e=>{filtros.gasolinera=e.target.checked; render();}

/* =========================
   BUSCAR DATOS LIGERO
========================= */

async function buscarDatos(){

  const bounds=map.getBounds();
  const zoom=map.getZoom();
  const radio=zoom>=16?2000:zoom>=14?4000:6000;

  const c=map.getCenter();

  const query=`[out:json][timeout:20];
  (
    node["shop"="tobacco"](around:${radio},${c.lat},${c.lng});
    node["shop"="supermarket"](around:${radio},${c.lat},${c.lng});
    node["shop"="variety_store"](around:${radio},${c.lat},${c.lng});
    node["amenity"="fuel"](around:${radio},${c.lat},${c.lng});
  );
  out;`;

  try{
    const resp=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:query});
    const data=await resp.json();
    elementsData=data.elements||[];
    render();
  }catch(e){
    console.log("Error Overpass",e);
  }
}

/* =========================
   RENDER MARCADORES
========================= */

function render(){

  markersLayer.clearLayers();

  elementsData.forEach(p=>{

    let tipo=null;

    if(p.tags?.shop==="tobacco") tipo="estanco";
    else if(p.tags?.shop==="supermarket") tipo="supermercado";
    else if(p.tags?.shop==="variety_store") tipo="bazar";
    else if(p.tags?.amenity==="fuel") tipo="gasolinera";

    if(!tipo || !filtros[tipo]) return;

    const popupHTML=`
      <b>${p.tags?.name||tipo}</b><br>
      <a href="https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lon}" target="_blank">
      Ver en Maps</a>
    `;

    const marker=L.marker([p.lat,p.lon],{icon:icons[tipo]})
      .bindPopup(popupHTML);

    markersLayer.addLayer(marker);

  });

}

/* =========================
   BOTONES
========================= */

document.getElementById("locateBtn").onclick=()=>{
  if(userLocation) map.flyTo(userLocation,16);
};

document.getElementById("searchAreaBtn").onclick=buscarDatos;

document.getElementById("searchBtn").onclick=async()=>{
  const val=document.getElementById("address").value;
  if(!val) return;
  const resp=await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(val));
  const data=await resp.json();
  if(data.length){
    map.flyTo([data[0].lat,data[0].lon],15);
    buscarDatos();
  }
};

});
</script>
