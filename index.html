<script>

const map = L.map('map', { zoomControl:false }).setView([40.41,-3.70],6);

L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{
maxZoom:19,
attribution:'© OpenStreetMap'
}).addTo(map);

const markersLayer = L.layerGroup().addTo(map);

const iconEstanco = L.icon({
iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
iconSize:[30,50], iconAnchor:[15,50]
});

const iconTienda = L.icon({
iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
iconSize:[30,50], iconAnchor:[15,50]
});

const userMarker = L.circleMarker([0,0],{
radius:8, color:'white',
fillColor:'#2563eb', fillOpacity:1, weight:3
}).addTo(map);

// SOLO obtiene tu ubicación una vez al iniciar (sin recentrar luego)
map.locate();

map.on('locationfound', e=>{
userMarker.setLatLng(e.latlng);
});

// ================= BUSCAR DATOS =================

async function buscarDatos(lat,lng){

markersLayer.clearLayers();

const query = `
[out:json][timeout:25];
(
node["shop"="tobacco"](around:2000,${lat},${lng});
node["shop"~"convenience|variety_store|supermarket"](around:2000,${lat},${lng});
);
out;
`;

try{
const response = await fetch("https://overpass-api.de/api/interpreter",{
method:"POST",
body: query
});

if(!response.ok) throw new Error();

const data = await response.json();

data.elements.forEach(p=>{
const esEstanco = p.tags.shop==="tobacco";
const nombre = p.tags.name || (esEstanco?"ESTANCO":"TIENDA");

L.marker([p.lat,p.lon],{
icon: esEstanco?iconEstanco:iconTienda
})
.addTo(markersLayer)
.bindPopup(`
<b>${nombre}</b><br>
<a href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}" target="_blank">
Cómo llegar
</a>
`);
});

}catch(e){
alert("Servidor ocupado. Intenta en unos segundos.");
}
}

// ================= BOTÓN BUSCAR EN ESTA ÁREA =================

function buscarEnEstaArea(){
const center = map.getCenter();
buscarDatos(center.lat, center.lng);
}

// ================= BUSCAR MANUAL =================

async function buscarManual(){
const val = document.getElementById('address').value;
if(!val) return;

try{
const response = await fetch(
'https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(val)
);

const data = await response.json();

if(data.length){
const lat = parseFloat(data[0].lat);
const lon = parseFloat(data[0].lon);
map.setView([lat,lon],16);
}else{
alert("No encontrado");
}
}catch(e){
alert("Error en búsqueda");
}
}

// ================= EVENTOS =================

document.getElementById('searchButton').onclick = buscarManual;
document.getElementById('searchCenterButton').onclick = buscarEnEstaArea;
document.getElementById('locateButton').onclick = ()=>{
map.locate({setView:true, zoom:17});
};

</script>
