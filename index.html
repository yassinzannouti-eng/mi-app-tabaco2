<script>
document.addEventListener("DOMContentLoaded",()=>{

let map;
let userLocation=null;
let elementsData=[];
let markersLayer;
let userMarker;

/* INICIAR MAPA VACÍO (SIN ESPAÑA) */
map=L.map('map',{zoomControl:true});
markersLayer=L.layerGroup().addTo(map);

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
attribution:'©OpenStreetMap ©CARTO'
}).addTo(map);

/* GEOLOCALIZACIÓN PRIORITARIA PERO NO AGRESIVA */
if(navigator.geolocation){
navigator.geolocation.getCurrentPosition(
pos=>{
iniciarMapa(pos.coords.latitude,pos.coords.longitude);
},
err=>{
console.log("Ubicación no concedida");
},
{enableHighAccuracy:true,timeout:10000}
);
}

function iniciarMapa(lat,lon){

userLocation={lat,lon};

map.setView([lat,lon],15);

userMarker=L.circleMarker([lat,lon],{
radius:8,
color:"#2563eb",
fillColor:"#2563eb",
fillOpacity:0.9
}).addTo(map);

buscarDatos();
}

/* CACHE POR ZONA */
function cacheKey(){
if(!map) return null;
const c=map.getCenter();
return `${c.lat.toFixed(2)}_${c.lng.toFixed(2)}_${map.getZoom()}`;
}

async function buscarDatos(){

if(!userLocation) return;

const key=cacheKey();

if(localStorage.getItem(key)){
elementsData=JSON.parse(localStorage.getItem(key));
render();
return;
}

const zoom=map.getZoom();
const radio=zoom>=16?2000:zoom>=14?4000:6000;
const c=map.getCenter();

const query=`[out:json][timeout:20];
(
node["shop"="tobacco"](around:${radio},${c.lat},${c.lng});
node["shop"="supermarket"](around:${radio},${c.lat},${c.lng});
node["shop"="variety_store"](around:${radio},${c.lat},${c.lng});
node["amenity"="fuel"](around:${radio},${c.lat},${c.lng});
);
out;`;

try{
const resp=await fetch("https://overpass-api.de/api/interpreter",{
method:"POST",
body:query
});
const data=await resp.json();
elementsData=data.elements||[];
localStorage.setItem(key,JSON.stringify(elementsData));
render();
}catch(e){
console.log("Error Overpass",e);
}
}

/* HORARIOS */
function analizarHorario(opening){
if(!opening) return {estado:null,texto:"Horario desconocido"};
if(opening.includes("24/7")) return {estado:true,texto:"<span class='badge open'>24/7</span>"};

const now=new Date();
const min=now.getHours()*60+now.getMinutes();
const rangos=[...opening.matchAll(/(\d{2}:\d{2})-(\d{2}:\d{2})/g)];

for(let r of rangos){
const mi=parseInt(r[1].slice(0,2))*60+parseInt(r[1].slice(3));
const mf=parseInt(r[2].slice(0,2))*60+parseInt(r[2].slice(3));
if(min>=mi&&min<=mf)
return {estado:true,texto:"<span class='badge open'>Abierto</span>"};
}
return {estado:false,texto:"<span class='badge closed'>Cerrado</span>"};
}

/* RENDER */
function render(){

markersLayer.clearLayers();

elementsData.forEach(p=>{

let tipo=null;

if(p.tags?.shop==="tobacco") tipo="red";
else if(p.tags?.shop==="supermarket") tipo="green";
else if(p.tags?.shop==="variety_store") tipo="violet";
else if(p.tags?.amenity==="fuel") tipo="yellow";

if(!tipo) return;

const horario=analizarHorario(p.tags?.opening_hours);

if(onlyOpen.checked && horario.estado===false) return;

let iconColor=tipo;
if(horario.estado===false && greyClosed.checked)
iconColor="grey";

const icon=L.icon({
iconUrl:`https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${iconColor}.png`,
shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
iconSize:[25,41],
iconAnchor:[12,41]
});

const nombre=p.tags?.name||"Local";

const popup=`
<b>${nombre}</b><br>
${horario.texto}<br><br>
<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(nombre)}"
target="_blank">Cómo llegar</a>
`;

L.marker([p.lat,p.lon],{icon})
.bindPopup(popup)
.addTo(markersLayer);

});
}

/* EVENTOS */
menuButton.onclick=()=>panel.classList.toggle("active");
pinBtn.onclick=()=>{if(userLocation) map.flyTo(userLocation,16);}
searchAreaBtn.onclick=buscarDatos;

document.querySelectorAll("#filters input,#onlyOpen,#greyClosed")
.forEach(el=>el.onchange=render);

});
  </script>
