<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vaper Tracker Interactivo</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {height:100%; margin:0; font-family:'Segoe UI', sans-serif;}
#map {height:100%; width:100%; z-index:0;}

/* BUSCADOR SUPERIOR */
.search-bar {
  position: absolute; top:15px; left:50%; transform:translateX(-50%);
  z-index:1100; width:85%; max-width:400px; display:flex;
  box-shadow:0 4px 15px rgba(0,0,0,0.18); border-radius:25px;
  overflow:hidden; align-items:center; background:#fff;
}
.search-bar input {flex:1; padding:12px 15px; border:none; outline:none; font-size:14px;}
.search-bar button {
  padding:12px 15px; border:none; background:#2563eb; color:white;
  cursor:pointer; font-size:16px; transition:.2s;
}
.search-bar button:hover { background:#1e4eb8; }

/* BOTONES DE CONTROL */
.btn-locate {
  position:absolute; bottom:100px; right:20px; z-index:1100;
  width:48px; height:48px; background:#2563eb; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 3px 12px rgba(0,0,0,0.25); border:none;
  cursor:pointer; color:white; font-size:22px;
}
.btn-locate:hover { background:#1e4eb8; }

.btn-add-manual {
  position:absolute; bottom:30px; left:20px; z-index:1100;
  background:rgba(255,255,255,0.95); border:1px solid #ccc;
  padding:7px 14px; border-radius:18px; font-size:12px;
  font-weight:bold; cursor:pointer; color:#444; box-shadow:0 2px 6px rgba(0,0,0,0.12);
}

/* BOT√ìN DE B√öSQUEDA CENTRAL */
.btn-search-center {
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  z-index:1050; background:rgba(255,255,255,0.85); border:1px solid #ccc;
  padding:10px 18px; border-radius:20px; font-size:14px;
  font-weight:bold; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.1);
  display:none;
}

/* BARRA LATERAL */
#sidebar {
  position:fixed; top:0; left:-280px; width:260px; height:100%; background:white;
  box-shadow:2px 0 15px rgba(0,0,0,0.2); transition:left 0.3s ease; z-index:2000;
  padding:20px; font-size:14px; overflow-y:auto;
}
#sidebar.active { left:0; }
.sidebar-header { font-size:20px; font-weight:bold; margin-bottom:15px; cursor:pointer; }
.section { margin-top:15px; }
.section h4 { cursor:pointer; user-select:none; margin-bottom:5px; display:flex; justify-content:space-between; }
.section-content { display:block; padding-left:5px; }

/* Leyenda interactiva */
.legend { display:flex; flex-direction:column; margin-top:10px; }
.legend-item { display:flex; align-items:center; margin-bottom:5px; }
.legend-color { width:15px; height:15px; border-radius:4px; margin-right:6px; }

/* BOT√ìN MENU */
#menuButton {
  position:fixed; top:15px; left:15px; z-index:2100; background:white;
  border:none; padding:10px 12px; border-radius:8px; box-shadow:0 3px 8px rgba(0,0,0,0.2);
  cursor:pointer; font-size:18px;
}
</style>
</head>
<body>

<!-- Sidebar -->
<div id="sidebar">
  <div class="sidebar-header">‚ò∞ Men√∫</div>
  <div class="section">
    <h4>Soporte</h4>
    <div class="section-content"><p>Contacto y ayuda</p></div>
  </div>
  <div class="section">
    <h4>Preguntas frecuentes</h4>
    <div class="section-content"><p>C√≥mo funciona la app</p></div>
  </div>
  <div class="section">
    <h4>Ajustes</h4>
    <div class="section-content">
      <label><input type="checkbox" id="toggleAutoSearch" checked> Buscar autom√°ticamente al mover mapa</label>
    </div>
  </div>
  <div class="section">
    <h4>Tipos de Locales</h4>
    <div class="section-content legend">
      <label class="legend-item"><input type="checkbox" id="toggleEstanco" checked>
        <div class="legend-color" style="background:red;"></div>Estanco</label>
      <label class="legend-item"><input type="checkbox" id="toggleTienda" checked>
        <div class="legend-color" style="background:gold;"></div>Tienda/Bazar</label>
      <label class="legend-item"><input type="checkbox" id="toggleSuper" checked>
        <div class="legend-color" style="background:green;"></div>Supermercado</label>
    </div>
  </div>
</div>
<button id="menuButton">‚ò∞</button>

<!-- Buscador -->
<div class="search-bar">
  <input type="text" id="address" placeholder="Buscar zona o ciudad...">
  <button id="searchButton">üîç</button>
</div>

<!-- Botones -->
<div class="btn-locate" id="locateButton">üìç</div>
<button class="btn-add-manual" id="addButton">‚ûï Guardar coordenada</button>
<button class="btn-search-center" id="searchCenterButton">BUSCAR AQU√ç</button>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener("DOMContentLoaded",()=>{

// ===== MAPA =====
const map=L.map('map',{zoomControl:false}).setView([40.41,-3.70],6);
L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png',{maxZoom:20,attribution:'¬© OpenStreetMap'}).addTo(map);

const markersLayer=L.layerGroup().addTo(map);
const searchBtn=document.getElementById("searchCenterButton");

// ===== ICONOS =====
const iconEstanco=L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41]});
const iconTienda=L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41]});
const iconSuper=L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41]});

// ===== USUARIO =====
let userLatLng=null;
const userMarker=L.circleMarker([0,0],{radius:8,color:"#fff",weight:3,fillColor:"#2563eb",fillOpacity:1}).addTo(map);
map.locate({enableHighAccuracy:true});
map.on('locationfound', e=>{ userLatLng=e.latlng; userMarker.setLatLng(userLatLng); });

// ===== CACHE Y FILTRO =====
const cache=new Map(); let lastKey=null;
function calcularRadio(){const z=map.getZoom(); if(z>=17)return 800;if(z>=15)return 1500;if(z>=13)return 3000;if(z>=11)return 6000;return 10000;}
function generarKey(){const c=map.getCenter(); return `${c.lat.toFixed(2)}_${c.lng.toFixed(2)}_${map.getZoom()}`;}

let filter={estanco:true,tienda:true,super:true};

// ===== BUSCAR DATOS =====
async function buscarDatos(){
const key=generarKey(); if(key===lastKey) return; lastKey=key;
markersLayer.clearLayers(); if(searchBtn) searchBtn.style.display="none";

if(cache.has(key)){ pintar(cache.get(key)); return; }

const c=map.getCenter(), r=calcularRadio();
const query=`[out:json][timeout:25];(
node["shop"="tobacco"](around:${r},${c.lat},${c.lng});
node["shop"~"convenience|variety_store|supermarket"](around:${r},${c.lat},${c.lng});
node["shop"="general"]["name"~"bazar|asian|chino|tienda|vaper"](around:${r},${c.lat},${c.lng});
);out;`;

try{
const resp=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:query});
if(!resp.ok) throw new Error();
const data=await resp.json();
cache.set(key,data.elements||[]);
pintar(data.elements||[]);
}catch{ console.log("Overpass ocupado"); }
}

function pintar(elements){
elements.forEach(p=>{
if(!p.lat||!p.lon) return;
let icon,tipo,visible=false;
if(p.tags?.shop==="tobacco"){ icon=iconEstanco; tipo="Estanco"; visible=filter.estanco; }
else if(p.tags?.shop==="supermarket"){ icon=iconSuper; tipo="Supermercado"; visible=filter.super; }
else{ icon=iconTienda; tipo="Tienda/Bazar"; visible=filter.tienda; }

if(!visible) return;

let hora=p.tags?.opening_hours||"Horario desconocido";
let nombre=p.tags?.name||tipo;
L.marker([p.lat,p.lon],{icon})
.addTo(markersLayer)
.bindPopup(`<b>${nombre}</b><br>
<p>${hora}</p>
<a href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}" target="_blank">C√≥mo llegar</a>`);
});
}

// ===== BUSCADOR MANUAL =====
document.getElementById('searchButton').onclick=async()=>{
const val=document.getElementById('address').value.trim(); if(!val) return;
try{
const resp=await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(val));
const data=await resp.json();
if(data.length) map.flyTo([data[0].lat,data[0].lon],15,{duration:1});
}catch{}
};

// ===== MOVIMIENTO INTELIGENTE =====
let moveTimer;
map.on("movestart", ()=>{ if(searchBtn) searchBtn.style.display="block"; });
map.on("moveend", ()=>{
clearTimeout(moveTimer);
if(document.getElementById("toggleAutoSearch")?.checked)
moveTimer=setTimeout(buscarDatos,900);
});
if(searchBtn) searchBtn.onclick=buscarDatos;

// ===== BARRA LATERAL =====
const sidebar=document.getElementById("sidebar");
document.getElementById("menuButton").onclick=()=>{ sidebar.classList.toggle("active"); };

// ===== SECCIONES COLAPSABLES =====
document.querySelectorAll('.section h4').forEach(h=>{
h.onclick=()=>{ const content=h.nextElementSibling; content.style.display=(content.style.display==="none")?"block":"none"; };
});

// ===== FILTRO LEYENDA =====
document.getElementById("toggleEstanco").onchange=e=>{ filter.estanco=e.target.checked; buscarDatos(); };
document.getElementById("toggleTienda").onchange=e=>{ filter.tienda=e.target.checked; buscarDatos(); };
document.getElementById("toggleSuper").onchange=e=>{ filter.super=e.target.checked; buscarDatos(); };

// ===== BOT√ìN GUARDAR COORDENADA =====
document.getElementById('addButton').onclick=()=>{
const c=map.getCenter();
alert("Coordenada guardada: "+c.lat.toFixed(6)+", "+c.lng.toFixed(6));
};

// ===== BOT√ìN CENTRAR USUARIO =====
document.getElementById("locateButton").onclick=()=>{ if(userLatLng) map.flyTo(userLatLng,16,{duration:1}); };

// ===== PRIMERA B√öSQUEDA =====
setTimeout(buscarDatos,1500);

});
</script>
</body>
</html>
