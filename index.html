<script>
document.addEventListener("DOMContentLoaded",()=>{

const map=L.map('map').setView([40.41,-3.70],6);

L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{
attribution:'Â©OpenStreetMap Â©CARTO'
}).addTo(map);

let userLocation=null;
let currentElements=[];
const cluster=L.markerClusterGroup();
map.addLayer(cluster);

map.locate({enableHighAccuracy:true});
map.on('locationfound',e=>{userLocation=e.latlng;});

function icon(color){
return L.icon({
iconUrl:`https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
iconSize:[25,41],iconAnchor:[12,41]
});
}

const icons={
normal:icon("red"),
closed:icon("grey")
};

function distanciaKm(a,b,c,d){
function r(x){return x*Math.PI/180;}
const R=6371;
const dLat=r(c-a);
const dLon=r(d-b);
const h=Math.sin(dLat/2)**2+
Math.cos(r(a))*Math.cos(r(c))*
Math.sin(dLon/2)**2;
return R*2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));
}

function analizarHorario(opening){
if(!opening)return {estado:null,texto:"âš ï¸ Sin horario registrado"};

if(opening.includes("24/7"))
return {estado:true,texto:"ðŸŸ¢ Abierto 24/7"};

const ahora=new Date();
const min=ahora.getHours()*60+ahora.getMinutes();
const rangos=[...opening.matchAll(/(\d{2}:\d{2})-(\d{2}:\d{2})/g)];

for(let r of rangos){
const ini=r[1].split(":");
const fin=r[2].split(":");
const mi=parseInt(ini[0])*60+parseInt(ini[1]);
const mf=parseInt(fin[0])*60+parseInt(fin[1]);

if(min>=mi&&min<=mf){
return {estado:true,texto:"ðŸŸ¢ Abierto ahora"};
}
}

return {estado:false,texto:"ðŸ”´ Cerrado ahora"};
}

async function buscar(){
const c=map.getCenter();
const r=6000;

const query=`[out:json];
(node["shop"="tobacco"](around:${r},${c.lat},${c.lng}););out;`;

const resp=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:query});
const data=await resp.json();

currentElements=data.elements||[];
render();
}

function render(){

cluster.clearLayers();

let lista=[...currentElements];

const onlyOpen=document.getElementById("toggleOnlyOpen").checked;
const greyClosed=document.getElementById("toggleGreyClosed").checked;
const searchText=document.getElementById("internalSearch").value.toLowerCase();

if(searchText){
lista=lista.filter(p=>p.tags?.name?.toLowerCase().includes(searchText));
}

lista=lista.map(p=>{
const horario=analizarHorario(p.tags?.opening_hours);
let dist=null;
if(userLocation){
dist=distanciaKm(userLocation.lat,userLocation.lng,p.lat,p.lon);
}
return {...p,horario,dist};
});

lista.sort((a,b)=>{
if(a.horario.estado===true && b.horario.estado!==true) return -1;
if(a.horario.estado!==true && b.horario.estado===true) return 1;
return (a.dist||999)-(b.dist||999);
});

lista.forEach(p=>{

if(onlyOpen && p.horario.estado===false) return;

let icono=icons.normal;
if(p.horario.estado===false && greyClosed) icono=icons.closed;

const marker=L.marker([p.lat,p.lon],{icon:icono});

marker.bindPopup(`
<b>${p.tags?.name||"Estanco"}</b><br>
${p.horario.texto}
${p.dist?`<div style="font-size:12px;color:#555;">${p.dist.toFixed(2)} km</div>`:""}
<br><br>
<a href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}" target="_blank">CÃ³mo llegar</a>
`);

cluster.addLayer(marker);

});

}

document.getElementById("internalSearch").oninput=render;
document.getElementById("toggleOnlyOpen").onchange=render;
document.getElementById("toggleGreyClosed").onchange=render;

map.on("moveend",buscar);

setTimeout(buscar,1500);

});
</script>
