<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vaper Tracker Pro</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f5f5f7; }
#map { height: 100%; width: 100%; display: none; }

#overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:5000; font-size:18px; text-align:center; padding:20px; gap:20px; }
#overlay button { padding:12px 24px; border:none; background:#007aff; color:white; border-radius:12px; cursor:pointer; font-weight:600; }

#menuButton { position:fixed; top:15px; left:15px; z-index:2000; background:rgba(255,255,255,0.9); border:none; padding:12px; border-radius:14px; box-shadow:0 4px 15px rgba(0,0,0,0.1); cursor:pointer; backdrop-filter:blur(5px); }
#panel { position:fixed; top:0; left:-280px; width:260px; height:100%; background:white; z-index:2100; padding:25px; box-shadow:4px 0 20px rgba(0,0,0,0.1); transition:.3s cubic-bezier(0.4,0,0.2,1); overflow:auto; }
#panel.active { left:0; }

.search-bar { position:absolute; top:15px; left:50%; transform:translateX(-50%); z-index:1500; display:flex; background:rgba(255,255,255,0.95); border-radius:18px; box-shadow:0 8px 24px rgba(0,0,0,0.12); overflow:hidden; width:85%; max-width:420px; backdrop-filter:blur(10px); border:1px solid rgba(0,0,0,0.05); }
.search-bar input { flex:1; padding:14px; border:none; outline:none; font-size:16px; background:transparent; }
.search-bar button { padding:14px 20px; border:none; background:#007aff; color:white; cursor:pointer; }

.btn-pin { position:absolute; bottom:100px; right:20px; width:55px; height:55px; background:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:28px; color:#c00; border:none; cursor:pointer; z-index:1500; box-shadow:0 6px 16px rgba(0,0,0,0.15); }
.btn-search-area { position:absolute; bottom:30px; right:20px; background:#007aff; color:white; border:none; padding:14px 22px; border-radius:25px; cursor:pointer; z-index:1500; font-weight:700; box-shadow:0 6px 20px rgba(0,122,255,0.3); }

.popup-container { text-align:center; min-width:240px; padding:8px; }
.btn-maps { display:block; background:#007aff; color:white !important; text-align:center; padding:12px; border-radius:12px; text-decoration:none !important; margin-top:12px; font-weight:600; font-size:14px; }
.horario-info { font-size:12px; color:#636366; display:block; margin-top:8px; line-height:1.4; border-top:1px solid #f2f2f7; padding-top:8px; }
.vape-info { font-size:13px; font-weight:600; margin-top:6px; color:#34c759; }
.extra-info { font-size:12px; color:#007aff; margin-top:6px; line-height:1.3; }
</style>
</head>
<body>

<div id="overlay">
  <div id="overlayText">Localizando puntos de venta...</div>
  <button id="retryBtn" style="display:none;">Reintentar acceso</button>
</div>

<button id="menuButton">‚ò∞</button>

<div id="panel">
  <h3 style="font-weight:700">Ajustes</h3>
  <label style="cursor:pointer"><input type="checkbox" id="onlyOpen"> Solo abiertos ahora</label><br><br>
  <label style="cursor:pointer"><input type="checkbox" id="greyClosed" checked> Atenuar cerrados / desconocidos</label>
  
  <hr style="margin:20px 0">
  <strong>Estancos Oficiales</strong><br>
  <a href="https://serviciostelematicosext.hacienda.gob.es/CMT/Visor/csvExpendedurias.aspx" target="_blank" style="color:#007aff; display:block; margin:8px 0;">Descargar lista completa (CSV)</a>
  <a href="https://serviciostelematicosext.hacienda.gob.es/CMT/Visor/visor.aspx" target="_blank" style="color:#007aff; display:block;">Ver mapa oficial del Comisionado</a>
</div>

<div class="search-bar">
  <input type="text" id="address" placeholder="Ciudad, calle o c√≥digo postal">
  <button id="searchBtn">üîç</button>
</div>

<button class="btn-pin" id="pinBtn">üìå</button>
<button class="btn-search-area" id="searchAreaBtn">BUSCAR EN ESTA √ÅREA</button>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/opening_hours@3.5.0/opening_hours+deps.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const overlay = document.getElementById("overlay");
  const overlayText = document.getElementById("overlayText");
  const retryBtn = document.getElementById("retryBtn");
  const onlyOpen = document.getElementById("onlyOpen");
  const greyClosed = document.getElementById("greyClosed");
  const menuButton = document.getElementById("menuButton");
  const panel = document.getElementById("panel");
  const searchBtn = document.getElementById("searchBtn");
  const addressInput = document.getElementById("address");
  const pinBtn = document.getElementById("pinBtn");
  const searchAreaBtn = document.getElementById("searchAreaBtn");

  let map, userLocation, markersLayer, userMarker, elementsData = [];
  let lastCenter = null, lastZoom = null, lastSearchTime = 0;
  let isRendering = false;

  // Estado
  onlyOpen.checked = localStorage.getItem('onlyOpen') === 'true';
  greyClosed.checked = localStorage.getItem('greyClosed') !== 'false';

  // Utilidades (mantengo las tuyas)
  function getDefaultName(tags) { /* tu funci√≥n */ }
  function vendeVapers(tags) { /* tu funci√≥n */ }
  function getOpeningStatus(opening_hours_str, tags) { /* tu funci√≥n con opening_hours lib */ }
  function traducirHorario(txt) { /* tu funci√≥n */ }

  // Geolocalizaci√≥n
  function iniciarGeolocalizacion() {
    overlay.style.display = 'flex';
    overlayText.textContent = 'Obteniendo ubicaci√≥n...';
    retryBtn.style.display = 'none';

    navigator.geolocation.getCurrentPosition(
      pos => iniciarMapa(pos.coords.latitude, pos.coords.longitude),
      () => {
        overlayText.textContent = "GPS desactivado o denegado";
        retryBtn.style.display = "block";
      },
      { enableHighAccuracy: true, timeout: 12000 }
    );
  }
  retryBtn.onclick = iniciarGeolocalizacion;

  // Iniciar mapa
  function iniciarMapa(lat, lon) {
    userLocation = { lat, lon };
    overlay.style.display = "none";
    document.getElementById("map").style.display = "block";

    map = L.map('map', { zoomControl: false }).setView([lat, lon], 15);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    markersLayer = L.markerClusterGroup({ maxClusterRadius: 70 }).addTo(map);

    userMarker = L.circleMarker([lat, lon], {
      radius: 10, color: "white", fillColor: "#007aff", fillOpacity: 0.9, weight: 4
    }).addTo(map);

    map.on('moveend zoomend', () => {
      if (Date.now() - lastSearchTime < 7000) return;
      lastSearchTime = Date.now();
      buscarDatos(false);
    });

    buscarDatos(true);   // primera b√∫squeda visible
  }

  // B√∫squeda Overpass (CORREGIDA: usa nwr + bbox + out center)
  async function buscarDatos(showOverlay = false) {
    if (!map) return;
    if (showOverlay) {
      overlay.style.display = 'flex';
      overlayText.textContent = 'Buscando estancos, kioscos y vapers...';
    }

    try {
      const b = map.getBounds();
      const bbox = `${b.getSouth().toFixed(5)},${b.getWest().toFixed(5)},${b.getNorth().toFixed(5)},${b.getEast().toFixed(5)}`;

      const query = `[out:json][timeout:18][bbox:${bbox}];
      (
        nwr["shop"~"tobacco|kiosk|newsagent|vape|e-cigarette|convenience|supermarket"](bbox);
        nwr["amenity"~"kiosk|fuel"](bbox);
      );
      out center;`;

      const res = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: "data=" + encodeURIComponent(query),
        headers: { "Content-Type": "application/x-www-form-urlencoded" }
      });

      if (!res.ok) throw new Error("Overpass error");

      const data = await res.json();
      elementsData = data.elements || [];

      render();
    } catch (e) {
      console.error(e);
      if (showOverlay) overlayText.textContent = 'Error al cargar datos';
    } finally {
      if (showOverlay) setTimeout(() => overlay.style.display = 'none', 800);
    }
  }

  // Render (corregido y completo)
  function render() {
    if (isRendering) return;
    isRendering = true;
    markersLayer.clearLayers();

    const showOnlyOpen = onlyOpen.checked;
    const greyOut = greyClosed.checked;

    elementsData.forEach(el => {
      const lat = el.lat || el.center?.lat;
      const lon = el.lon || el.center?.lon;
      if (!lat || !lon) return;

      const status = getOpeningStatus(el.tags?.opening_hours, el.tags);

      if (showOnlyOpen && status.known && !status.isOpen) return;

      let color = "#8e8e93";
      let extraInfo = "";

      if (el.tags?.shop === "tobacco" || el.tags?.amenity === "kiosk" || el.tags?.shop === "kiosk" || el.tags?.shop === "newsagent") {
        color = "#8B4789";
        extraInfo = '<div class="extra-info">Kiosco / Estanco</div>';
      } else if (el.tags?.shop === "vape" || el.tags?.shop === "e-cigarette") {
        color = "#5856d6";
      } else if (el.tags?.shop === "supermarket") color = "#003366";
      else if (el.tags?.amenity === "fuel") color = "#C8A2C8";
      else if (el.tags?.shop === "convenience") color = "#00CED1";

      let fillOpacity = (status.known && status.isOpen) ? 1.0 : (greyOut ? 0.75 : 1.0);
      let outerRing = (status.known && status.isOpen) ? `<circle cx="20" cy="20" r="14" fill="none" stroke="#00FF00" stroke-width="3.5" opacity="1"/>` : "";

      const nombre = el.tags?.name || getDefaultName(el.tags);

      const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(nombre + " " + (el.tags?.["addr:street"] || "") + " " + (el.tags?.["addr:city"] || ""))}`;

      const marker = L.marker([lat, lon], {
        icon: L.divIcon({
          html: `<svg width="40" height="52" viewBox="0 0 40 52" xmlns="http://www.w3.org/2000/svg">${outerRing}<path d="M20 4C12.268 4 6 10.268 6 18c0 9.75 14 28 14 28s14-18.25 14-28c0-7.732-6.268-14-14-14z" fill="${color}" fill-opacity="${fillOpacity}"/><circle cx="20" cy="18" r="7" fill="white" opacity="0.95"/></svg>`,
          iconSize: [40, 52],
          iconAnchor: [20, 50]
        })
      });

      marker.bindPopup(`
        <div class="popup-container">
          <strong>${nombre}</strong><br>
          <span class="horario-info">Horario: ${traducirHorario(el.tags?.opening_hours || "")}</span>
          ${vendeVapers(el.tags) ? '<div class="vape-info">‚úì Probablemente vende vapers</div>' : ''}
          ${extraInfo}
          <a href="${mapsUrl}" target="_blank" class="btn-maps">VER EN MAPS</a>
        </div>
      `);

      markersLayer.addLayer(marker);
    });

    isRendering = false;
  }

  // Botones
  menuButton.onclick = () => panel.classList.toggle("active");
  pinBtn.onclick = () => userLocation && map && map.flyTo([userLocation.lat, userLocation.lon], 17);
  searchAreaBtn.onclick = () => buscarDatos(true);
  searchBtn.onclick = async () => {
    const val = addressInput.value.trim();
    if (!val) return;
    overlay.style.display = 'flex';
    overlayText.textContent = 'Buscando direcci√≥n...';
    try {
      const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}&limit=1`);
      const d = await r.json();
      if (d.length) {
        map.setView([d[0].lat, d[0].lon], 16);
        buscarDatos(true);
      }
    } catch (e) { console.error(e); } finally {
      setTimeout(() => overlay.style.display = 'none', 800);
    }
  };

  onlyOpen.onchange = greyClosed.onchange = () => render();

  iniciarGeolocalizacion();
});
</script>
</body>
</html>
