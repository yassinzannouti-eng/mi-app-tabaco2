<script>

document.addEventListener("DOMContentLoaded", () => {

// ================= MAPA =================

const map = L.map('map', { zoomControl:false }).setView([40.41,-3.70],6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
maxZoom:19,
attribution:'© OpenStreetMap'
}).addTo(map);

const markersLayer = L.layerGroup().addTo(map);

const searchBtn = document.getElementById("searchCenterButton");
const searchInput = document.getElementById("address");

// ================= ICONOS =================

const iconEstanco = L.icon({
iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
iconSize:[25,41], iconAnchor:[12,41]
});

const iconTienda = L.icon({
iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
iconSize:[25,41], iconAnchor:[12,41]
});

// ================= USUARIO =================

let userLatLng = null;

map.locate({ enableHighAccuracy:true });

map.on('locationfound', e=>{
userLatLng = e.latlng;
});

// Botón suave (no agresivo)
const locateBtn = document.getElementById('locateButton');
if(locateBtn){
locateBtn.onclick = ()=>{
if(userLatLng){
map.flyTo(userLatLng, 16, {duration:1});
}
};
}

// ================= CACHE + CONTROL =================

const cache = new Map();
let lastKey = null;

function calcularRadio(){
const zoom = map.getZoom();
if(zoom >= 17) return 800;
if(zoom >= 15) return 1500;
if(zoom >= 13) return 3000;
if(zoom >= 11) return 6000;
return 10000;
}

function generarKey(){
const c = map.getCenter();
return `${c.lat.toFixed(2)}_${c.lng.toFixed(2)}_${map.getZoom()}`;
}

// ================= BUSCAR =================

async function buscarDatos(){

const key = generarKey();
if(key === lastKey) return; // evita duplicados
lastKey = key;

if(searchBtn) searchBtn.style.display = "none";

markersLayer.clearLayers();

if(cache.has(key)){
pintar(cache.get(key));
return;
}

const center = map.getCenter();
const radius = calcularRadio();

const query = `
[out:json][timeout:20];
(
node["shop"="tobacco"](around:${radius},${center.lat},${center.lng});
node["shop"~"convenience|variety_store|supermarket"](around:${radius},${center.lat},${center.lng});
);
out;
`;

try{
const response = await fetch("https://overpass-api.de/api/interpreter",{
method:"POST",
body:query
});

if(!response.ok) throw new Error();

const data = await response.json();
const elements = data.elements || [];

cache.set(key, elements);
pintar(elements);

}catch{
console.log("Overpass ocupado");
}
}

function pintar(elements){

markersLayer.clearLayers();

elements.forEach(p=>{
if(!p.lat || !p.lon) return;

const esEstanco = p.tags?.shop === "tobacco";
const nombre = p.tags?.name || (esEstanco?"ESTANCO":"TIENDA");

L.marker([p.lat,p.lon],{
icon: esEstanco?iconEstanco:iconTienda
})
.addTo(markersLayer)
.bindPopup(`<b>${nombre}</b>`);
});

}

// ================= BUSCADOR MANUAL =================

async function buscarManual(){

if(!searchInput) return;
const val = searchInput.value.trim();
if(!val) return;

try{
const response = await fetch(
'https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(val)
);

const data = await response.json();

if(data.length){
map.flyTo([data[0].lat,data[0].lon],15,{duration:1});
}
}catch{
console.log("Error búsqueda");
}
}

const searchButton = document.getElementById('searchButton');
if(searchButton) searchButton.onclick = buscarManual;

// ================= SISTEMA MOVIMIENTO INTELIGENTE =================

let moveTimer;

map.on("movestart", ()=>{
if(searchBtn) searchBtn.style.display = "block";
});

map.on("moveend", ()=>{
clearTimeout(moveTimer);
moveTimer = setTimeout(buscarDatos, 900);
});

if(searchBtn) searchBtn.onclick = buscarDatos;

// Primera carga automática
setTimeout(buscarDatos, 1000);

});
  </script>
