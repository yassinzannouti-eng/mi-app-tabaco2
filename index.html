<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vaper Tracker Pro</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<style>
html, body { height:100%; margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; background:#f5f5f7;}
#map { height:100%; width:100%; display:none; }

#overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:5000; font-size:18px; gap:20px;}
#overlay button { padding:12px 24px; border:none; background:#007aff; color:white; border-radius:12px; cursor:pointer; font-weight:600;}

.custom-pin { pointer-events:none; }
.custom-pin svg { pointer-events:auto; }

.horario-info { font-size:12px; color:#636366; display:block; margin-top:8px; line-height:1.4; border-top:1px solid #f2f2f7; padding-top:8px;}
.btn-maps { display:block; background:#007aff; color:white!important; text-align:center; padding:12px; border-radius:12px; text-decoration:none!important; margin-top:12px; font-weight:600; font-size:14px;}
</style>
</head>

<body>

<div id="overlay">
  <div id="overlayText">Localizando puntos de venta...</div>
  <button id="retryBtn" style="display:none;">Reintentar acceso</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/opening_hours@3.5.0/opening_hours+deps.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

const overlay = document.getElementById("overlay");
const overlayText = document.getElementById("overlayText");
const retryBtn = document.getElementById("retryBtn");

let map, markersLayer, elementsData=[];

function getOpeningStatus(str){
    if(!str || str.trim()==='') return {isOpen:true, known:false};
    try{
        const oh=new opening_hours(str);
        return {isOpen:oh.isOpen(new Date()), known:true};
    }catch{
        return {isOpen:true, known:false};
    }
}

function iniciarGeolocalizacion(){
    navigator.geolocation.getCurrentPosition(
        pos=>iniciarMapa(pos.coords.latitude,pos.coords.longitude),
        ()=>{
            overlayText.innerHTML="GPS desactivado o denegado.";
            retryBtn.style.display="block";
        },
        {enableHighAccuracy:true, timeout:12000}
    );
}

retryBtn.onclick=iniciarGeolocalizacion;

function iniciarMapa(lat,lon){

    overlay.style.display="none";
    document.getElementById("map").style.display="block";

    map=L.map('map').setView([lat,lon],16);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{
        attribution:'Â© OpenStreetMap'
    }).addTo(map);

    markersLayer=L.markerClusterGroup().addTo(map);

    L.circleMarker([lat,lon],{
        radius:9,color:"white",fillColor:"#007aff",fillOpacity:0.9,weight:3
    }).addTo(map);

    buscarDatos();
}

function getVisibleRadius(){
    const bounds=map.getBounds();
    return map.getCenter().distanceTo(bounds.getNorthEast());
}

async function buscarDatos(){

    const c=map.getCenter();
    const radio=getVisibleRadius();

    const resp=await fetch("https://overpass-api.de/api/interpreter",{
        method:"POST",
        body:"data="+encodeURIComponent(`[out:json][timeout:25];
        (
          node["shop"="tobacco"](around:${radio},${c.lat},${c.lng});
          node["shop"="kiosk"](around:${radio},${c.lat},${c.lng});
          node["amenity"="kiosk"](around:${radio},${c.lat},${c.lng});
          node["shop"="convenience"](around:${radio},${c.lat},${c.lng});
          node["shop"="supermarket"](around:${radio},${c.lat},${c.lng});
          node["shop"="vape"](around:${radio},${c.lat},${c.lng});
          node["shop"="e-cigarette"](around:${radio},${c.lat},${c.lng});
          node["amenity"="fuel"](around:${radio},${c.lat},${c.lng});
        );
        out;`)
    });

    const data=await resp.json();
    elementsData=data.elements||[];
    render();
}

function render(){

    markersLayer.clearLayers();

    elementsData.forEach(p=>{

        const tags=p.tags||{};
        const horarioRaw=tags.opening_hours||"";
        const status=getOpeningStatus(horarioRaw);

        let color="#8e8e93";

        if(tags.shop==="tobacco") color="#8B4789";
        else if(tags.shop==="kiosk"||tags.amenity==="kiosk") color="#8B4789";
        else if(tags.shop==="supermarket") color="#003366";
        else if(tags.amenity==="fuel") color="#C8A2C8";
        else if(tags.shop==="vape"||tags.shop==="e-cigarette") color="#5856d6";
        else if(tags.shop==="convenience") color="#00CED1";

        const isFuel=tags.amenity==="fuel";

        let ringHTML="";
        let fillOpacity=1;

        if(isFuel || (status.known && status.isOpen)){
            ringHTML=`
            <circle cx="18" cy="18" r="13"
                fill="none"
                stroke="#00FF00"
                stroke-width="4"
                style="filter: drop-shadow(0 0 6px #00FF00) drop-shadow(0 0 10px #00FF00);"
            />`;
        }

        const nombre=tags.name||"Local";

        const horarioMostrar=horarioRaw?horarioRaw.replace(/;/g,"<br>"):"Horario no disponible";

        const mapsUrl=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(nombre)}`;

        const pinIcon=L.divIcon({
            className:"custom-pin",
            html:`<svg width="36" height="48" viewBox="0 0 36 48">
                ${ringHTML}
                <path d="M18 2C9.7 2 3 8.7 3 17c0 10.5 15 27 15 27s15-16.5 15-27c0-8.3-6.7-15-15-15z"
                      fill="${color}" fill-opacity="${fillOpacity}"/>
                <circle cx="18" cy="17" r="7" fill="white"/>
            </svg>`,
            iconSize:[36,48],
            iconAnchor:[18,46],
            popupAnchor:[0,-42]
        });

        L.marker([p.lat,p.lon],{icon:pinIcon})
        .bindPopup(`
            <div>
                <strong>${nombre}</strong>
                <span class="horario-info"><b>Horario:</b><br>${horarioMostrar}</span>
                <a href="${mapsUrl}" target="_blank" class="btn-maps">VER EN MAPS</a>
            </div>
        `)
        .addTo(markersLayer);

    });
}

iniciarGeolocalizacion();

});
</script>
</body>
</html>
