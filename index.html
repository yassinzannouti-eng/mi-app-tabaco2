<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vaper Tracker ESTABLE</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<style>
html,body{height:100%;margin:0;font-family:Arial;}
#map{height:100%;width:100%;}
#menuButton{
position:fixed;top:15px;left:15px;z-index:2000;
background:white;border:none;padding:10px;border-radius:8px;
box-shadow:0 3px 8px rgba(0,0,0,0.2);cursor:pointer;
}
#panel{
position:fixed;top:0;left:-260px;width:240px;height:100%;
background:white;z-index:2100;padding:20px;
box-shadow:2px 0 15px rgba(0,0,0,0.2);
transition:.3s;
overflow:auto;
}
#panel.active{left:0;}
.search{
position:absolute;top:15px;left:50%;
transform:translateX(-50%);
z-index:1500;display:flex;
background:white;border-radius:25px;
box-shadow:0 4px 15px rgba(0,0,0,0.18);
overflow:hidden;
}
.search input{padding:10px;border:none;outline:none;}
.search button{padding:10px;border:none;background:#2563eb;color:white;}
.badge{font-size:12px;padding:3px 6px;border-radius:8px;}
.open{background:#22c55e;color:white;}
.closed{background:#ef4444;color:white;}
</style>
</head>
<body>

<div id="panel">
<h3>Filtros</h3>
<label><input type="checkbox" id="onlyOpen"> Solo abiertos</label><br>
<label><input type="checkbox" id="greyClosed" checked> Cerrados en gris</label>
<hr>
<input type="text" id="searchName" placeholder="Buscar por nombre">
</div>

<button id="menuButton">‚ò∞</button>

<div class="search">
<input type="text" id="address" placeholder="Buscar ciudad">
<button id="searchBtn">üîç</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
document.addEventListener("DOMContentLoaded",()=>{

const map=L.map('map').setView([40.41,-3.70],6);

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
attribution:'¬©OpenStreetMap'
}).addTo(map);

const cluster=L.markerClusterGroup();
map.addLayer(cluster);

let userLocation=null;
let elementsData=[];

map.locate({enableHighAccuracy:true});
map.on('locationfound',e=>{userLocation=e.latlng;});

function icon(color){
return L.icon({
iconUrl:`https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
iconSize:[25,41],iconAnchor:[12,41]
});
}

const redIcon=icon("red");
const greyIcon=icon("grey");

function analizarHorario(opening){
if(!opening)return {estado:null,texto:"Horario desconocido"};

if(opening.includes("24/7"))
return {estado:true,texto:"<span class='badge open'>24/7</span>"};

const now=new Date();
const min=now.getHours()*60+now.getMinutes();
const match=[...opening.matchAll(/(\d{2}:\d{2})-(\d{2}:\d{2})/g)];

for(let r of match){
const i=r[1].split(":");
const f=r[2].split(":");
const mi=parseInt(i[0])*60+parseInt(i[1]);
const mf=parseInt(f[0])*60+parseInt(f[1]);
if(min>=mi&&min<=mf)
return {estado:true,texto:"<span class='badge open'>Abierto</span>"};
}

return {estado:false,texto:"<span class='badge closed'>Cerrado</span>"};
}

async function buscarDatos(){

cluster.clearLayers();

const c=map.getCenter();
const r=6000;

const query=`[out:json];
(node["shop"="tobacco"](around:${r},${c.lat},${c.lng}););
out;`;

try{
const resp=await fetch("https://overpass-api.de/api/interpreter",{
method:"POST",
body:query
});
const data=await resp.json();
elementsData=data.elements||[];
render();
}catch(e){
alert("Error cargando datos");
}

}

function render(){

cluster.clearLayers();

let lista=[...elementsData];

const onlyOpen=document.getElementById("onlyOpen").checked;
const greyClosed=document.getElementById("greyClosed").checked;
const search=document.getElementById("searchName").value.toLowerCase();

if(search){
lista=lista.filter(p=>p.tags?.name?.toLowerCase().includes(search));
}

lista.forEach(p=>{

const horario=analizarHorario(p.tags?.opening_hours);

if(onlyOpen && horario.estado===false) return;

let icono=redIcon;
if(horario.estado===false && greyClosed) icono=greyIcon;

const marker=L.marker([p.lat,p.lon],{icon:icono});

marker.bindPopup(`
<b>${p.tags?.name||"Estanco"}</b><br>
${horario.texto}
<br><br>
<a href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}" target="_blank">
C√≥mo llegar
</a>
`);

cluster.addLayer(marker);

});

}

document.getElementById("searchBtn").onclick=async()=>{
const val=document.getElementById("address").value;
const resp=await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(val));
const data=await resp.json();
if(data.length) map.flyTo([data[0].lat,data[0].lon],14);
};

document.getElementById("menuButton").onclick=()=>{
document.getElementById("panel").classList.toggle("active");
};

document.getElementById("onlyOpen").onchange=render;
document.getElementById("greyClosed").onchange=render;
document.getElementById("searchName").oninput=render;

map.on("moveend",buscarDatos);

setTimeout(buscarDatos,1500);

});
</script>

</body>
</html>
