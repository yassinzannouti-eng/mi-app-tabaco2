<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vaper Tracker Mejorado</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  height: 100%;
  margin: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

#map {
  height: 100%;
  width: 100%;
  z-index: 0;
}

/* BUSCADOR SUPERIOR */
.search-bar {
    position: absolute;
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1100;
    width: 90%;
    max-width: 450px;
    display: flex;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    border-radius: 30px;
    overflow: hidden;
    align-items: center;
}

.search-bar input {
    flex: 1;
    padding: 12px 15px;
    border: none;
    outline: none;
    font-size: 14px;
}

.search-bar button {
    padding: 12px 15px;
    border: none;
    background: #2563eb;
    color: white;
    cursor: pointer;
    font-size: 16px;
}

/* BOTONES DE CONTROL */
.btn-locate {
    position: absolute;
    bottom: 100px;
    right: 20px;
    z-index: 1100;
    width: 50px;
    height: 50px;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    border: 2px solid #2563eb;
    cursor: pointer;
    font-size: 20px;
}

.btn-add-manual {
    position: absolute;
    bottom: 30px;
    left: 20px;
    z-index: 1100;
    background: rgba(255,255,255,0.9);
    border: 1px solid #ccc;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    color: #444;
}

/* BOT√ìN DE B√öSQUEDA CENTRAL */
.btn-search-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1050;
    background: rgba(255,255,255,0.8);
    border: 1px solid #ccc;
    padding: 10px 18px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    display: none;
}

/* BARRA LATERAL */
#sidebar {
    position: fixed;
    top: 0;
    left: -280px;
    width: 260px;
    height: 100%;
    background: white;
    box-shadow: 2px 0 15px rgba(0,0,0,0.2);
    transition: left 0.3s ease;
    z-index: 2000;
    padding: 20px;
    font-size: 14px;
}

#sidebar.active { left:0; }

.sidebar-header {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 20px;
    cursor: pointer;
}

.sidebar-content h3 {
    margin-top: 15px;
    margin-bottom: 5px;
}

#menuButton {
    position: fixed;
    top: 15px;
    left: 15px;
    z-index: 2100;
    background: white;
    border: none;
    padding: 10px 12px;
    border-radius: 8px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    cursor: pointer;
    font-size: 18px;
}
</style>
</head>
<body>

<!-- Barra lateral -->
<div id="sidebar">
    <div class="sidebar-header">‚ò∞ Men√∫</div>
    <div class="sidebar-content">
        <h3>Soporte</h3>
        <p>Contacto y ayuda</p>

        <h3>Preguntas frecuentes</h3>
        <p>C√≥mo funciona la app</p>

        <h3>Ajustes</h3>
        <label>
            <input type="checkbox" id="toggleAutoSearch" checked>
            Buscar autom√°ticamente al mover mapa
        </label>
    </div>
</div>
<button id="menuButton">‚ò∞</button>

<!-- Buscador -->
<div class="search-bar">
    <input type="text" id="address" placeholder="Buscar zona o ciudad...">
    <button id="searchButton">üîç</button>
</div>

<!-- Botones -->
<div class="btn-locate" id="locateButton">üéØ</div>
<button class="btn-add-manual" id="addButton">‚ûï Guardar coordenada</button>
<button class="btn-search-center" id="searchCenterButton">BUSCAR AQU√ç</button>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", ()=>{

// ===== MAPA =====
const map = L.map('map',{zoomControl:false}).setView([40.41,-3.70],6);

L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{
maxZoom:19, attribution:'¬© OpenStreetMap'
}).addTo(map);

const markersLayer = L.layerGroup().addTo(map);
const searchBtn = document.getElementById("searchCenterButton");

// ===== ICONOS =====
const iconEstanco = L.icon({
iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
iconSize:[25,41], iconAnchor:[12,41]
});
const iconTienda = L.icon({
iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
iconSize:[25,41], iconAnchor:[12,41]
});

// ===== USUARIO =====
let userLatLng = null;
const userMarker = L.circleMarker([0,0],{
radius:8,color:"white",weight:3,fillColor:"#2563eb",fillOpacity:1
}).addTo(map);

map.locate({enableHighAccuracy:true});
map.on('locationfound', e=>{
    userLatLng = e.latlng;
    userMarker.setLatLng(userLatLng);
});

// Bot√≥n centrar usuario
document.getElementById("locateButton").onclick = ()=>{
if(userLatLng) map.flyTo(userLatLng,16,{duration:1});
};

// ===== CACHE =====
const cache = new Map();
let lastKey=null;

function calcularRadio(){
const zoom = map.getZoom();
if(zoom>=17) return 800;
if(zoom>=15) return 1500;
if(zoom>=13) return 3000;
if(zoom>=11) return 6000;
return 10000;
}
function generarKey(){
const c = map.getCenter();
return `${c.lat.toFixed(2)}_${c.lng.toFixed(2)}_${map.getZoom()}`;
}

// ===== BUSCAR DATOS =====
async function buscarDatos(){
if(lastKey===generarKey()) return;
lastKey = generarKey();

markersLayer.clearLayers();
if(searchBtn) searchBtn.style.display="none";

if(cache.has(lastKey)){ pintar(cache.get(lastKey)); return; }

const center = map.getCenter();
const radius = calcularRadio();

const query = `
[out:json][timeout:20];
(
node["shop"="tobacco"](around:${radius},${center.lat},${center.lng});
node["shop"~"convenience|variety_store|supermarket"](around:${radius},${center.lat},${center.lng});
);
out;
`;

try{
const response = await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:query});
if(!response.ok) throw new Error();
const data = await response.json();
const elements = data.elements || [];
cache.set(lastKey,elements);
pintar(elements);
}catch{ console.log("Servidor Overpass ocupado"); }
}

function pintar(elements){
elements.forEach(p=>{
if(!p.lat || !p.lon) return;
const esEstanco = p.tags?.shop==="tobacco";
const nombre = p.tags?.name || (esEstanco?"ESTANCO":"TIENDA");
L.marker([p.lat,p.lon],{icon: esEstanco?iconEstanco:iconTienda})
.addTo(markersLayer)
.bindPopup(`<b>${nombre}</b><br><a href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}" target="_blank">C√≥mo llegar</a>`);
});
}

// ===== BUSCADOR MANUAL =====
document.getElementById('searchButton').onclick = async ()=>{
const val=document.getElementById('address').value.trim();
if(!val) return;
try{
const resp = await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(val));
const data = await resp.json();
if(data.length) map.flyTo([data[0].lat,data[0].lon],15,{duration:1});
}catch{}
};

// ===== MOVIMIENTO INTELIGENTE =====
let moveTimer;
map.on("movestart", ()=>{ if(searchBtn) searchBtn.style.display="block"; });
map.on("moveend", ()=>{
clearTimeout(moveTimer);
if(document.getElementById("toggleAutoSearch")?.checked)
    moveTimer = setTimeout(buscarDatos,900);
});
if(searchBtn) searchBtn.onclick = buscarDatos;

// ===== BARRA LATERAL =====
const sidebar = document.getElementById("sidebar");
document.getElementById("menuButton").onclick = ()=>{ sidebar.classList.toggle("active"); };

// ===== BOT√ìN GUARDAR COORDENADA =====
document.getElementById('addButton').onclick = ()=>{
const c = map.getCenter();
alert("Coordenada guardada: "+c.lat.toFixed(6)+", "+c.lng.toFixed(6));
};

// ===== PRIMERA B√öSQUEDA =====
setTimeout(buscarDatos,1500);

});
</script>
</body>
</html>
