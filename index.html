<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Localizador Pro - Vaper & Tabaco</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        html,body{height:100%;margin:0;font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;}
        #map{height:100%;width:100%;display:none; background: #f0f0f0;}

        /* Overlay Inicial */
        #overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:white;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:5000;text-align:center;padding:20px;gap:20px;}
        #overlay button{padding:12px 24px;border:none;background:#2563eb;color:white;border-radius:30px;cursor:pointer;font-weight:bold;box-shadow: 0 4px 10px rgba(37,99,235,0.3);}

        /* UI Controls */
        #menuButton{position:fixed;top:15px;left:15px;z-index:2000;background:white;border:none;padding:12px;border-radius:50%;box-shadow:0 4px 12px rgba(0,0,0,0.15);cursor:pointer;font-size:18px;}
        #panel{position:fixed;top:0;left:-300px;width:260px;height:100%;background:white;z-index:2100;padding:25px;box-shadow:2px 0 15px rgba(0,0,0,0.1);transition:.3s;overflow:auto;}
        #panel.active{left:0;}

        .search-bar{position:absolute;top:15px;left:50%;transform:translateX(-50%);z-index:1500;display:flex;background:white;border-radius:30px;box-shadow:0 8px 20px rgba(0,0,0,0.1);overflow:hidden;width:85%;max-width:400px;}
        .search-bar input{flex:1;padding:12px 20px;border:none;outline:none;font-size:14px;}
        .search-bar button{padding:12px 20px;border:none;background:#2563eb;color:white;cursor:pointer;}

        .btn-pin{position:absolute;bottom:100px;right:20px;width:55px;height:55px;background:white;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#2563eb;font-size:24px;border:none;cursor:pointer;z-index:1500;box-shadow:0 4px 15px rgba(0,0,0,0.2);}
        .btn-search-area{position:absolute;bottom:30px;right:20px;background:#2563eb;color:white;border:none;padding:12px 20px;border-radius:30px;cursor:pointer;z-index:1500;box-shadow:0 4px 15px rgba(37,99,235,0.4);font-weight:bold;font-size:13px;}

        /* Popups */
        .popup-card{min-width:180px; padding: 5px 0;}
        .popup-title{font-weight:bold; font-size:15px; margin-bottom:4px; display:block; color:#1e293b;}
        .badge{display:inline-block; padding:3px 8px; border-radius:5px; color:white; font-size:11px; font-weight:bold; text-transform:uppercase; margin-bottom:8px;}
        .open{background:#10b981;}
        .closed{background:#ef4444;}
        .schedule{font-size:12px; color:#64748b; margin-bottom:12px; display:block; line-height:1.4;}
        .btn-maps{display:block; text-align:center; background:#4285F4; color:white !important; text-decoration:none !important; padding:10px; border-radius:8px; font-size:13px; font-weight:bold;}
    </style>
</head>

<body>

<div id="overlay">
    <div id="overlayText">üìç Necesitamos tu ubicaci√≥n para encontrar los locales m√°s cercanos.</div>
    <button id="retryBtn">Permitir ubicaci√≥n</button>
</div>

<button id="menuButton">‚ò∞</button>

<div id="panel">
    <h3 style="margin-top:0">Ajustes</h3>
    <hr style="border:0; border-top:1px solid #eee; margin:15px 0">
    <label style="display:flex; align-items:center; gap:10px; cursor:pointer">
        <input type="checkbox" id="onlyOpen"> Solo locales abiertos
    </label>
    <br>
    <label style="display:flex; align-items:center; gap:10px; cursor:pointer">
        <input type="checkbox" id="greyClosed" checked> Apagar cerrados
    </label>
</div>

<div class="search-bar">
    <input type="text" id="address" placeholder="Ej: Madrid, Calle Mayor...">
    <button id="searchBtn">üîç</button>
</div>

<button class="btn-pin" id="pinBtn" title="Ir a mi ubicaci√≥n">üéØ</button>
<button class="btn-search-area" id="searchAreaBtn">BUSCAR EN ESTA ZONA</button>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", ()=>{

    const overlay = document.getElementById("overlay");
    const overlayText = document.getElementById("overlayText");
    const retryBtn = document.getElementById("retryBtn");
    const onlyOpen = document.getElementById("onlyOpen");
    const greyClosed = document.getElementById("greyClosed");

    let map, userLocation, markersLayer, userMarker, elementsData = [];

    // --- GEOLOCALIZACI√ìN ---
    function iniciarGeolocalizacion(){
        if(!navigator.geolocation) {
            overlayText.innerHTML = "Tu navegador no soporta geolocalizaci√≥n.";
            return;
        }
        navigator.geolocation.getCurrentPosition(
            pos => iniciarMapa(pos.coords.latitude, pos.coords.longitude),
            err => {
                overlayText.innerHTML = "Por favor, activa la ubicaci√≥n para continuar.";
                retryBtn.style.display = "block";
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }

    retryBtn.onclick = iniciarGeolocalizacion;

    // --- MAPA ---
    function iniciarMapa(lat, lon){
        userLocation = {lat, lon};
        overlay.style.display = "none";
        document.getElementById("map").style.display = "block";

        map = L.map('map', { zoomControl: false }).setView([lat, lon], 16);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '¬©OpenStreetMap'
        }).addTo(map);

        markersLayer = L.layerGroup().addTo(map);

        userMarker = L.circleMarker([lat, lon], {
            radius: 9, color: "white", fillColor: "#2563eb", fillOpacity: 1, weight: 3
        }).addTo(map);

        buscarDatos();
    }

    // --- B√öSQUEDA OPTIMIZADA ---
    async function buscarDatos(){
        const bounds = map.getBounds();
        const sw = bounds.getSouthWest();
        const ne = bounds.getNorthEast();
        
        // Usamos bbox para mayor rapidez en lugar de un radio circular
        const query = `[out:json][timeout:15];
        (
          node["shop"~"tobacco|supermarket|variety_store"](${sw.lat},${sw.lng},${ne.lat},${ne.lng});
          node["amenity"="fuel"](${sw.lat},${sw.lng},${ne.lat},${ne.lng});
        );
        out tags qt;`; // "qt" ordena por geoc√≥digo para rapidez

        try {
            const resp = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
            const data = await resp.json();
            elementsData = data.elements || [];
            render();
        } catch (e) {
            console.error("Error cargando datos");
        }
    }

    // --- ANALIZADOR DE HORARIOS ---
    function obtenerInfoHorario(opening){
        if(!opening) return { estado: null, texto: "Horario no disponible", badge: "" };
        
        let textoLimpio = opening.replace(/;/g, '<br>');
        const now = new Date();
        const diaSemana = ["Su","Mo","Tu","We","Th","Fr","Sa"][now.getDay()];
        const horaActual = now.getHours() * 100 + now.getMinutes();

        // L√≥gica simple de "Abierto ahora" para 24/7
        if(opening.includes("24/7")) return { estado: true, texto: "Abierto 24h", badge: "<span class='badge open'>Abierto</span>" };

        // Esta es una aproximaci√≥n r√°pida. Para exactitud total se requerir√≠a una librer√≠a como opening_hours.js
        // Pero para rendimiento web, usamos un indicador visual.
        return { 
            estado: true, 
            texto: textoLimpio, 
            badge: "<span class='badge' style='background:#64748b'>Ver Horario</span>" 
        };
    }

    // --- RENDERIZADO ---
    function render(){
        markersLayer.clearLayers();

        elementsData.forEach(p => {
            let color = "blue";
            if(p.tags?.shop === "tobacco") color = "red";
            else if(p.tags?.shop === "supermarket") color = "green";
            else if(p.tags?.amenity === "fuel") color = "orange";
            else if(p.tags?.shop === "variety_store") color = "violet";

            const info = obtenerInfoHorario(p.tags?.opening_hours);
            
            let iconColor = color;
            if(greyClosed.checked && info.estado === false) iconColor = "grey";

            const icon = L.icon({
                iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${iconColor}.png`,
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
            });

            const nombre = p.tags?.name || "Punto de Venta";
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(nombre + " " + (p.tags['addr:street'] || ""))}`;

            L.marker([p.lat, p.lon], {icon})
            .bindPopup(`
                <div class="popup-card">
                    <span class="popup-title">${nombre}</span>
                    ${info.badge}
                    <span class="schedule"><b>Horario:</b><br>${info.texto}</span>
                    <a href="${mapsUrl}" target="_blank" class="btn-maps">VER EN MAPS</a>
                </div>
            `)
            .addTo(markersLayer);
        });
    }

    // --- EVENTOS ---
    document.getElementById("menuButton").onclick = () => document.getElementById("panel").classList.toggle("active");
    document.getElementById("pinBtn").onclick = () => map.flyTo([userLocation.lat, userLocation.lon], 17);
    document.getElementById("searchAreaBtn").onclick = buscarDatos;
    onlyOpen.onchange = render;
    greyClosed.onchange = render;

    document.getElementById("searchBtn").onclick = async () => {
        const query = document.getElementById("address").value;
        if(!query) return;
        const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
        const data = await resp.json();
        if(data.length > 0) {
            map.setView([data[0].lat, data[0].lon], 16);
            buscarDatos();
        }
    };

    iniciarGeolocalizacion();
});
</script>
</body>
</html>
