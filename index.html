<script>
document.addEventListener("DOMContentLoaded",()=>{

let userLocation=null;
let elementsData=[];
let mapaListo=false;

const map=L.map('map',{preferCanvas:true})
.setView([40.4168,-3.7038],13);

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
  attribution:'©OpenStreetMap ©CARTO'
}).addTo(map);

const markersLayer=L.layerGroup().addTo(map);

const userMarker=L.circleMarker([0,0],{
  radius:8,
  color:"#2563eb",
  fillColor:"#2563eb",
  fillOpacity:0.9
}).addTo(map);

/* =========================
   ICONOS
========================= */

function icon(color){
  return L.icon({
    iconUrl:`https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
    shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
    iconSize:[25,41],
    iconAnchor:[12,41]
  });
}

const icons={
  estanco:icon("red"),
  supermercado:icon("green"),
  bazar:icon("violet"),
  gasolinera:icon("yellow")
};

/* =========================
   GEOLOCALIZACIÓN
========================= */

if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude;
    const lon=pos.coords.longitude;
    userLocation={lat,lon};
    map.setView([lat,lon],15);
    userMarker.setLatLng([lat,lon]);
    mapaListo=true;
    buscarDatos();
  });
}

/* =========================
   FILTROS
========================= */

let filtros={
  estanco:true,
  supermercado:true,
  bazar:true,
  gasolinera:true
};

document.getElementById("toggleEstanco").onchange=e=>{filtros.estanco=e.target.checked; render();}
document.getElementById("toggleSuper").onchange=e=>{filtros.supermercado=e.target.checked; render();}
document.getElementById("toggleBazar").onchange=e=>{filtros.bazar=e.target.checked; render();}
document.getElementById("toggleGas").onchange=e=>{filtros.gasolinera=e.target.checked; render();}

/* =========================
   SERVIDORES OVERPASS
========================= */

const endpoints=[
  "https://overpass-api.de/api/interpreter",
  "https://overpass.kumi.systems/api/interpreter",
  "https://overpass.openstreetmap.ru/api/interpreter"
];

async function fetchOverpass(query){

  for(let url of endpoints){
    try{
      const resp=await fetch(url,{method:"POST",body:query});
      if(resp.ok){
        return await resp.json();
      }
    }catch(e){
      continue;
    }
  }

  throw new Error("Todos los servidores Overpass fallaron");
}

/* =========================
   BUSCAR DATOS (BBox real)
========================= */

async function buscarDatos(){

  if(!mapaListo) return;

  if(map.getZoom()<13){
    markersLayer.clearLayers();
    return;
  }

  const b=map.getBounds();

  const query=`
  [out:json][timeout:15];
  (
    node["shop"="tobacco"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
    node["shop"="supermarket"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
    node["shop"="variety_store"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
    node["amenity"="fuel"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
  );
  out body;
  `;

  try{
    const data=await fetchOverpass(query);
    elementsData=data.elements||[];
    render();
  }catch(e){
    console.log(e);
  }
}

/* =========================
   RENDER
========================= */

function render(){

  markersLayer.clearLayers();

  for(let p of elementsData){

    let tipo=null;

    if(p.tags?.shop==="tobacco") tipo="estanco";
    else if(p.tags?.shop==="supermarket") tipo="supermercado";
    else if(p.tags?.shop==="variety_store") tipo="bazar";
    else if(p.tags?.amenity==="fuel") tipo="gasolinera";

    if(!tipo || !filtros[tipo]) continue;

    const popup=`
      <b>${p.tags?.name||tipo}</b><br>
      <a href="https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lon}" target="_blank">
      Ver en Maps</a>
    `;

    L.marker([p.lat,p.lon],{icon:icons[tipo]})
      .bindPopup(popup)
      .addTo(markersLayer);
  }
}

/* =========================
   BOTONES
========================= */

document.getElementById("locateBtn").onclick=()=>{
  if(userLocation) map.flyTo(userLocation,16);
};

document.getElementById("searchAreaBtn").onclick=buscarDatos;

map.on("moveend",()=>{
  clearTimeout(window.moveTimer);
  window.moveTimer=setTimeout(buscarDatos,500);
});

});
      </script>
