<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaper Tracker Pro</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; background: #f0f0f0; }
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* Controles superiores */
        .header {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 1000; width: 90%; max-width: 450px;
        }
        .search-box { display: flex; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border-radius: 30px; overflow: hidden; background: white; }
        .search-box input { flex: 1; padding: 12px 20px; border: none; outline: none; font-size: 14px; }
        .search-box button { padding: 12px 18px; border: none; background: #2563eb; color: white; cursor: pointer; font-weight: bold; }

        /* Sidebar de coordenadas */
        #sidebar {
            position: absolute; left: -280px; top: 0; width: 260px; height: 100%;
            background: white; z-index: 2000; transition: 0.3s ease; padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.2); overflow-y: auto;
        }
        #sidebar.active { left: 0; }
        .menu-btn { position: absolute; left: 15px; top: 75px; z-index: 1500; background: white; border: 1px solid #ccc; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: bold; }

        /* Tarjetas de coordenadas */
        .coord-card { background: #eef2ff; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #2563eb; font-size: 11px; }
        
        /* Popups */
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; color: white; font-weight: bold; font-size: 10px; margin-bottom: 5px; }
        .btn-google { display: block; text-align: center; background: #4285F4; color: white; padding: 8px; text-decoration: none; border-radius: 5px; margin-top: 10px; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <div class="search-box">
            <input type="text" id="target" placeholder="Buscar ciudad o calle...">
            <button onclick="buscarManual()">üîç</button>
        </div>
    </div>

    <button class="menu-btn" onclick="document.getElementById('sidebar').classList.toggle('active')">üìã PUNTOS BOE</button>

    <div id="sidebar">
        <h3>Captura Manual</h3>
        <p><small>Toca el mapa para registrar coordenadas del BOE.</small></p>
        <div id="lista-coords"></div>
    </div>

    <div id="map"></div>

    <script>
        // 1. Inicializar mapa con Zoom libre hasta nivel 20
        var map = L.map('map', { zoomControl: false, maxZoom: 20 }).setView([40.41, -3.70], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20 }).addTo(map);

        // 2. Localizaci√≥n Precisa Forzada
        function geolocalizar() {
            map.locate({
                setView: true, 
                maxZoom: 17,
                enableHighAccuracy: true,
                timeout: 10000
            });
        }

        geolocalizar();

        map.on('locationfound', (e) => {
            L.circle(e.latlng, { radius: 15, color: '#2563eb' }).addTo(map);
            cargarTiendas(e.latlng.lat, e.latlng.lng);
        });

        map.on('locationerror', () => {
            alert("Error: Activa el GPS y refresca la p√°gina.");
        });

        // 3. Captura al hacer clic (Sidebar)
        map.on('click', (e) => {
            const lat = e.latlng.lat.toFixed(6);
            const lng = e.latlng.lng.toFixed(6);
            const div = document.createElement("div");
            div.className = "coord-card";
            div.innerHTML = `<b>Nuevo Punto:</b><br>${lat}, ${lng}`;
            document.getElementById("lista-coords").prepend(div);
            document.getElementById('sidebar').classList.add('active');
        });

        // 4. Carga y Filtro (Elimina fruter√≠as/pescader√≠as)
        function cargarTiendas(lat, lng) {
            // Buscamos estancos, bazares y tiendas de conveniencia
            const query = `[out:json];(node["shop"~"tobacco|variety_store|convenience"](around:2000,${lat},${lng});node["amenity"="fuel"](around:2000,${lat},${lng}););out;`;
            
            fetch("https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query))
            .then(res => res.json()).then(data => {
                data.elements.forEach(p => {
                    const name = (p.tags.name || "").toLowerCase();
                    
                    // FILTRO DE SEGURIDAD ABSOLUTO
                    const prohibido = ["pesca", "fruta", "verdu", "carni", "baker", "charcu", "panad", "frutas"];
                    if (prohibido.some(p => name.includes(p))) return;

                    const esEstanco = p.tags.shop === "tobacco";
                    const titulo = p.tags.name || (esEstanco ? "Estanco" : "Bazar / Supermercado");
                    const color = esEstanco ? "#ef4444" : "#facc15"; // Rojo o Amarillo/Oro

                    // Marcadores de c√≠rculo (No fallan nunca, no cargan im√°genes externas)
                    L.circleMarker([p.lat, p.lon], {
                        radius: 9,
                        fillColor: color,
                        color: "#000",
                        weight: 1,
                        fillOpacity: 0.9
                    }).addTo(map).bindPopup(`
                        <div style="text-align:center">
                            <span class="badge" style="background:${color}; color:${esEstanco?'white':'black'}">${esEstanco ? 'ESTANCO' : 'BAZAR / S√öPER'}</span>
                            <div style="font-weight:bold; margin-bottom:5px;">${titulo}</div>
                            <a href="https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lon}" target="_blank" class="btn-google">VER HORARIO</a>
                        </div>
                    `);
                });
            });
        }

        function buscarManual() {
            const val = document.getElementById('target').value;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}`)
            .then(r => r.json()).then(d => {
                if(d[0]) {
                    map.setView([d[0].lat, d[0].lon], 17);
                    cargarTiendas(d[0].lat, d[0].lon);
                }
            });
        }
    </script>
</body>
</html>
