<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vaper Tracker - Ubicaci√≥n Real</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body, html { margin:0; padding:0; height:100%; font-family:Segoe UI; overflow:hidden; }
#map { height:100vh; width:100%; }

.search-bar {
position:absolute; top:15px; left:50%; transform:translateX(-50%);
z-index:1000; width:90%; max-width:450px;
display:flex; box-shadow:0 4px 15px rgba(0,0,0,.15);
border-radius:30px; overflow:hidden;
}
.search-bar input { flex:1; padding:15px; border:none; outline:none; }
.search-bar button { padding:15px; border:none; background:#2563eb; color:white; cursor:pointer; }

.btn-locate {
position:absolute; bottom:100px; right:20px;
z-index:1000; width:55px; height:55px;
background:white; border-radius:50%;
display:flex; align-items:center; justify-content:center;
box-shadow:0 2px 10px rgba(0,0,0,.2);
border:2px solid #2563eb; cursor:pointer;
}

.btn-add-manual {
position:absolute; bottom:30px; left:20px;
z-index:1000; background:white;
border:1px solid #ccc; padding:8px 15px;
border-radius:20px; font-size:12px;
cursor:pointer;
}

.center-cross {
position:absolute; top:50%; left:50%;
transform:translate(-50%,-50%);
z-index:900; pointer-events:none;
color:#2563eb; opacity:.5; font-size:20px;
}

.btn-search-center {
position:absolute; top:60%; left:50%;
transform:translateX(-50%);
z-index:950; background:white;
border:1px solid #ccc; padding:8px 15px;
border-radius:20px; font-size:14px;
cursor:pointer;
}
</style>
</head>

<body>

<div class="search-bar">
<input type="text" id="address" placeholder="Buscar zona o ciudad...">
<button id="searchButton">üîç</button>
</div>

<div class="center-cross">+</div>
<button class="btn-search-center" id="searchCenterButton">BUSCAR AQU√ç</button>
<div class="btn-locate" id="locateButton">üéØ</div>
<button class="btn-add-manual" id="addButton">‚ûï GUARDAR COORDENADA</button>

<div id="map"></div>

<script>

// MAPA
const map = L.map('map', { zoomControl:false }).setView([40.41,-3.70],6);

L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{
maxZoom:19,
attribution:'¬© OpenStreetMap'
}).addTo(map);

// Grupo para limpiar marcadores
const markersLayer = L.layerGroup().addTo(map);

// Iconos
const iconEstanco = L.icon({
iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
iconSize:[30,50], iconAnchor:[15,50]
});

const iconTienda = L.icon({
iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
iconSize:[30,50], iconAnchor:[15,50]
});

// Marcador usuario
const userMarker = L.circleMarker([0,0],{
radius:8, color:'white',
fillColor:'#2563eb', fillOpacity:1, weight:3
}).addTo(map);

// Geolocalizaci√≥n (SIN watch para evitar spam API)
map.locate({setView:true, zoom:16});

map.on('locationfound', e=>{
userMarker.setLatLng(e.latlng);
buscarDatos(e.latlng.lat, e.latlng.lng);
});

// FUNCI√ìN PRINCIPAL
async function buscarDatos(lat,lng){

markersLayer.clearLayers(); // LIMPIA MARCADORES

const query = `
[out:json][timeout:25];
(
node["shop"="tobacco"](around:2000,${lat},${lng});
node["shop"~"convenience|variety_store|supermarket"](around:2000,${lat},${lng});
);
out;
`;

try{
const response = await fetch("https://overpass-api.de/api/interpreter",{
method:"POST",
body: query
});

if(!response.ok) throw new Error("Servidor Overpass saturado");

const data = await response.json();

data.elements.forEach(p=>{
const esEstanco = p.tags.shop==="tobacco";
const tipo = esEstanco?"ESTANCO":"TIENDA";
const nombre = p.tags.name||tipo;

const marker = L.marker([p.lat,p.lon],{
icon: esEstanco?iconEstanco:iconTienda
}).addTo(markersLayer);

marker.bindPopup(`
<div style="text-align:center">
<b>${tipo}</b><br>
${nombre}<br><br>
<a href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}" target="_blank">
C√≥mo llegar
</a>
</div>
`);
});

}catch(error){
console.error(error);
alert("Servidor ocupado. Espera unos segundos y vuelve a intentar.");
}
}

// Buscar manual
async function buscarManual(){
const val = document.getElementById('address').value;
if(!val) return;

try{
const response = await fetch(
'https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(val)
);

if(!response.ok) throw new Error("Error Nominatim");

const data = await response.json();

if(data.length){
const lat = parseFloat(data[0].lat);
const lon = parseFloat(data[0].lon);
map.setView([lat,lon],17);
buscarDatos(lat,lon);
}else{
alert("No encontrado");
}
}catch(e){
alert("Error en b√∫squeda");
}
}

// Buscar en centro
function buscarEnCentro(){
const c = map.getCenter();
buscarDatos(c.lat,c.lng);
}

function capturarCentro(){
const c = map.getCenter();
alert(c.lat.toFixed(6)+", "+c.lng.toFixed(6));
}

// Eventos
document.getElementById('searchButton').onclick = buscarManual;
document.getElementById('searchCenterButton').onclick = buscarEnCentro;
document.getElementById('locateButton').onclick = ()=>map.locate({setView:true,zoom:17});
document.getElementById('addButton').onclick = capturarCentro;

</script>
</body>
</html>
