<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VaperTracker - Estancos & Quioscos</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  html, body { height: 100%; margin: 0; font-family: system-ui, sans-serif; background: #f8f9fa; }
  #map { height: 100%; width: 100%; display: none; }

  #overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7); color: white;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 9000; text-align: center; padding: 30px; transition: opacity 0.4s;
  }
  #overlay.hidden { opacity: 0; pointer-events: none; }
  #overlay button {
    margin-top: 20px; padding: 12px 36px; background: #5a7eff; color: white;
    border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer;
    box-shadow: 0 3px 10px #0004;
  }
  #overlay button:active { transform: scale(0.97); }

  #menuButton {
    position: fixed; top: 16px; left: 16px; z-index: 2000;
    background: rgba(255,255,255,0.92); border: none; padding: 12px 14px;
    border-radius: 12px; font-size: 1.5rem; cursor: pointer;
    box-shadow: 0 3px 12px #0003; backdrop-filter: blur(8px);
  }
  #panel {
    position: fixed; inset: 0  auto 0 -320px; width: 300px; height: 100%;
    background: white; z-index: 2100; padding: 24px; box-shadow: 4px 0 20px #0002;
    transition: transform 0.35s ease; transform: translateX(0);
  }
  #panel:not(.active) { transform: translateX(-100%); }

  .search-bar {
    position: absolute; top: 16px; left: 50%; transform: translateX(-50%);
    z-index: 1500; width: 88%; max-width: 480px; background: rgba(255,255,255,0.97);
    border-radius: 50px; box-shadow: 0 5px 18px #0002; display: flex; overflow: hidden;
  }
  .search-bar input {
    flex: 1; border: none; padding: 14px 20px; font-size: 1rem; background: transparent;
  }
  .search-bar button {
    padding: 0 22px; background: #5a7eff; color: white; border: none;
    font-size: 1.3rem; cursor: pointer;
  }

  .btn-floating {
    position: absolute; right: 20px; background: #5a7eff; color: white;
    border: none; border-radius: 50%; width: 58px; height: 58px;
    font-size: 1.6rem; cursor: pointer; box-shadow: 0 5px 15px #0004;
    display: flex; align-items: center; justify-content: center;
  }
  #pinBtn   { bottom: 110px; }
  #searchAreaBtn { bottom: 36px; width: auto; padding: 0 20px; border-radius: 30px; font-size: 0.95rem; font-weight: 600; }

  .popup-content { min-width: 220px; font-size: 0.96rem; padding: 8px; }
  .horario { font-size: 0.84rem; color: #444; margin: 8px 0; }
  .vape-yes { color: #28a745; font-weight: 600; margin: 6px 0; }
</style>
</head>
<body>

<div id="overlay">
  <div id="overlayText">Solicitando ubicaci√≥n...</div>
  <button id="retryBtn" style="display:none">Reintentar</button>
</div>

<button id="menuButton">‚ò∞</button>

<div id="panel">
  <h3>Ajustes</h3>
  <label style="display:block; margin:14px 0;">
    <input type="checkbox" id="onlyOpen"> Solo abiertos ahora
  </label>
  <label style="display:block; margin:14px 0;">
    <input type="checkbox" id="greyClosed" checked> Atenuar cerrados
  </label>
</div>

<div class="search-bar">
  <input id="address" placeholder="Buscar ciudad, calle..." autocomplete="off">
  <button id="searchBtn">üîç</button>
</div>

<button id="pinBtn" class="btn-floating">üìç</button>
<button id="searchAreaBtn" class="btn-floating">BUSCAR AQU√ç</button>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const els = {
    overlay: document.getElementById('overlay'),
    overlayText: document.getElementById('overlayText'),
    retryBtn: document.getElementById('retryBtn'),
    onlyOpen: document.getElementById('onlyOpen'),
    greyClosed: document.getElementById('greyClosed'),
    menuButton: document.getElementById('menuButton'),
    panel: document.getElementById('panel'),
    searchBtn: document.getElementById('searchBtn'),
    address: document.getElementById('address'),
    pinBtn: document.getElementById('pinBtn'),
    searchAreaBtn: document.getElementById('searchAreaBtn'),
    mapDiv: document.getElementById('map')
  };

  let map = null;
  let userLoc = null;
  let markers = null;
  let places = [];
  let isLoading = false;
  let permissionDenied = false;

  // Persistencia
  els.onlyOpen.checked = localStorage.getItem('onlyOpen') === 'true';
  els.greyClosed.checked = localStorage.getItem('greyClosed') !== 'false';

  els.onlyOpen.onchange = () => { localStorage.setItem('onlyOpen', els.onlyOpen.checked); render(); };
  els.greyClosed.onchange = () => { localStorage.setItem('greyClosed', els.greyClosed.checked); render(); };

  els.menuButton.onclick = () => els.panel.classList.toggle('active');
  els.searchBtn.onclick = buscarDireccion;
  els.address.onkeypress = e => { if (e.key === 'Enter') buscarDireccion(); };
  els.pinBtn.onclick = () => userLoc && map?.setView([userLoc.lat, userLoc.lon], 15);
  els.searchAreaBtn.onclick = () => buscarDatos(true);

  els.retryBtn.onclick = () => {
    permissionDenied = false;
    els.retryBtn.style.display = 'none';
    iniciarGeolocalizacion(true);  // true = es reintento
  };

  function showOverlay(msg = 'Cargando...') {
    els.overlayText.textContent = msg;
    els.overlay.classList.remove('hidden');
  }

  function hideOverlay() {
    els.overlay.classList.add('hidden');
  }

  function showError(msg, showRetry = true) {
    els.overlayText.textContent = msg;
    els.retryBtn.style.display = showRetry ? 'block' : 'none';
    els.overlay.classList.remove('hidden');
  }

  function iniciarGeolocalizacion(isRetry = false) {
    if (!navigator.geolocation) {
      showError('Tu navegador no soporta geolocalizaci√≥n', false);
      return;
    }

    showOverlay(isRetry ? 'Reintentando ubicaci√≥n...' : 'Solicitando tu ubicaci√≥n...');

    navigator.geolocation.getCurrentPosition(
      pos => {
        userLoc = { lat: pos.coords.latitude, lon: pos.coords.longitude };
        hideOverlay();
        iniciarMapa();
      },
      err => {
        console.warn('Geolocation error:', err.code, err.message);
        permissionDenied = (err.code === 1); // 1 = permiso denegado

        let msg = 'No se pudo obtener la ubicaci√≥n';
        if (err.code === 1) {
          msg = 'Permiso de ubicaci√≥n denegado.\nAct√≠valo en ajustes del navegador o pulsa Reintentar.';
        } else if (err.code === 3) {
          msg = 'Tiempo de espera agotado.';
        }
        showError(msg, true);
      },
      {
        enableHighAccuracy: true,
        timeout: 12000,
        maximumAge: 0
      }
    );
  }

  function iniciarMapa() {
    els.mapDiv.style.display = 'block';

    map = L.map('map', { zoomControl: false }).setView([userLoc.lat, userLoc.lon], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    markers = L.markerClusterGroup({ maxClusterRadius: 75 }).addTo(map);

    L.circleMarker([userLoc.lat, userLoc.lon], {
      radius: 11, color: 'white', fillColor: '#5a7eff', fillOpacity: 0.9, weight: 3
    }).addTo(map);

    let debounce;
    map.on('moveend zoomend', () => {
      clearTimeout(debounce);
      debounce = setTimeout(() => {
        if (Date.now() - (window.lastSearch||0) > 9000) buscarDatos(false);
      }, 1600);
    });

    buscarDatos(false);
  }

  // ... (las funciones buscarDireccion, buscarDatos, render se mantienen iguales a la versi√≥n anterior)

  async function buscarDireccion() {
    const q = els.address.value.trim();
    if (!q) return;
    showOverlay('Buscando direcci√≥n...');

    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`);
      const data = await res.json();
      if (data?.[0]) {
        const { lat, lon } = data[0];
        const la = parseFloat(lat), lo = parseFloat(lon);
        if (map) map.setView([la, lo], 14);
        else {
          userLoc = { lat: la, lon: lo };
          iniciarMapa();
        }
        setTimeout(() => buscarDatos(true), 800);
      } else {
        showError('No se encontr√≥ la direcci√≥n', true);
        setTimeout(hideOverlay, 2000);
      }
    } catch {
      showError('Error al buscar direcci√≥n', true);
      setTimeout(hideOverlay, 2200);
    }
  }

  async function buscarDatos(withOverlay = false) {
    if (!map || isLoading) return;
    isLoading = true;
    window.lastSearch = Date.now();

    if (withOverlay) showOverlay('Buscando puntos cercanos...');

    try {
      const b = map.getBounds();
      const bbox = `${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}`;

      const query = `[out:json][timeout:12][bbox:${bbox}];
      (
        node["shop"~"tobacco|kiosk|newsagent|vape"](bbox);
        node["amenity"="kiosk"](bbox);
      );
      out center;`;

      const ctrl = new AbortController();
      setTimeout(() => ctrl.abort(), 14000);

      const res = await fetch('https://overpass-api.de/api/interpreter', {
        method: 'POST',
        body: 'data=' + encodeURIComponent(query),
        signal: ctrl.signal,
        headers: {'Content-Type': 'application/x-www-form-urlencoded'}
      });

      if (!res.ok) throw new Error('Overpass fall√≥');

      const data = await res.json();
      places = (data.elements || []).map(el => ({
        lat: el.lat ?? el.center?.lat,
        lon: el.lon ?? el.center?.lon,
        tags: el.tags || {},
        name: el.tags?.name || 'Punto'
      })).filter(p => p.lat && p.lon);

      render();
    } catch (e) {
      console.error(e);
      if (withOverlay || places.length === 0) {
        showError('No se pudieron cargar datos\nIntenta mover el mapa o reintentar', true);
      }
    } finally {
      isLoading = false;
      if (withOverlay) setTimeout(hideOverlay, 900);
    }
  }

  function render() {
    if (!markers) return;
    markers.clearLayers();

    const onlyOpen = els.onlyOpen.checked;
    const grey = els.greyClosed.checked;

    places.forEach(p => {
      const oh = p.tags.opening_hours || '';
      const knownOpen = oh.includes('24/7') || oh.includes('Mo-Su') || oh.includes('open');

      if (onlyOpen && !knownOpen) return;

      let color = '#888';
      if (/tobacco|kiosk|newsagent/.test(p.tags.shop || p.tags.amenity || '')) color = '#6f42c1';

      let opacity = grey && !knownOpen ? 0.48 : 0.9;

      const popup = `
        <div class="popup-content">
          <b>${p.name}</b><br>
          <div class="horario">${oh || 'Horario desconocido'}</div>
          <div class="vape-yes">‚úì Tabaco y vapers probable</div>
        </div>`;

      const m = L.circleMarker([p.lat, p.lon], {
        radius: 8, fillColor: color, color: 'white', weight: 2, fillOpacity: opacity
      }).bindPopup(popup);

      markers.addLayer(m);
    });
  }

  // Inicio real
  iniciarGeolocalizacion(false);
});
</script>
</body>
</html>
