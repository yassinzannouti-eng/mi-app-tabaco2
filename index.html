// 1. Inicializamos el mapa centrado en Málaga (El Palo) por defecto
var map = L.map('map').setView([36.7201, -4.3521], 15);

// 2. Añadimos la capa visual de OpenStreetMap
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(map);

// 3. Icono personalizado para los estancos (Color Rojo)
var estancoIcon = new L.Icon({
  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

// 4. Intentamos localizarte (imprescindible para tu trayecto diario)
map.locate({setView: true, maxZoom: 16});

// 5. FUNCIÓN: Cuando el GPS nos da tu posición
function onLocationFound(e) {
    // Marcador azul para ti
    L.marker(e.latlng).addTo(map)
        .bindPopup("Estás aquí mismo").openPopup();

    // Buscamos estancos en un radio de 5km a tu alrededor
    buscarEstancos(e.latlng.lat, e.latlng.lng);
}

map.on('locationfound', onLocationFound);

// Si el GPS falla o el usuario no da permiso, usamos El Palo por defecto
map.on('locationerror', function() {
    console.warn("GPS no disponible. Buscando en El Palo...");
    buscarEstancos(36.7201, -4.3521); 
});

// 6. FUNCIÓN: Consulta a la base de datos nacional de OpenStreetMap
function buscarEstancos(lat, lng) {
    const radio = 5000; // 5000 metros (5km)
    
    // Consulta "Overpass" para buscar solo tiendas de tabaco (tobacco)
    const query = `[out:json];node["shop"="tobacco"](around:${radio},${lat},${lng});out;`;
    const url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);

    fetch(url)
        .then(response => response.json())
        .then(data => {
            data.elements.forEach(estanco => {
                // Creamos el marcador para cada estanco con el icono rojo
                L.marker([estanco.lat, estanco.lon], {icon: estancoIcon})
                    .addTo(map)
                    .bindPopup(`<b>Estanco</b><br>${estanco.tags.name || "Estanco Oficial"}`);
            });
        })
        .catch(error => console.error("Error al cargar datos:", error));
}
