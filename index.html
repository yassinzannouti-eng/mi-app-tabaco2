<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Buscador de Locales</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { margin:0; font-family:Arial, sans-serif; }
#map { height:60vh; width:100%; }
.controls {
  padding:10px;
  background:#fff;
  position:relative;
  z-index:2;
}
select, button {
  padding:8px;
  margin:5px 0;
  width:100%;
}
#results {
  padding:10px;
  max-height:40vh;
  overflow:auto;
}
.card {
  border-bottom:1px solid #ddd;
  padding:10px 0;
}
.card h3 { margin:5px 0; }
.card p { margin:3px 0; font-size:14px; }
</style>
</head>

<body>

<div class="controls">
  <select id="typeFilter">
    <option value="restaurant">Restaurantes</option>
    <option value="bar">Bares</option>
    <option value="cafe">Cafeterías</option>
    <option value="store">Tiendas</option>
    <option value="supermarket">Supermercados</option>
    <option value="misc">Miscelánea</option>
  </select>

  <button onclick="searchThisArea()">Buscar en esta área</button>
</div>

<div id="map"></div>
<div id="results"></div>

<script>
let map;
let service;
let infowindow;
let markers = [];

function initMap() {

  navigator.geolocation.getCurrentPosition(
    position => {
      const userLocation = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };

      map = new google.maps.Map(document.getElementById("map"), {
        center: userLocation,
        zoom: 15
      });

      service = new google.maps.places.PlacesService(map);
      infowindow = new google.maps.InfoWindow();

      searchPlaces();
    },
    () => {
      alert("No se pudo obtener la ubicación.");
    }
  );
}

function clearMarkers() {
  markers.forEach(marker => marker.setMap(null));
  markers = [];
}

function searchPlaces() {
  clearMarkers();
  document.getElementById("results").innerHTML = "";

  let selectedType = document.getElementById("typeFilter").value;

  let request = {
    bounds: map.getBounds(),
    type: selectedType === "misc" ? [] : [selectedType]
  };

  if (selectedType === "misc") {
    request.keyword = "tienda miscelánea bazar varios";
  }

  service.nearbySearch(request, (results, status) => {
    if (status === google.maps.places.PlacesServiceStatus.OK) {
      results.forEach(place => {
        createMarker(place);
        addResultCard(place);
      });
    }
  });
}

function createMarker(place) {
  const marker = new google.maps.Marker({
    map,
    position: place.geometry.location
  });

  markers.push(marker);

  google.maps.event.addListener(marker, "click", () => {
    infowindow.setContent(`<strong>${place.name}</strong>`);
    infowindow.open(map, marker);
  });
}

function addResultCard(place) {
  const resultsDiv = document.getElementById("results");

  const card = document.createElement("div");
  card.className = "card";

  const mapsUrl = `https://www.google.com/maps/place/?q=place_id:${place.place_id}`;

  service.getDetails(
    {
      placeId: place.place_id,
      fields: ["name", "opening_hours", "formatted_address"]
    },
    (details, status) => {

      let horarioHTML = "Horario no disponible";

      if (status === google.maps.places.PlacesServiceStatus.OK) {
        if (details.opening_hours) {
          if (details.opening_hours.open_now &&
              details.opening_hours.weekday_text &&
              details.opening_hours.weekday_text.length === 7) {

            const es247 = details.opening_hours.weekday_text
              .every(day => day.includes("24 horas"));

            if (es247) {
              horarioHTML = "Abierto 24/7";
            } else {
              horarioHTML = details.opening_hours.weekday_text.join("<br>");
            }

          }
        }
      }

      card.innerHTML = `
        <h3>${place.name}</h3>
        <p>${details?.formatted_address || ""}</p>
        <p><strong>Horario:</strong><br>${horarioHTML}</p>
        <button onclick="window.open('${mapsUrl}','_blank')">
          Ver en Maps
        </button>
      `;

      resultsDiv.appendChild(card);
    }
  );
}

function searchThisArea() {
  searchPlaces();
}

document.getElementById("typeFilter").addEventListener("change", searchPlaces);
</script>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY&libraries=places&callback=initMap">
</script>

</body>
</html>
