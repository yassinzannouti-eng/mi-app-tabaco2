<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VaperTracker - Estancos & Quioscos</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f5f5f7; }
#map { height: 100%; width: 100%; display: none; }

#overlay { 
  position:fixed; top:0; left:0; width:100%; height:100%; 
  background:rgba(0,0,0,0.65); display:flex; flex-direction:column; 
  align-items:center; justify-content:center; z-index:5000; 
  color:white; font-size:1.1rem; text-align:center; padding:30px; 
}
#overlay button { 
  margin-top:20px; padding:12px 32px; background:#667eea; color:white; 
  border:none; border-radius:10px; cursor:pointer; font-weight:600; 
}

#menuButton { 
  position:fixed; top:15px; left:15px; z-index:2000; 
  background:rgba(255,255,255,0.9); border:none; padding:12px; 
  border-radius:14px; box-shadow:0 4px 15px rgba(0,0,0,0.1); 
  cursor:pointer; backdrop-filter:blur(5px); font-size:1.4rem; 
}
#panel { 
  position:fixed; top:0; left:-320px; width:300px; height:100%; 
  background:white; z-index:2100; padding:25px; 
  box-shadow:4px 0 20px rgba(0,0,0,0.1); transition:.35s ease; overflow:auto; 
}
#panel.active { left:0; }

.search-bar { 
  position:absolute; top:15px; left:50%; transform:translateX(-50%); 
  z-index:1500; display:flex; background:rgba(255,255,255,0.95); 
  border-radius:999px; box-shadow:0 8px 24px rgba(0,0,0,0.12); 
  overflow:hidden; width:90%; max-width:420px; backdrop-filter:blur(10px); 
  border:1px solid rgba(0,0,0,0.05); 
}
.search-bar input { flex:1; padding:14px 18px; border:none; outline:none; font-size:16px; background:transparent; }
.search-bar button { padding:14px 22px; border:none; background:#667eea; color:white; cursor:pointer; }

.btn-pin { 
  position:absolute; bottom:100px; right:20px; width:56px; height:56px; 
  background:#667eea; border-radius:50%; color:white; font-size:1.6rem; 
  border:none; cursor:pointer; z-index:1500; box-shadow:0 6px 16px rgba(0,0,0,0.2); 
}
.btn-search-area { 
  position:absolute; bottom:30px; right:20px; background:#667eea; color:white; 
  border:none; padding:0 20px; height:56px; border-radius:999px; cursor:pointer; 
  z-index:1500; font-weight:700; box-shadow:0 6px 20px rgba(102,126,234,0.4); 
}

.popup-container { text-align:center; min-width:240px; padding:8px; }
.btn-maps { 
  display:block; background:#667eea; color:white !important; 
  text-align:center; padding:12px; border-radius:10px; 
  text-decoration:none !important; margin-top:12px; font-weight:600; 
}
.horario-info { font-size:12px; color:#636366; display:block; margin-top:8px; line-height:1.4; border-top:1px solid #f2f2f7; padding-top:8px; }
.vape-info { font-size:13px; font-weight:600; margin-top:6px; color:#34c759; }
.extra-info { font-size:12px; color:#667eea; margin-top:6px; line-height:1.3; }
.source-badge { display:inline-block; padding:3px 8px; border-radius:8px; font-size:10px; font-weight:600; margin-top:6px; background:#f2f2f7; color:#636366; }
</style>
</head>

<body>

<div id="overlay">
  <div id="overlayText">Localizando...</div>
  <button id="retryBtn" style="display:none;">Reintentar</button>
</div>

<button id="menuButton">‚ò∞</button>

<div id="panel">
  <h3 style="font-weight:700; margin-bottom:20px">‚öôÔ∏è Ajustes</h3>
  <label style="cursor:pointer; display:block; margin-bottom:12px">
    <input type="checkbox" id="onlyOpen"> Solo abiertos ahora
  </label>
  <label style="cursor:pointer; display:block; margin-bottom:20px">
    <input type="checkbox" id="greyClosed" checked> Atenuar cerrados
  </label>
  <div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-top:15px;">
    <strong style="font-size:13px">üéØ Estancos y Quioscos</strong>
    <small style="color:#666; font-size:11px; line-height:1.6; display:block; margin-top:8px;">
      B√∫squeda r√°pida de puntos de venta de tabaco y vapers cerca de ti.
    </small>
  </div>
</div>

<div class="search-bar">
  <input type="text" id="address" placeholder="Ciudad, calle o c√≥digo postal">
  <button id="searchBtn">üîç</button>
</div>

<button class="btn-pin" id="pinBtn">üìå</button>
<button class="btn-search-area" id="searchAreaBtn">BUSCAR AQU√ç</button>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const overlay = document.getElementById("overlay");
  const overlayText = document.getElementById("overlayText");
  const retryBtn = document.getElementById("retryBtn");
  const onlyOpen = document.getElementById("onlyOpen");
  const greyClosed = document.getElementById("greyClosed");
  const menuButton = document.getElementById("menuButton");
  const panel = document.getElementById("panel");
  const searchBtn = document.getElementById("searchBtn");
  const addressInput = document.getElementById("address");
  const pinBtn = document.getElementById("pinBtn");
  const searchAreaBtn = document.getElementById("searchAreaBtn");

  let map, userLocation, markersLayer, userMarker, allPlaces = [];
  let lastCenter = null;
  let lastZoom = null;
  let lastSearchTime = 0;
  let isRendering = false;

  // Cargar estado
  onlyOpen.checked = localStorage.getItem('onlyOpen') === 'true';
  greyClosed.checked = localStorage.getItem('greyClosed') !== 'false';

  onlyOpen.onchange = () => { localStorage.setItem('onlyOpen', onlyOpen.checked); render(); };
  greyClosed.onchange = () => { localStorage.setItem('greyClosed', greyClosed.checked); render(); };
  menuButton.onclick = () => panel.classList.toggle('active');
  searchBtn.onclick = buscarDireccion;
  addressInput.onkeypress = e => { if (e.key === 'Enter') buscarDireccion(); };
  pinBtn.onclick = () => userLocation && map?.setView([userLocation.lat, userLocation.lon], 16);
  searchAreaBtn.onclick = () => buscarDatos(true);

  retryBtn.onclick = () => {
    overlay.style.display = 'none';
    iniciarGeolocalizacion();
  };

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // UTILIDADES (mantenidas casi iguales)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function getDefaultName(tags) {
    if (tags.shop === "tobacco") return "Estanco";
    if (tags.shop === "supermarket") return "Supermercado";
    if (tags.amenity === "fuel") return "Gasolinera";
    if (tags.shop === "convenience") return "Tienda de conveniencia";
    if (tags.shop === "vape" || tags.shop === "e-cigarette") return "Tienda de vapers";
    if (tags.amenity === "kiosk" || tags.shop === "kiosk") return "Kiosco";
    if (tags.shop === "newsagent") return "Quiosco de prensa";
    return "Local";
  }

  function vendeVapers(tags) {
    if (!tags) return false;
    return tags.shop === 'vape' || tags.shop === 'e-cigarette' ||
           tags.shop === 'tobacco' ||
           tags.shop === 'supermarket' ||
           tags.shop === 'convenience' ||
           tags.shop === 'kiosk' || tags.shop === 'newsagent' ||
           tags.amenity === 'kiosk' || tags.amenity === 'fuel';
  }

  function distanceBetween(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const œÜ1 = lat1 * Math.PI/180, œÜ2 = lat2 * Math.PI/180;
    const ŒîœÜ = (lat2-lat1) * Math.PI/180;
    const ŒîŒª = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function removeDuplicates(places) {
    const unique = [];
    const threshold = 50;
    places.forEach(p => {
      if (!unique.some(ex => distanceBetween(p.lat, p.lon, ex.lat, ex.lon) < threshold)) {
        unique.push(p);
      }
    });
    return unique;
  }

  function parseOpeningHours(opening_hours) {
    if (!opening_hours) return { isOpen: null, text: "Horario desconocido" };
    if (opening_hours === "24/7") return { isOpen: true, text: "Abierto 24h" };

    const now = new Date();
    const day = now.getDay();
    const hour = now.getHours();
    const minute = now.getMinutes();
    const current = hour * 60 + minute;

    let text = opening_hours
      .replace(/Mo/g,'Lun').replace(/Tu/g,'Mar').replace(/We/g,'Mi√©')
      .replace(/Th/g,'Jue').replace(/Fr/g,'Vie').replace(/Sa/g,'S√°b')
      .replace(/Su/g,'Dom').replace(/;/g, '<br>');

    let isOpen = null;

    // Muy b√°sico: solo detecta algunos patrones comunes
    if (opening_hours.includes('Mo-Fr') && day >= 1 && day <= 5) {
      const m = opening_hours.match(/(\d{2}):(\d{2})-(\d{2}):(\d{2})/);
      if (m) {
        const open = parseInt(m[1])*60 + parseInt(m[2]);
        const close = parseInt(m[3])*60 + parseInt(m[4]);
        isOpen = current >= open && current <= close;
      }
    }

    return { isOpen, text };
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // GEOLOCALIZACI√ìN
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function iniciarGeolocalizacion() {
    overlay.style.display = 'flex';
    overlayText.textContent = 'Obteniendo ubicaci√≥n...';
    retryBtn.style.display = 'none';

    navigator.geolocation.getCurrentPosition(
      pos => {
        iniciarMapa(pos.coords.latitude, pos.coords.longitude);
      },
      err => {
        let msg = "No se pudo obtener la ubicaci√≥n";
        if (err.code === 1) msg = "Permiso denegado\nPulsa Reintentar para volver a preguntar";
        if (err.code === 3) msg = "Tiempo agotado";
        overlayText.textContent = msg;
        retryBtn.style.display = 'block';
      },
      { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 }
    );
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // B√öSQUEDA POR DIRECCI√ìN
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  async function buscarDireccion() {
    const q = addressInput.value.trim();
    if (!q) return;

    overlay.style.display = 'flex';
    overlayText.textContent = 'Buscando...';

    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`);
      const data = await res.json();
      if (data?.length) {
        const lat = parseFloat(data[0].lat);
        const lon = parseFloat(data[0].lon);
        if (map) map.setView([lat, lon], 15);
        else iniciarMapa(lat, lon);
        setTimeout(() => buscarDatos(true), 600);
      } else {
        overlayText.textContent = 'No encontrado';
        setTimeout(() => overlay.style.display = 'none', 1800);
      }
    } catch {
      overlayText.textContent = 'Error al buscar';
      setTimeout(() => overlay.style.display = 'none', 2200);
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // INICIAR MAPA
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function iniciarMapa(lat, lon) {
    userLocation = { lat, lon };
    document.getElementById("map").style.display = "block";

    map = L.map('map', { zoomControl: false }).setView([lat, lon], 15);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    markersLayer = L.markerClusterGroup({
      maxClusterRadius: 70,
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      zoomToBoundsOnClick: true
    }).addTo(map);

    userMarker = L.circleMarker([lat, lon], {
      radius: 9, color: "white", fillColor: "#667eea", fillOpacity: 0.9, weight: 3
    }).addTo(map);

    let timeout;
    map.on('moveend zoomend', () => {
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        if (Date.now() - lastSearchTime < 7000) return;
        const center = map.getCenter();
        if (!lastCenter || center.distanceTo(lastCenter) > 600) {
          lastCenter = center;
          lastSearchTime = Date.now();
          buscarDatos(false);
        }
      }, 1800);
    });

    buscarDatos(false);
  }

  function getVisibleRadius() {
    if (!map) return 4000;
    const b = map.getBounds();
    return Math.min(map.getCenter().distanceTo(b.getNorthEast()) * 1.3, 5000);
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // BUSCAR DATOS OVERPASS (con timeout)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  async function buscarDatos(showOverlay = false) {
    if (!map) return;

    const c = map.getCenter();
    const radio = getVisibleRadius();

    if (showOverlay) {
      overlay.style.display = 'flex';
      overlayText.textContent = 'Buscando puntos cercanos...';
    }

    try {
      const bbox = map.getBounds();
      const query = `[out:json][timeout:12][bbox:${bbox.getSouth().toFixed(5)},${bbox.getWest().toFixed(5)},${bbox.getNorth().toFixed(5)},${bbox.getEast().toFixed(5)}];
(
  node["shop"~"tobacco|kiosk|newsagent|vape|e-cigarette|convenience|supermarket"](bbox);
  way["shop"~"tobacco|kiosk|newsagent|vape|e-cigarette|convenience|supermarket"](bbox);
  node["amenity"~"kiosk|fuel"](bbox);
  way["amenity"~"kiosk|fuel"](bbox);
);
out center;`;

      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), 14000);

      const res = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: "data=" + encodeURIComponent(query),
        signal: controller.signal,
        headers: { "Content-Type": "application/x-www-form-urlencoded" }
      });

      clearTimeout(id);

      if (!res.ok) throw new Error("Overpass error");

      const data = await res.json();
      allPlaces = removeDuplicates(
        (data.elements || []).map(el => ({
          lat: el.lat ?? el.center?.lat,
          lon: el.lon ?? el.center?.lon,
          tags: el.tags || {},
          name: el.tags?.name
        })).filter(p => p.lat && p.lon)
      );

      render();
    } catch (e) {
      console.error(e);
      if (showOverlay || allPlaces.length === 0) {
        overlayText.textContent = 'No se pudieron cargar los datos\nIntenta mover o acercar el mapa';
        retryBtn.style.display = 'block';
      }
    } finally {
      if (showOverlay) setTimeout(() => overlay.style.display = 'none', 800);
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // RENDER (mantenido casi id√©ntico)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function render() {
    if (isRendering || !markersLayer) return;
    isRendering = true;
    markersLayer.clearLayers();

    const showOnlyOpen = onlyOpen.checked;
    const greyOut = greyClosed.checked;

    allPlaces.forEach(p => {
      const horario = parseOpeningHours(p.tags?.opening_hours || "");

      if (showOnlyOpen && horario.isOpen === false) return;

      let color = "#aaaaaa";
      let extra = "";

      if (p.tags?.shop === "tobacco" || p.tags?.shop === "kiosk" || p.tags?.shop === "newsagent" || p.tags?.amenity === "kiosk") {
        color = "#8B4789";
      } else if (p.tags?.shop === "vape" || p.tags?.shop === "e-cigarette") {
        color = "#5856d6";
      } else if (p.tags?.shop === "supermarket") {
        color = "#1e90ff";
      } else if (p.tags?.amenity === "fuel") {
        color = "#c71585";
      } else if (p.tags?.shop === "convenience") {
        color = "#00b7eb";
      }

      let opacity = 0.95;
      let ring = "";

      if (horario.isOpen === true) {
        ring = `<circle cx="20" cy="20" r="14" fill="none" stroke="#34c759" stroke-width="4" opacity="0.9"/>`;
      } else if (horario.isOpen === false && greyOut) {
        opacity = 0.6;
      }

      const nombre = p.name || getDefaultName(p.tags);
      const vende = vendeVapers(p.tags);
      const vapeText = vende ? '<div class="vape-info">‚úì Vende tabaco y vapers</div>' : '';

      let parts = [nombre];
      if (p.tags?.["addr:street"]) parts.push(p.tags["addr:street"]);
      if (p.tags?.["addr:housenumber"]) parts.push(p.tags["addr:housenumber"]);
      if (p.tags?.["addr:city"]) parts.push(p.tags["addr:city"]);

      const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(parts.join(" ") + " " + p.lat + "," + p.lon)}`;

      const popup = `
        <div class="popup-container">
          <strong>${nombre}</strong><br>
          <div class="horario-info">${horario.text}</div>
          ${vapeText}
          ${extra}
          <a href="${mapsUrl}" target="_blank" class="btn-maps">Abrir en Google Maps ‚Üí</a>
          <div class="source-badge">OpenStreetMap</div>
        </div>`;

      const markerHtml = `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
        ${ring}
        <circle cx="20" cy="20" r="11" fill="${color}" opacity="${opacity}"/>
      </svg>`;

      const icon = L.divIcon({
        html: markerHtml,
        className: "",
        iconSize: [40, 40],
        iconAnchor: [20, 20]
      });

      const marker = L.marker([p.lat, p.lon], { icon }).bindPopup(popup);
      markersLayer.addLayer(marker);
    });

    isRendering = false;
  }

  // Inicio
  iniciarGeolocalizacion();

});
</script>
</body>
</html>
